<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KALKULATOR PROJEK MADU KELULUT</title>
  <style>
    :root {
      --gold: #ffca28;
      --amber: #ffd54f;
      --bg: #0b0b0b;
      --panel: #131313;
      --text: #f4f4f4;
      --muted: #c0c0c0;
      --danger: #ff5252;
      --success: #8bc34a;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top left, #3d2b1f 0, #0b0b0b 45%, #000000 100%);
      color: var(--text);
    }
    h1 {
      text-align: center;
      color: var(--amber);
      margin-bottom: 4px;
      letter-spacing: 1px;
    }
    h2 {
      text-align: center;
      color: var(--gold);
      margin-top: 0;
      font-weight: normal;
    }
    .container {
      max-width: 950px;
      margin: auto;
      background: linear-gradient(135deg, #111111 0%, #181818 60%, #121212 100%);
      padding: 16px 18px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.8);
      border: 1px solid rgba(255, 215, 128, 0.6);
    }
    .section-title {
      margin-top: 15px;
      font-weight: bold;
      color: var(--gold);
      border-bottom: 2px solid rgba(255, 213, 79, 0.4);
      padding-bottom: 2px;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.5px;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 14px;
      color: #f1f1f1;
    }
    input, select {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #1e1e1e;
      color: #f4f4f4;
    }
    input::placeholder { color: #888; }
    button {
      margin-top: 8px;
      padding: 10px;
      font-size: 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-primary {
      background: linear-gradient(90deg, #ffca28, #ffa000);
      color: #222;
      font-weight: bold;
      width: 100%;
    }
    .btn-secondary {
      background: transparent;
      color: var(--gold);
      border: 1px solid var(--gold);
    }
    .btn-ghost {
      background: #1c1c1c;
      color: var(--text);
      border: 1px solid #333;
    }
    .btn-inline { width: auto; display: inline-block; margin-right: 8px; }
    .note { font-size: 11px; color: #c0c0c0; margin-top: 6px; }
    .hint { color: #ffecb3; font-size: 11px; display: block; margin-top: 2px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #444;
      padding: 4px;
      text-align: right;
    }
    th { background: #2b2418; color: #ffecb3; }
    td { background: #171717; color: #f1f1f1; }
    canvas { margin-top: 10px; background: #111; border-radius: 4px; border: 1px solid #333; }
    .result-box {
      background: rgba(33,33,33,0.9);
      border-left: 4px solid var(--gold);
      padding: 8px 10px;
      margin-top: 12px;
      border-radius: 4px;
    }
    .conclusion-box {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 4px;
      border-left: 4px solid #999;
      font-size: 13px;
      background: #191919;
    }
    .conclusion-good { background: linear-gradient(90deg, #1b5e20, #2e7d32); border-left-color: #00e676; box-shadow: 0 0 12px rgba(0,230,118,0.6); }
    .conclusion-moderate { background: linear-gradient(90deg, #ff6f00, #ff8f00); border-left-color: #ffd600; box-shadow: 0 0 12px rgba(255,214,0,0.6); color: #1a1a1a; }
    .conclusion-bad { background: linear-gradient(90deg, #b71c1c, #d32f2f); border-left-color: #ff5252; box-shadow: 0 0 12px rgba(255,82,82,0.6); }
    .conclusion-title { font-weight: bold; font-size: 18px; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; color: #fff; }
    .step-card { background: #101010; border: 1px solid #2b2418; border-radius: 8px; padding: 10px 12px; margin-top: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.35); }
    .pill { padding: 4px 8px; border-radius: 12px; background: #1f1f1f; border: 1px solid #333; display: inline-block; margin-right: 6px; }
    .mode-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .inline { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .inline input[type="radio"] { width: auto; }
    .section-map { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; justify-content: center; background: #0f0f0f; border: 1px solid #2b2418; padding: 6px 8px; border-radius: 8px; font-size: 12px; }
    .section-map a { color: var(--amber); text-decoration: none; padding: 2px 6px; border-radius: 999px; border: 1px solid #333; background: #1a1a1a; }
    .section-map a:hover { background: #222; }
    .map-sep { color: #777; }
    details { background: #121212; border: 1px solid #222; border-radius: 6px; padding: 6px 8px; margin-top: 8px; }
    summary { cursor: pointer; color: var(--gold); font-weight: bold; }
    .error-text { color: var(--danger); font-size: 11px; min-height: 14px; }
    .invalid { border-color: var(--danger); box-shadow: 0 0 0 1px rgba(255,82,82,0.4); }
    .error-summary { background: rgba(183,28,28,0.15); color: #ffcdd2; border: 1px solid rgba(255,82,82,0.6); padding: 8px; border-radius: 6px; margin-top: 10px; display: none; }
    .three-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 10px; margin-top: 10px; }
    .mini-card { background: #161616; border: 1px solid #333; border-left: 4px solid var(--gold); padding: 8px; border-radius: 6px; }
    .mini-card h4 { margin: 0 0 4px 0; color: var(--amber); }
    .badge { background: #1e1e1e; color: var(--text); border: 1px solid #333; padding: 2px 6px; border-radius: 10px; font-size: 11px; }
    .meta { font-size: 11px; color: var(--muted); text-align: right; }
    @media (max-width: 600px) { button { width: 100%; } .inline { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>
<div class="container" id="reportArea">
  <h1>KALKULATOR PROJEK MADU KELULUT</h1>
  <h2>Analisis Kewangan</h2>
  <div class="meta" id="reportMeta">Versi kalkulator: v2.1</div>

  <p class="note">
    Hai semua! Kalkulator ini membantu penternak menilai sama ada projek madu kelulut berbaloi atau tidak dari sudut kewangan.
  </p>
  <p class="note">
    <strong>Arahan:</strong> Ikuti <strong>Langkah 1 hingga 3</strong>. Pilih <strong>Mod Ringkas</strong> jika mahu isi bilangan koloni terus atau <strong>Mod Terperinci</strong> jika mahu berdasarkan keluasan & kepadatan. Tekan <strong>"Kira Analisis"</strong> untuk lihat NPV, IRR, BCR, ROI, graf dan PDF.
  </p>

  <!-- Maklumat Penternak -->
  <div class="section-title" id="sectionA">A. Maklumat Ladang</div>
  <label>Nama penternak:
    <input id="farmerName" type="text" placeholder="Contoh: Assis Kamu">
  </label>
  <label>Nama kampung / lokasi:
    <input id="villageName" type="text" placeholder="Contoh: Kg. Kiau Nuluh, Kota Belud">
  </label>
  <label>No. telefon:
    <input id="phoneNumber" type="text" placeholder="Contoh: 012-3456789">
  </label>

  <div class="section-title">Peta Ringkas Bahagian</div>
  <nav class="section-map" aria-label="Peta Ringkas Bahagian">
    <a href="#sectionA">A Ladang</a><span class="map-sep">|</span>
    <a href="#sectionB">B Hasil</a><span class="map-sep">|</span>
    <a href="#sectionB2">B2 Risiko</a><span class="map-sep">|</span>
    <a href="#sectionC">C Kos Mula</a><span class="map-sep">|</span>
    <a href="#sectionD">D Input</a><span class="map-sep">|</span>
    <a href="#sectionE">E Upah</a><span class="map-sep">|</span>
    <a href="#sectionF">F Pelbagai</a><span class="map-sep">|</span>
    <a href="#sectionG">G Tetapan</a><span class="map-sep">|</span>
    <a href="#sectionH">H Graf</a>
  </nav>

  <!-- LANGKAH 1 -->
  <div class="section-title">Langkah 1: Saiz ternakan & hasil (B & B2)</div>
  <div class="step-card">
    <div class="mode-row">
      <label class="pill"><input type="radio" name="mode" value="simple" id="modeSimple"> Mod Ringkas (Kampung)</label>
      <label class="pill"><input type="radio" name="mode" value="detailed" id="modeDetailed" checked> Mod Terperinci (Profesional)</label>
    </div>
    <div id="simpleMode" style="display:none;">
      <label>Bilangan koloni (isi terus):
        <input id="coloniesDirect" type="number" min="0" step="1" value="30">
      </label>
      <div class="error-text" id="err-coloniesDirect"></div>
    </div>
    <div id="detailedMode">
      <label>Keluasan (ekar):
        <input id="areaAcre" type="number" min="0" step="0.1" value="1">
      </label>
      <div class="error-text" id="err-areaAcre"></div>
      <label>Kepadatan koloni (koloni/ekar):
        <input id="density" type="number" min="0" step="1" value="30">
      </label>
      <div class="error-text" id="err-density"></div>
      <div class="note" id="colonyEstimate">Anggaran bilangan koloni: 30</div>
    </div>

    <label>Hasil madu per koloni setahun (kg/koloni/tahun):
      <input id="yieldPerColony" type="number" min="0" step="0.1" value="2.5">
      <small class="hint">Contoh anggaran: 1.5 ‚Äì 3.5 kg/koloni/tahun bergantung penjagaan & cuaca.</small>
    </label>
    <div class="error-text" id="err-yieldPerColony"></div>

    <div class="inline" style="margin-top:4px;">
      <label class="pill"><input type="checkbox" id="enableYear1LowerYield"> Tahun 1 hasil lebih rendah</label>
      <div style="max-width:180px;">
        <label>Faktor hasil Tahun 1 (%):
          <input id="year1YieldFactor" type="number" min="0" max="100" step="5" value="70">
        </label>
      </div>
    </div>

    <div class="section-title" id="sectionB">B. Hasil Produk</div>
    <label>Harga jual madu kelulut (RM/kg):
      <input id="price" type="number" min="0" step="1" value="200">
    </label>
    <div class="error-text" id="err-price"></div>
    <label>Hasil propolis (titis) per koloni setahun (RM/koloni/tahun):
      <input id="propIncomePerCol" type="number" min="0" step="1" value="30">
    </label>
    <label>Hasil sabun madu kelulut per koloni setahun (RM/koloni/tahun):
      <input id="soapIncomePerCol" type="number" min="0" step="1" value="20">
    </label>
    <label>Nama lain-lain produk (pilihan):
      <input id="otherProductName" type="text" placeholder="Contoh: Bee bread / minuman kesihatan madu kelulut">
    </label>
    <label>Hasil lain-lain produk per koloni setahun (RM/koloni/tahun):
      <input id="otherIncomePerCol" type="number" min="0" step="1" value="0">
    </label>

    <div class="section-title" id="sectionB2">B2. Risiko Penternakan (Mortaliti)</div>
    <label>Kadar koloni mati/rosak setahun (%):
      <input id="mortalityRatePercent" type="number" min="0" max="100" step="0.5" value="0">
    </label>
    <label>Kos ganti koloni (RM/koloni mati):
      <input id="replacementColonyCost" type="number" min="0" step="50" value="1000">
    </label>

    <details>
      <summary>Pelan tambah koloni (pilihan)</summary>
      <div class="inline">
        <label class="pill"><input type="checkbox" id="enableExpansion"> Tambah koloni setiap tahun</label>
        <label class="pill"><input type="radio" name="expansionMode" value="increment" checked> +N koloni/tahun</label>
        <label class="pill"><input type="radio" name="expansionMode" value="percent"> +X% koloni/tahun</label>
      </div>
      <label>Tambah tetap (+N koloni/tahun):
        <input id="expansionIncrement" type="number" min="0" step="1" value="0">
      </label>
      <label>Tambah peratus (+X%/tahun):
        <input id="expansionPercent" type="number" min="0" step="1" value="0">
      </label>
      <p class="note">Kos tambah koloni akan dikira menggunakan kos pembinaan koloni sedia ada (RM/koloni).</p>
    </details>
  </div>

  <!-- LANGKAH 2 -->
  <div class="section-title">Langkah 2: Kos (C ‚Äì F + kos tambahan)</div>
  <div class="step-card">
    <details open>
      <summary id="sectionC">C. Kos Pembangunan (Tahun 0)</summary>
      <label>Pembersihan kawasan (RM/ekar, sekali ‚Äì tahun 0):
        <input id="clearCostPerAcre" type="number" min="0" step="50" value="1000">
      </label>
      <label>Pembinaan pagar (RM/ekar, sekali ‚Äì tahun 0):
        <input id="fenceCostPerAcre" type="number" min="0" step="50" value="1000">
      </label>
      <label>Pembinaan koloni kelulut (kotak + topping) (RM/koloni, tahun 0):
        <input id="colonySetupCostPerColony" type="number" min="0" step="50" value="1000">
      </label>
      <label>Bilangan alat penyedut madu bermotor (unit ‚Äì tahun 0):
        <input id="numExtractors" type="number" min="0" step="1" value="1">
      </label>
      <label>Kos satu alat penyedut madu bermotor (RM/unit):
        <input id="extractorUnitCost" type="number" min="0" step="10" value="200">
      </label>
      <label>Bilangan bekas simpanan madu (5kg):
        <input id="numContainers" type="number" min="0" step="1" value="1">
      </label>
      <label>Kos satu bekas simpanan madu 5kg (RM/unit):
        <input id="containerUnitCost" type="number" min="0" step="5" value="50">
      </label>
    </details>

    <details open>
      <summary id="sectionD">D. Kos Bahan Input</summary>
      <label>Kos kawalan serangga (RM/setahun):
        <input id="insectControlAnnual" type="number" min="0" step="10" value="100">
      </label>
    </details>

    <details open>
      <summary id="sectionF">F. Kos Pelbagai (Penyelenggaraan & Utiliti)</summary>
      <label>Penyelenggaraan pagar (RM/ekar setiap 3 tahun):
        <input id="fenceMaintPerAcre" type="number" min="0" step="10" value="300">
      </label>
      <label>Penyelenggaraan / alat ganti alat penyedut madu bermotor (RM/setahun):
        <input id="extractorMaintAnnual" type="number" min="0" step="10" value="50">
      </label>
      <label>Penggantian kotak koloni + kotak topping (RM/koloni setiap 2 tahun):
        <input id="colonyReplacementCostPerColony" type="number" min="0" step="10" value="50">
      </label>
      <label>Sewa tanah (RM/ekar setahun ‚Äì kos utiliti):
        <input id="landRentPerAcreAnnual" type="number" min="0" step="10" value="500">
      </label>
    </details>

    <details open>
      <summary id="sectionE">E. Kos Tenaga Kerja</summary>
      <label>Kos tenaga kerja (RM/setahun):
        <input id="labourCostAnnual" type="number" min="0" step="50" value="6000">
      </label>
    </details>

    <details>
      <summary>Kos tambahan pilihan (boleh tanda jika berkaitan)</summary>
      <label class="inline"><input type="checkbox" id="enablePackaging"> Aktifkan kos botol & label</label>
      <div id="packagingFields" style="display:none;">
        <label>Saiz botol (ml):
          <input id="bottleSizeMl" type="number" min="1" step="10" value="250">
        </label>
        <label>Kos botol (RM/botol):
          <input id="bottleCost" type="number" min="0" step="0.1" value="1.5">
        </label>
        <label>Kos label (RM/botol):
          <input id="labelCost" type="number" min="0" step="0.1" value="0.5">
        </label>
        <label>Kos pembungkusan tambahan (RM/botol):
          <input id="packagingCost" type="number" min="0" step="0.1" value="0.3">
        </label>
      </div>

      <label class="inline"><input type="checkbox" id="enableTransport"> Aktifkan kos pengangkutan/pos</label>
      <div id="transportFields" style="display:none;">
        <div class="inline">
          <label class="pill"><input type="radio" name="transportMode" value="perKg" checked> Berdasarkan kg madu</label>
          <label class="pill"><input type="radio" name="transportMode" value="annual"> Jumlah setahun</label>
        </div>
        <label>Jika per kg: kos pengangkutan (RM/kg madu):
          <input id="transportCostPerKg" type="number" min="0" step="0.1" value="0">
        </label>
        <label>Jika jumlah setahun: kos pengangkutan (RM/tahun):
          <input id="transportCostAnnual" type="number" min="0" step="10" value="0">
        </label>
      </div>

      <label class="inline"><input type="checkbox" id="enableFeeding"> Aktifkan kos feeding / makanan tambahan</label>
      <div id="feedingFields" style="display:none;">
        <label>Kos feeding (RM/setahun):
          <input id="feedingCostAnnual" type="number" min="0" step="10" value="0">
        </label>
      </div>

      <label class="inline"><input type="checkbox" id="enableCompliance"> Aktifkan kos pensijilan/ujian/lesen</label>
      <div id="complianceFields" style="display:none;">
        <label>Kos pensijilan/ujian/lesen (RM/setahun):
          <input id="complianceCostAnnual" type="number" min="0" step="10" value="0">
        </label>
      </div>
    </details>
  </div>

  <details open>
    <summary>Preview cepat (anggaran Tahun 1)</summary>
    <div class="three-cards">
      <div class="mini-card"><h4>Anggaran madu Tahun 1</h4><div class="badge" id="previewHoney">-</div><small class="note">Termasuk faktor hasil Tahun 1 & mortaliti Tahun 1.</small></div>
      <div class="mini-card"><h4>Anggaran botol (jika pembungkusan)</h4><div class="badge" id="previewBottles">-</div><small class="note">Berdasarkan saiz botol & hasil madu Tahun 1.</small></div>
      <div class="mini-card"><h4>Kos tahunan Tahun 1 (RM)</h4><div class="badge" id="previewCost">-</div><small class="note">Kos asas + opsyen + kontinjensi.</small></div>
    </div>
  </details>

  <!-- LANGKAH 3 -->
  <div class="section-title" id="sectionG">Langkah 3: G. Parameter Analisis & Tindakan</div>
  <div class="step-card">
    <label>Kadar Diskaun (% setahun):
      <input id="discountRate" type="number" min="0" step="0.1" value="3">
      <small class="hint">Jika tidak pasti, boleh guna 3% ‚Äì 8% bergantung kos modal.</small>
    </label>
    <div class="error-text" id="err-discountRate"></div>
    <label>Tempoh Analisis (tahun ekonomi projek):
      <input id="duration" type="number" min="1" step="1" value="7">
    </label>
    <div class="error-text" id="err-duration"></div>

    <label>Kontinjensi (% atas kos tahunan):
      <input id="contingencyPercent" type="number" min="0" max="100" step="0.5" value="10">
    </label>

    <label>Kenaikan kos tahunan (inflasi kos) %:
      <input id="costEscalationPercent" type="number" min="0" step="0.1" value="0">
    </label>
    <label>Kenaikan harga madu tahunan (inflasi harga) %:
      <input id="priceEscalationPercent" type="number" min="0" step="0.1" value="0">
    </label>

    <div id="errorSummary" class="error-summary">Sila betulkan medan yang merah.</div>

    <div class="inline" style="margin-top:8px; gap:8px; flex-wrap: wrap;">
      <button class="btn-primary btn-inline" id="btnRun">Kira Analisis</button>
      <button class="btn-secondary btn-inline" id="btnReset">Reset / Kosongkan</button>
      <button class="btn-ghost btn-inline" id="btnDemo">Isi Contoh (Demo)</button>
      <button class="btn-ghost btn-inline" id="btnSave">Simpan</button>
      <button class="btn-secondary btn-inline" id="btnClearSave">Padam Simpanan</button>
    </div>
    <div class="note" id="statusMessage"></div>
    <p class="note">Auto-simpan akan berlaku secara tertunda (beberapa saat) setiap kali anda ubah nilai. Simpanan disimpan di pelayar (localStorage).</p>
  </div>

  <div id="results" class="summary"></div>

  <!-- H. Graf Visual -->
  <div class="section-title" id="sectionH">H. Graf Visual</div>
  <p class="note">Graf membantu melihat aliran tunai, bila projek pulang modal dan kesan perubahan harga madu.</p>
  <canvas id="cfChart" height="180"></canvas>
  <canvas id="cumCfChart" height="180"></canvas>
  <canvas id="npvSensChart" height="180"></canvas>
  <canvas id="tornadoChart" height="200"></canvas>

  <div style="margin-top:16px;" class="inline">
    <button class="btn-secondary" onclick="downloadPDF()">üìÑ Muat Turun PDF (Ringkas ‚Äì Screenshot)</button>
    <button class="btn-secondary" onclick="downloadProfessionalPDF()">üìë Muat Turun PDF (Profesional)</button>
    <button class="btn-ghost" onclick="downloadCashflowCSV()">‚¨áÔ∏è Muat Turun CSV ‚Äì Aliran Tunai</button>
    <button class="btn-ghost" onclick="downloadSensitivityCSV()">‚¨áÔ∏è Muat Turun CSV ‚Äì Sensitiviti</button>
  </div>

  <div class="disclaimer">
    <p class="note" style="font-size:10px; color:#bbbbbb; line-height:1.4;">
      <strong>Penafian (Disclaimer) ‚Äì Bahasa Melayu:</strong><br>
      Kalkulator ini disediakan untuk tujuan pembelajaran dan anggaran kasar sahaja.
      Nilai kos, hasil dan pulangan sebenar mungkin berbeza mengikut lokasi, keadaan ternakan,
      kemahiran pengurusan, harga pasaran serta faktor-faktor lain di luar kawalan pengeluar.
      Pengguna dinasihatkan mendapatkan nasihat lanjut daripada pegawai atau pakar berkaitan
      sebelum membuat keputusan pelaburan. Penyedia kalkulator tidak bertanggungjawab
      terhadap sebarang kerugian, kerosakan atau tuntutan yang timbul daripada penggunaan
      kalkulator ini.
    </p>

    <p class="note" style="font-size:10px; color:#bbbbbb; line-height:1.4;">
      <strong>Disclaimer ‚Äì English Version:</strong><br>
      This calculator is intended for educational use and approximate estimation only.
      Actual costs, yields, and financial returns may vary depending on location, farm conditions,
      management practices, market prices, and external factors. Users are advised
      to consult relevant officers or experts before making financial or investment decisions.
      The creator of this calculator shall not be held responsible for any loss, damage,
      or claims arising from its use.
    </p>

    <p class="note" style="font-size:10px; color:#999999; text-align:center;">
      &copy; 2025 Assis Kamu, Universiti Malaysia Sabah. All Rights Reserved.
    </p>
  </div>
</div>

<!-- PDF libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let cfChartInstance = null;
  let cumCfChartInstance = null;
  let npvSensChartInstance = null;
  let tornadoChartInstance = null;

  const storageKey = "kelulutCalc_v2_state";
  const currencyFmt = new Intl.NumberFormat('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  function fmtNumber(x, decimals = 2) {
    if (x === null || x === undefined || isNaN(x)) return "-";
    const formatter = new Intl.NumberFormat('ms-MY', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    return formatter.format(Number(x));
  }
  function coloredFmt(x, decimals = 2) {
    if (x === null || isNaN(x)) return "-";
    const formatted = fmtNumber(x, decimals);
    const color = x < 0 ? '#ff5252' : '#f1f1f1';
    return `<span style="color:${color};">${formatted}</span>`;
  }
  function clamp(value, min, max) { return Math.min(Math.max(value, min), max); }

  const defaultState = {
    mode: "detailed",
    farmerName: "",
    villageName: "",
    phoneNumber: "",
    coloniesDirect: 30,
    areaAcre: 1,
    density: 30,
    yieldPerColony: 2.5,
    price: 200,
    propIncomePerCol: 30,
    soapIncomePerCol: 20,
    otherProductName: "",
    otherIncomePerCol: 0,
    clearCostPerAcre: 1000,
    fenceCostPerAcre: 1000,
    colonySetupCostPerColony: 1000,
    numExtractors: 1,
    extractorUnitCost: 200,
    numContainers: 1,
    containerUnitCost: 50,
    insectControlAnnual: 100,
    labourCostAnnual: 6000,
    fenceMaintPerAcre: 300,
    extractorMaintAnnual: 50,
    colonyReplacementCostPerColony: 50,
    landRentPerAcreAnnual: 500,
    discountRate: 3,
    duration: 7,
    mortalityRatePercent: 0,
    replacementColonyCost: 1000,
    costEscalationPercent: 0,
    priceEscalationPercent: 0,
    enablePackaging: false,
    bottleSizeMl: 250,
    bottleCost: 1.5,
    labelCost: 0.5,
    packagingCost: 0.3,
    enableTransport: false,
    transportMode: "perKg",
    transportCostPerKg: 0,
    transportCostAnnual: 0,
    enableFeeding: false,
    feedingCostAnnual: 0,
    enableCompliance: false,
    complianceCostAnnual: 0,
    enableYear1LowerYield: false,
    year1YieldFactor: 70,
    contingencyPercent: 10,
    enableExpansion: false,
    expansionMode: "increment",
    expansionIncrement: 0,
    expansionPercent: 0
  };

  function npv(rate, cashflows) {
    return cashflows.reduce((acc, cf, t) => acc + cf / Math.pow(1 + rate, t), 0);
  }

  function irr(cashflows, guess = 0.1) {
    let rate = guess;
    for (let i = 0; i < 100; i++) {
      let npvVal = 0;
      let dNpv = 0;
      for (let t = 0; t < cashflows.length; t++) {
        const denom = Math.pow(1 + rate, t);
        npvVal += cashflows[t] / denom;
        if (t > 0) dNpv -= t * cashflows[t] / (denom * (1 + rate));
      }
      if (!isFinite(npvVal) || !isFinite(dNpv) || Math.abs(dNpv) < 1e-10) break;
      const newRate = rate - npvVal / dNpv;
      if (!isFinite(newRate)) break;
      if (Math.abs(newRate - rate) < 1e-7) return newRate;
      rate = newRate;
    }
    return rate;
  }

  function safeIRR(cashflows) {
    const hasPos = cashflows.some(v => v > 0);
    const hasNeg = cashflows.some(v => v < 0);
    if (!hasPos || !hasNeg) return null;
    const rate = irr(cashflows);
    if (!isFinite(rate) || rate < -0.99 || rate > 5) return null;
    return rate * 100;
  }

  function coloniesPlanAtYear(params, t) {
    const base = params.colonies;
    if (t <= 1 || !params.enableExpansion) return Math.max(0, base);
    if (params.expansionMode === 'percent') {
      return Math.max(0, Math.round(base * Math.pow(1 + params.expansionPercent, t - 1)));
    }
    return Math.max(0, base + (t - 1) * params.expansionIncrement);
  }

  function computeScenario(params) {
    const {
      T,
      colonies,
      honeyYieldPerColony,
      baseHoneyPrice,
      propIncomePerColony,
      soapIncomePerColony,
      otherIncomePerColony,
      devCost0,
      baseInputAnnual,
      baseLabourAnnual,
      baseMiscAnnual,
      bottleSizeMl,
      bottleCost,
      labelCost,
      packagingCost,
      enablePackaging,
      enableTransport,
      transportMode,
      transportCostPerKg,
      transportCostAnnual,
      enableFeeding,
      feedingCostAnnual,
      enableCompliance,
      complianceCostAnnual,
      mortalityRate,
      replacementColonyCost,
      costEscalation,
      priceEscalation,
      discountRate,
      priceFactor,
      contingencyRate,
      enableYear1LowerYield,
      year1YieldFactor,
      enableExpansion,
      expansionMode,
      expansionIncrement,
      expansionPercent,
      colonySetupCostPerColony
    } = params;

    let cashflows = [];
    let benefits = [];
    let totalCosts = [];
    let effectiveColoniesSeries = [];
    let pvBenefits = 0;
    let pvCosts = 0;
    let cumCF = 0;
    let paybackYear = null;

    for (let t = 0; t <= T; t++) {
      const yearFactor = t > 0 ? Math.pow(1 + costEscalation, t - 1) : 1;
      const price = t > 0 ? baseHoneyPrice * priceFactor * Math.pow(1 + priceEscalation, t - 1) : baseHoneyPrice * priceFactor;
      const plannedColonies = coloniesPlanAtYear({ colonies, enableExpansion, expansionMode, expansionIncrement, expansionPercent }, t);
      const effectiveColonies = t === 0 ? colonies : Math.max(0, plannedColonies * Math.pow(1 - mortalityRate, Math.max(0, t - 1)));
      effectiveColoniesSeries.push(effectiveColonies);

      let benefit = 0;
      if (t > 0) {
        const yieldFactor = enableYear1LowerYield && t === 1 ? year1YieldFactor : 1;
        const honeyKg = effectiveColonies * honeyYieldPerColony * yieldFactor;
        const honeyRev = honeyKg * price;
        const propRev  = effectiveColonies * propIncomePerColony * yieldFactor;
        const soapRev  = effectiveColonies * soapIncomePerColony * yieldFactor;
        const otherRev = effectiveColonies * otherIncomePerColony * yieldFactor;
        benefit = honeyRev + propRev + soapRev + otherRev;
      }

      let directCost = 0;
      if (t === 0) {
        directCost = devCost0;
      } else {
        const yieldFactor = enableYear1LowerYield && t === 1 ? year1YieldFactor : 1;
        const honeyKg = effectiveColonies * honeyYieldPerColony * yieldFactor;
        let packagingAnnual = 0;
        if (enablePackaging && honeyKg > 0) {
          const bottles = Math.ceil((honeyKg * 1000) / bottleSizeMl);
          packagingAnnual = bottles * (bottleCost + labelCost + packagingCost);
        }

        let transportAnnual = 0;
        if (enableTransport) {
          transportAnnual = transportMode === "perKg" ? honeyKg * transportCostPerKg : transportCostAnnual;
        }

        const feedingAnnual = enableFeeding ? feedingCostAnnual : 0;
        const complianceAnnual = enableCompliance ? complianceCostAnnual : 0;
        const mortalityReplacement = effectiveColonies * mortalityRate * replacementColonyCost;

        let costNewColonies = 0;
        if (t > 1 && enableExpansion) {
          const prevPlan = coloniesPlanAtYear({ colonies, enableExpansion, expansionMode, expansionIncrement, expansionPercent }, t - 1);
          const delta = Math.max(0, plannedColonies - prevPlan);
          costNewColonies = delta * colonySetupCostPerColony;
        }

        const annualBase = baseInputAnnual + baseLabourAnnual + baseMiscAnnual;
        const annualOption = packagingAnnual + transportAnnual + feedingAnnual + complianceAnnual + mortalityReplacement + costNewColonies;
        directCost = (annualBase + annualOption) * yearFactor;
      }

      const contingency = directCost * contingencyRate;
      const totalCost = directCost + contingency;
      const cf = benefit - totalCost;

      cashflows.push(cf);
      benefits.push(benefit);
      totalCosts.push(totalCost);

      cumCF += cf;
      if (paybackYear === null && cumCF >= 0 && t > 0) paybackYear = t;

      const df = Math.pow(1 + discountRate, t);
      pvBenefits += benefit / df;
      pvCosts += totalCost / df;
    }

    const npvVal = npv(discountRate, cashflows);
    const irrVal = safeIRR(cashflows);
    const bcrVal = pvCosts > 0 ? pvBenefits / pvCosts : null;

    return {
      priceFactor,
      cashflows,
      benefits,
      totalCosts,
      npv: npvVal,
      irr: irrVal,
      bcr: bcrVal,
      paybackYear,
      effectiveColoniesSeries
    };
  }

  function computeBreakEvenHoneyPrice(params) {
    const { baseHoneyPrice } = params;
    let low = 0;
    let high = baseHoneyPrice * 5 + 200;

    const evalPrice = (price) => {
      const scenario = computeScenario({ ...params, baseHoneyPrice: price, priceFactor: 1 });
      return scenario.npv;
    };

    let lowNpv = evalPrice(low);
    let highNpv = evalPrice(high);

    if (lowNpv === null || highNpv === null) return null;
    if (lowNpv > 0) return 0;
    if (highNpv < 0) return null;

    for (let i = 0; i < 40; i++) {
      const mid = (low + high) / 2;
      const midNpv = evalPrice(mid);
      if (Math.abs(midNpv) < 1e-2) return mid;
      if (midNpv > 0) {
        high = mid;
        highNpv = midNpv;
      } else {
        low = mid;
        lowNpv = midNpv;
      }
    }
    return (low + high) / 2;
  }

  function setValue(id, val) {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.type === 'checkbox') {
      el.checked = Boolean(val);
    } else if (el.type === 'radio') {
      const opt = document.querySelector(`input[name="${el.name}"][value="${val}"]`);
      if (opt) opt.checked = true;
    } else {
      el.value = val;
    }
  }

  function toggleModeUI() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    document.getElementById('simpleMode').style.display = mode === 'simple' ? 'block' : 'none';
    document.getElementById('detailedMode').style.display = mode === 'detailed' ? 'block' : 'none';
    updateColonyEstimate();
  }

  function toggleOptionalSections() {
    document.getElementById('packagingFields').style.display = document.getElementById('enablePackaging').checked ? 'block' : 'none';
    document.getElementById('transportFields').style.display = document.getElementById('enableTransport').checked ? 'block' : 'none';
    document.getElementById('feedingFields').style.display = document.getElementById('enableFeeding').checked ? 'block' : 'none';
    document.getElementById('complianceFields').style.display = document.getElementById('enableCompliance').checked ? 'block' : 'none';
    const transportMode = document.querySelector('input[name="transportMode"]:checked').value;
    document.getElementById('transportCostPerKg').parentElement.style.display = transportMode === 'perKg' ? 'block' : 'none';
    document.getElementById('transportCostAnnual').parentElement.style.display = transportMode === 'annual' ? 'block' : 'none';
  }

  function updateColonyEstimate() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    if (mode === 'detailed') {
      const area = parseFloat(document.getElementById('areaAcre').value) || 0;
      const density = parseFloat(document.getElementById('density').value) || 0;
      const colonies = Math.max(0, Math.round(area * density));
      document.getElementById('colonyEstimate').textContent = `Anggaran bilangan koloni: ${fmtNumber(colonies,0)}`;
    } else {
      document.getElementById('colonyEstimate').textContent = '';
    }
  }

  function setError(id, message) {
    const err = document.getElementById(`err-${id}`);
    const input = document.getElementById(id);
    if (err) err.textContent = message || '';
    if (input) input.classList.toggle('invalid', Boolean(message));
  }

  function validateInputs() {
    let valid = true;
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const required = [
      { id: 'yieldPerColony', min: 0 },
      { id: 'price', min: 0 },
      { id: 'discountRate', min: 0, max: 100 },
      { id: 'duration', min: 1, max: 30 },
      { id: 'mortalityRatePercent', min: 0, max: 100 },
      { id: 'contingencyPercent', min: 0, max: 100 }
    ];
    if (mode === 'detailed') {
      required.push({ id: 'areaAcre', min: 0 }, { id: 'density', min: 0 });
    } else {
      required.push({ id: 'coloniesDirect', min: 0 });
    }

    required.forEach(f => {
      const val = parseFloat(document.getElementById(f.id).value);
      if (isNaN(val) || val < f.min || (f.max !== undefined && val > f.max)) {
        const limitText = f.max !== undefined ? `${f.min} - ${f.max}` : `>= ${f.min}`;
        setError(f.id, 'Isi nombor sah (' + limitText + ').');
        valid = false;
      } else {
        setError(f.id, '');
      }
    });

    if (document.getElementById('enablePackaging').checked) {
      const bottleSize = parseFloat(document.getElementById('bottleSizeMl').value);
      if (isNaN(bottleSize) || bottleSize < 1) {
        setError('bottleSizeMl', 'Saiz botol mesti sekurang-kurangnya 1 ml.');
        valid = false;
      }
    } else {
      setError('bottleSizeMl', '');
    }

    const errorSummary = document.getElementById('errorSummary');
    errorSummary.style.display = valid ? 'none' : 'block';
    return valid;
  }

  function buildParams() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const areaAcre = parseFloat(document.getElementById('areaAcre').value) || 0;
    const density = parseFloat(document.getElementById('density').value) || 0;
    const coloniesDirect = parseFloat(document.getElementById('coloniesDirect').value) || 0;
    const colonies = mode === 'simple' ? Math.max(0, Math.round(coloniesDirect)) : Math.max(0, Math.round(areaAcre * density));

    const honeyYieldPerColony = parseFloat(document.getElementById('yieldPerColony').value) || 0;
    const honeyPrice = parseFloat(document.getElementById('price').value) || 0;
    let propIncomePerCol = parseFloat(document.getElementById('propIncomePerCol').value); if (isNaN(propIncomePerCol)) propIncomePerCol = 0;
    let soapIncomePerCol = parseFloat(document.getElementById('soapIncomePerCol').value); if (isNaN(soapIncomePerCol)) soapIncomePerCol = 0;
    let otherIncomePerCol = parseFloat(document.getElementById('otherIncomePerCol').value); if (isNaN(otherIncomePerCol)) otherIncomePerCol = 0;

    const clearCostPerAcre = parseFloat(document.getElementById('clearCostPerAcre').value) || 0;
    const fenceCostPerAcre = parseFloat(document.getElementById('fenceCostPerAcre').value) || 0;
    const colonySetupCostPerColony = parseFloat(document.getElementById('colonySetupCostPerColony').value) || 0;
    const numExtractors = parseFloat(document.getElementById('numExtractors').value) || 0;
    const extractorUnitCost = parseFloat(document.getElementById('extractorUnitCost').value) || 0;
    const numContainers = parseFloat(document.getElementById('numContainers').value) || 0;
    const containerUnitCost = parseFloat(document.getElementById('containerUnitCost').value) || 0;

    const insectControlAnnual = parseFloat(document.getElementById('insectControlAnnual').value) || 0;
    const labourAnnual = parseFloat(document.getElementById('labourCostAnnual').value) || 0;
    const fenceMaintPerAcre = parseFloat(document.getElementById('fenceMaintPerAcre').value) || 0;
    const extractorMaintAnnual = parseFloat(document.getElementById('extractorMaintAnnual').value) || 0;
    const colonyReplaceCostPerCol = parseFloat(document.getElementById('colonyReplacementCostPerColony').value) || 0;
    const landRentPerAcreAnnual = parseFloat(document.getElementById('landRentPerAcreAnnual').value) || 0;

    const T = clamp(parseInt(document.getElementById('duration').value) || 0, 1, 30);
    const discountRate = clamp((parseFloat(document.getElementById('discountRate').value) || 0), 0, 100) / 100;
    const contingencyRate = clamp((parseFloat(document.getElementById('contingencyPercent').value) || 0), 0, 100) / 100;

    const mortalityRate = clamp((parseFloat(document.getElementById('mortalityRatePercent').value) || 0), 0, 100) / 100;
    const replacementColonyCost = parseFloat(document.getElementById('replacementColonyCost').value) || 0;
    const costEscalation = (parseFloat(document.getElementById('costEscalationPercent').value) || 0) / 100;
    const priceEscalation = (parseFloat(document.getElementById('priceEscalationPercent').value) || 0) / 100;

    const enablePackaging = document.getElementById('enablePackaging').checked;
    const bottleSizeMl = parseFloat(document.getElementById('bottleSizeMl').value) || 250;
    const bottleCost = parseFloat(document.getElementById('bottleCost').value) || 0;
    const labelCost = parseFloat(document.getElementById('labelCost').value) || 0;
    const packagingCost = parseFloat(document.getElementById('packagingCost').value) || 0;

    const enableTransport = document.getElementById('enableTransport').checked;
    const transportMode = document.querySelector('input[name="transportMode"]:checked').value;
    const transportCostPerKg = parseFloat(document.getElementById('transportCostPerKg').value) || 0;
    const transportCostAnnual = parseFloat(document.getElementById('transportCostAnnual').value) || 0;

    const enableFeeding = document.getElementById('enableFeeding').checked;
    const feedingCostAnnual = parseFloat(document.getElementById('feedingCostAnnual').value) || 0;

    const enableCompliance = document.getElementById('enableCompliance').checked;
    const complianceCostAnnual = parseFloat(document.getElementById('complianceCostAnnual').value) || 0;

    const devCostClearing = areaAcre * clearCostPerAcre;
    const devCostFence = areaAcre * fenceCostPerAcre;
    const devCostColonies = colonies * colonySetupCostPerColony;
    const devCostExtract = numExtractors * extractorUnitCost;
    const devCostCont = numContainers * containerUnitCost;
    const devCost0 = devCostClearing + devCostFence + devCostColonies + devCostExtract + devCostCont;

    const annualFenceMaintEq = areaAcre * fenceMaintPerAcre / 3;
    const annualColonyReplaceEq = colonies * colonyReplaceCostPerCol / 2;
    const baseInputAnnual = annualFenceMaintEq + annualColonyReplaceEq + extractorMaintAnnual + insectControlAnnual;
    const baseLabourAnnual = labourAnnual;
    const baseMiscAnnual = areaAcre * landRentPerAcreAnnual;

    const enableYear1LowerYield = document.getElementById('enableYear1LowerYield').checked;
    const year1YieldFactor = clamp((parseFloat(document.getElementById('year1YieldFactor').value) || 70) / 100, 0, 1.5);

    const enableExpansion = document.getElementById('enableExpansion').checked;
    const expansionMode = document.querySelector('input[name="expansionMode"]:checked').value;
    const expansionIncrement = parseFloat(document.getElementById('expansionIncrement').value) || 0;
    const expansionPercent = ((parseFloat(document.getElementById('expansionPercent').value) || 0) / 100);

    return {
      mode,
      colonies,
      areaAcre,
      density,
      honeyYieldPerColony,
      honeyPrice,
      propIncomePerCol,
      soapIncomePerCol,
      otherIncomePerCol,
      otherProductName: document.getElementById('otherProductName').value.trim(),
      devCost0,
      baseInputAnnual,
      baseLabourAnnual,
      baseMiscAnnual,
      T,
      discountRate,
      mortalityRate,
      replacementColonyCost,
      costEscalation,
      priceEscalation,
      enablePackaging,
      bottleSizeMl,
      bottleCost,
      labelCost,
      packagingCost,
      enableTransport,
      transportMode,
      transportCostPerKg,
      transportCostAnnual,
      enableFeeding,
      feedingCostAnnual,
      enableCompliance,
      complianceCostAnnual,
      clearCostPerAcre,
      fenceCostPerAcre,
      colonySetupCostPerColony,
      numExtractors,
      extractorUnitCost,
      numContainers,
      containerUnitCost,
      insectControlAnnual,
      labourAnnual,
      fenceMaintPerAcre,
      extractorMaintAnnual,
      colonyReplaceCostPerCol,
      landRentPerAcreAnnual,
      contingencyRate,
      enableYear1LowerYield,
      year1YieldFactor,
      enableExpansion,
      expansionMode,
      expansionIncrement,
      expansionPercent
    };
  }

  function debounce(fn, delay = 400) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(null, args), delay);
    };
  }
  const saveStateDebounced = debounce(saveState, 400);

  function saveState() {
    const data = {};
    Object.keys(defaultState).forEach(key => {
      const el = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
      if (!el) return;
      if (el.type === 'radio') {
        const checked = document.querySelector(`input[name="${key}"]:checked`);
        data[key] = checked ? checked.value : defaultState[key];
      } else if (el.type === 'checkbox') {
        data[key] = el.checked;
      } else {
        data[key] = el.value;
      }
    });
    localStorage.setItem(storageKey, JSON.stringify(data));
  }

  function clearErrors() {
    document.querySelectorAll('.error-text').forEach(el => el.textContent = '');
    document.querySelectorAll('input').forEach(el => el.classList.remove('invalid'));
    const errorSummary = document.getElementById('errorSummary');
    if (errorSummary) errorSummary.style.display = 'none';
  }

  function setStatusMessage(msg, tone = 'info') {
    const el = document.getElementById('statusMessage');
    if (!el) return;
    el.textContent = msg || '';
    el.style.color = tone === 'warn' ? '#ffb74d' : '#c0c0c0';
  }

  function loadState() {
    const stored = localStorage.getItem(storageKey);
    if (!stored) return;
    try {
      const data = JSON.parse(stored);
      Object.keys(defaultState).forEach(key => {
        if (data[key] !== undefined) setValue(key, data[key]);
      });
    } catch (e) { console.warn('Tidak dapat memuat simpanan.'); }
  }

  function applyDefaults() {
    Object.entries(defaultState).forEach(([key, val]) => setValue(key, val));
    toggleModeUI();
    toggleOptionalSections();
    updateColonyEstimate();
    clearResults();
    clearErrors();
    setStatusMessage('');
    updateQuickPreview();
  }

  function applyDemo() {
    const demoState = {
      mode: 'detailed',
      areaAcre: 2,
      density: 35,
      coloniesDirect: 60,
      yieldPerColony: 3,
      price: 180,
      propIncomePerCol: 40,
      soapIncomePerCol: 25,
      otherIncomePerCol: 10,
      otherProductName: 'Bee bread',
      clearCostPerAcre: 1200,
      fenceCostPerAcre: 900,
      colonySetupCostPerColony: 1100,
      numExtractors: 1,
      extractorUnitCost: 250,
      numContainers: 2,
      containerUnitCost: 60,
      insectControlAnnual: 150,
      labourCostAnnual: 7200,
      fenceMaintPerAcre: 320,
      extractorMaintAnnual: 80,
      colonyReplacementCostPerColony: 60,
      landRentPerAcreAnnual: 550,
      discountRate: 4,
      duration: 8,
      mortalityRatePercent: 5,
      replacementColonyCost: 900,
      costEscalationPercent: 2,
      priceEscalationPercent: 1.5,
      enablePackaging: true,
      bottleSizeMl: 250,
      bottleCost: 1.6,
      labelCost: 0.6,
      packagingCost: 0.4,
      enableTransport: true,
      transportMode: 'perKg',
      transportCostPerKg: 1.5,
      transportCostAnnual: 0,
      enableFeeding: true,
      feedingCostAnnual: 800,
      enableCompliance: true,
      complianceCostAnnual: 600,
      enableYear1LowerYield: true,
      year1YieldFactor: 70,
      contingencyPercent: 10,
      enableExpansion: true,
      expansionMode: 'increment',
      expansionIncrement: 5,
      expansionPercent: 0
    };
    Object.entries({ ...defaultState, ...demoState }).forEach(([k,v]) => setValue(k,v));
    toggleModeUI();
    toggleOptionalSections();
    updateColonyEstimate();
    clearErrors();
    updateQuickPreview();
  }

  function clearResults() {
    document.getElementById('results').innerHTML = '';
    if (cfChartInstance) { cfChartInstance.destroy(); cfChartInstance = null; }
    if (cumCfChartInstance) { cumCfChartInstance.destroy(); cumCfChartInstance = null; }
    if (npvSensChartInstance) { npvSensChartInstance.destroy(); npvSensChartInstance = null; }
    if (tornadoChartInstance) { tornadoChartInstance.destroy(); tornadoChartInstance = null; }
  }

  function summarizeOptionalCosts(params) {
    const items = [];
    if (params.enablePackaging) items.push('Botol/label/pembungkusan');
    if (params.enableTransport) items.push('Pengangkutan/pos');
    if (params.enableFeeding) items.push('Feeding');
    if (params.enableCompliance) items.push('Pensijilan/ujian/lesen');
    if (params.enableExpansion) items.push('Tambah koloni tahunan');
    return items.length ? items.join(', ') : 'Tiada kos tambahan dipilih';
  }

  function computeYear1OptionalCosts(params) {
    const plannedColonies = coloniesPlanAtYear(params, 1);
    const effectiveColoniesYear1 = plannedColonies;
    const yieldFactor = params.enableYear1LowerYield ? params.year1YieldFactor : 1;
    const honeyKg = effectiveColoniesYear1 * params.honeyYieldPerColony * yieldFactor;
    let packaging = 0;
    if (params.enablePackaging && honeyKg > 0) {
      const bottles = Math.ceil((honeyKg * 1000) / params.bottleSizeMl);
      packaging = bottles * (params.bottleCost + params.labelCost + params.packagingCost);
    }
    const transport = params.enableTransport ? (params.transportMode === 'perKg' ? honeyKg * params.transportCostPerKg : params.transportCostAnnual) : 0;
    const feeding = params.enableFeeding ? params.feedingCostAnnual : 0;
    const compliance = params.enableCompliance ? params.complianceCostAnnual : 0;
    const mortalityReplace = effectiveColoniesYear1 * params.mortalityRate * params.replacementColonyCost;
    const total = packaging + transport + feeding + compliance + mortalityReplace;
    const details = [
      params.enablePackaging ? `Pembotolan/label: RM ${fmtNumber(packaging)}` : null,
      params.enableTransport ? `Pengangkutan/pos: RM ${fmtNumber(transport)}` : null,
      params.enableFeeding ? `Feeding: RM ${fmtNumber(feeding)}` : null,
      params.enableCompliance ? `Pensijilan/ujian: RM ${fmtNumber(compliance)}` : null,
      params.mortalityRate > 0 ? `Ganti koloni (risiko): RM ${fmtNumber(mortalityReplace)}` : null
    ].filter(Boolean).join(' | ');
    return { total, details, honeyKg };
  }

  function updateQuickPreview() {
    const params = buildParams();
    const plannedColonies = coloniesPlanAtYear(params, 1);
    const effectiveColoniesYear1 = plannedColonies;
    const yieldFactor = params.enableYear1LowerYield ? params.year1YieldFactor : 1;
    const honeyKg = effectiveColoniesYear1 * params.honeyYieldPerColony * yieldFactor;
    const bottles = params.enablePackaging ? Math.ceil((honeyKg * 1000) / Math.max(1, params.bottleSizeMl)) : 0;

    const year1Optional = computeYear1OptionalCosts(params);
    const annualBase = params.baseInputAnnual + params.baseLabourAnnual + params.baseMiscAnnual;
    const directCost = annualBase + year1Optional.total;
    const totalCost = directCost + directCost * params.contingencyRate;

    document.getElementById('previewHoney').textContent = `${fmtNumber(honeyKg)} kg`;
    document.getElementById('previewBottles').textContent = params.enablePackaging ? fmtNumber(bottles,0) + ' botol' : 'Tidak aktif';
    document.getElementById('previewCost').textContent = 'RM ' + fmtNumber(totalCost);
  }

  function buildMultiFactorSensitivity(params, scenarioParams) {
    const baseNPV = computeScenario({ ...scenarioParams, priceFactor: 1 }).npv;
    const cases = [
      { key: 'price', label: 'Harga madu', low: 0.8, high: 1.2 },
      { key: 'yieldPerColony', label: 'Hasil per koloni', low: 0.8, high: 1.2 },
      { key: 'mortalityRatePercent', label: 'Mortaliti koloni', low: 0.8, high: 1.2 },
      { key: 'labourCostAnnual', label: 'Kos tenaga kerja', low: 0.8, high: 1.2 }
    ];

    const rows = cases.map(c => {
      let lowParams = { ...params };
      let highParams = { ...params };
      if (c.key === 'mortalityRatePercent') {
        lowParams.mortalityRatePercent = clamp(params.mortalityRatePercent * c.low, 0, 100);
        highParams.mortalityRatePercent = clamp(params.mortalityRatePercent * c.high, 0, 100);
      } else {
        lowParams[c.key] = params[c.key] * c.low;
        highParams[c.key] = params[c.key] * c.high;
      }

      const lowScenario = computeScenario({ ...scenarioParams, baseHoneyPrice: lowParams.price || params.price, honeyYieldPerColony: lowParams.yieldPerColony || params.yieldPerColony, mortalityRate: (lowParams.mortalityRatePercent || params.mortalityRatePercent)/100, baseLabourAnnual: lowParams.labourCostAnnual || params.labourCostAnnual });
      const highScenario = computeScenario({ ...scenarioParams, baseHoneyPrice: highParams.price || params.price, honeyYieldPerColony: highParams.yieldPerColony || params.yieldPerColony, mortalityRate: (highParams.mortalityRatePercent || params.mortalityRatePercent)/100, baseLabourAnnual: highParams.labourCostAnnual || params.labourCostAnnual });

      const lowNPV = lowScenario.npv;
      const highNPV = highScenario.npv;
      const range = highNPV - lowNPV;
      return { label: c.label, lowNPV, baseNPV, highNPV, range };
    });

    rows.sort((a,b) => Math.abs(b.range) - Math.abs(a.range));

    let tableHtml = "<h3>Analisis Sensitiviti Pelbagai Faktor (NPV)</h3>";
    tableHtml += "<table><tr><th>Faktor</th><th>NPV Rendah</th><th>NPV Asas</th><th>NPV Tinggi</th><th>Julat</th></tr>";
    rows.forEach(r => {
      tableHtml += `<tr><td style="text-align:left">${r.label}</td><td>${coloredFmt(r.lowNPV)}</td><td>${coloredFmt(r.baseNPV)}</td><td>${coloredFmt(r.highNPV)}</td><td>${coloredFmt(r.range)}</td></tr>`;
    });
    tableHtml += "</table>";

    const chartData = rows.map(r => ({
      label: r.label,
      low: r.lowNPV,
      high: r.highNPV,
      range: r.range
    }));

    return { tableHtml, chartData };
  }

  function renderCharts(baseScenario, sensLabels, sensNPV) {
    const yearLabels = [];
    const cfData = [];
    let cum = 0;
    const cumData = [];

    for (let t = 0; t < baseScenario.cashflows.length; t++) {
      yearLabels.push("Tahun " + t);
      const cf = baseScenario.cashflows[t];
      cfData.push(cf);
      cum += cf;
      cumData.push(cum);
    }

    const cfColors = cfData.map(v => v < 0 ? 'rgba(255, 82, 82, 0.9)' : 'rgba(255, 202, 40, 0.7)');
    const cfBorderColors = cfData.map(v => v < 0 ? 'rgba(255, 82, 82, 1)' : 'rgba(255, 202, 40, 1)');

    if (cfChartInstance) cfChartInstance.destroy();
    const cfCtx = document.getElementById('cfChart').getContext('2d');
    cfChartInstance = new Chart(cfCtx, {
      type: 'bar',
      data: { labels: yearLabels, datasets: [{ label: 'Aliran Tunai Bersih (RM)', data: cfData, backgroundColor: cfColors, borderColor: cfBorderColors, borderWidth: 1 }] },
      options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });

    const cumNegative = cumData[cumData.length - 1] < 0;
    const cumLineColor = cumNegative ? 'rgba(255, 82, 82, 1)' : 'rgba(129, 199, 132, 1)';
    const cumFillColor = cumNegative ? 'rgba(255, 82, 82, 0.3)' : 'rgba(129, 199, 132, 0.3)';

    if (cumCfChartInstance) cumCfChartInstance.destroy();
    const cumCtx = document.getElementById('cumCfChart').getContext('2d');
    cumCfChartInstance = new Chart(cumCtx, {
      type: 'line',
      data: { labels: yearLabels, datasets: [{ label: 'Aliran Tunai Terkumpul (RM)', data: cumData, fill: false, borderColor: cumLineColor, backgroundColor: cumFillColor, tension: 0.2, borderWidth: 2 }] },
      options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });

    const npvBarColors = sensNPV.map(v => v < 0 ? 'rgba(255, 82, 82, 0.9)' : 'rgba(255, 213, 79, 0.7)');
    const npvBorderColors = sensNPV.map(v => v < 0 ? 'rgba(255, 82, 82, 1)' : 'rgba(255, 213, 79, 1)');

    if (npvSensChartInstance) npvSensChartInstance.destroy();
    const npvCtx = document.getElementById('npvSensChart').getContext('2d');
    npvSensChartInstance = new Chart(npvCtx, {
      type: 'bar',
      data: { labels: sensLabels, datasets: [{ label: 'NPV mengikut Senario Harga Madu (RM)', data: sensNPV, backgroundColor: npvBarColors, borderColor: npvBorderColors, borderWidth: 1 }] },
      options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });
  }

  function renderTornadoChart(chartData) {
    const labels = chartData.map(d => d.label);
    const lowValues = chartData.map(d => d.low);
    const highValues = chartData.map(d => d.high);

    if (tornadoChartInstance) tornadoChartInstance.destroy();
    const ctx = document.getElementById('tornadoChart').getContext('2d');
    tornadoChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'NPV Rendah', data: lowValues, backgroundColor: 'rgba(255,82,82,0.6)', borderColor: 'rgba(255,82,82,1)', borderWidth: 1 },
          { label: 'NPV Tinggi', data: highValues, backgroundColor: 'rgba(139,195,74,0.6)', borderColor: 'rgba(139,195,74,1)', borderWidth: 1 }
        ]
      },
      options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: true } }, scales: { x: { beginAtZero: true } } }
    });
  }

  function downloadCSV(filename, rows) {
    const csvContent = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  function downloadCashflowCSV() {
    const params = buildParams();
    const scenarioParams = { ...params, baseHoneyPrice: params.honeyPrice, baseLabourAnnual: params.labourAnnual, priceFactor: 1 };
    const sc = computeScenario(scenarioParams);
    const rows = [["Tahun","KoloniEfektif","Hasil(RM)","Kos(RM)","AliranTunai(RM)","CF_Terkumpul(RM)","PV_CF(RM)"]];
    let cum = 0;
    sc.cashflows.forEach((cf, t) => {
      cum += cf;
      const pv = cf / Math.pow(1 + params.discountRate, t);
      rows.push([t, fmtNumber(sc.effectiveColoniesSeries[t] || 0,0), fmtNumber(sc.benefits[t]), fmtNumber(sc.totalCosts[t]), fmtNumber(cf), fmtNumber(cum), fmtNumber(pv)]);
    });
    downloadCSV("aliran_tunai_kelulut.csv", rows);
  }

  function downloadSensitivityCSV() {
    const params = buildParams();
    const scenarioParams = { ...params, baseHoneyPrice: params.honeyPrice, baseLabourAnnual: params.labourAnnual, priceFactor: 1 };
    const multiSens = buildMultiFactorSensitivity(params, scenarioParams);
    const baseNPV = computeScenario(scenarioParams).npv;
    const rows = [["Faktor","LowNPV","BaseNPV","HighNPV","RangeNPV"]];
    multiSens.chartData.forEach(r => rows.push([r.label, fmtNumber(r.low), fmtNumber(baseNPV), fmtNumber(r.high), fmtNumber(r.range)]));
    downloadCSV("sensitiviti_kelulut.csv", rows);
  }

  function runAnalysis() {
    if (!validateInputs()) return;
    const farmerName = document.getElementById('farmerName').value.trim();
    const villageName = document.getElementById('villageName').value.trim();
    const phoneNumber = document.getElementById('phoneNumber').value.trim();

    const params = buildParams();
    const {
      colonies, honeyYieldPerColony, honeyPrice, propIncomePerCol, soapIncomePerCol, otherIncomePerCol,
      devCost0, baseInputAnnual, baseLabourAnnual, baseMiscAnnual, T, discountRate,
      mortalityRate, replacementColonyCost, costEscalation, priceEscalation, contingencyRate
    } = params;

    const scenarioParams = {
      T,
      colonies,
      honeyYieldPerColony,
      baseHoneyPrice: honeyPrice,
      propIncomePerColony: propIncomePerCol,
      soapIncomePerColony: soapIncomePerCol,
      otherIncomePerColony: otherIncomePerCol,
      devCost0,
      baseInputAnnual,
      baseLabourAnnual,
      baseMiscAnnual,
      bottleSizeMl: params.bottleSizeMl,
      bottleCost: params.bottleCost,
      labelCost: params.labelCost,
      packagingCost: params.packagingCost,
      enablePackaging: params.enablePackaging,
      enableTransport: params.enableTransport,
      transportMode: params.transportMode,
      transportCostPerKg: params.transportCostPerKg,
      transportCostAnnual: params.transportCostAnnual,
      enableFeeding: params.enableFeeding,
      feedingCostAnnual: params.feedingCostAnnual,
      enableCompliance: params.enableCompliance,
      complianceCostAnnual: params.complianceCostAnnual,
      mortalityRate,
      replacementColonyCost,
      costEscalation,
      priceEscalation,
      discountRate,
      priceFactor: 1,
      contingencyRate,
      enableYear1LowerYield: params.enableYear1LowerYield,
      year1YieldFactor: params.year1YieldFactor,
      enableExpansion: params.enableExpansion,
      expansionMode: params.expansionMode,
      expansionIncrement: params.expansionIncrement,
      expansionPercent: params.expansionPercent,
      colonySetupCostPerColony: params.colonySetupCostPerColony
    };

    const baseScenario = computeScenario(scenarioParams);
    const breakEvenPrice = computeBreakEvenHoneyPrice(scenarioParams);

    const totalBenefits = baseScenario.benefits.reduce((a,b) => a + b, 0);
    const totalCosts = baseScenario.totalCosts.reduce((a,b) => a + b, 0);
    const roi = totalCosts > 0 ? ((totalBenefits - totalCosts) / totalCosts) * 100 : null;
    const roiYear1 = baseScenario.totalCosts[1] > 0 ? (baseScenario.cashflows[1] / baseScenario.totalCosts[1]) * 100 : null;

    const paybackText = baseScenario.paybackYear ? "Tahun ke-" + baseScenario.paybackYear : "Tidak pulang modal dalam tempoh analisis";
    const irrText = baseScenario.irr !== null ? `${fmtNumber(baseScenario.irr)} %` : 'IRR tidak dapat dikira (aliran tunai tiada perubahan tanda)';

    const otherName = params.otherProductName ? ` (${params.otherProductName})` : '';
    const year1Optional = computeYear1OptionalCosts(params);
    const honeyRevenueAnnual = year1Optional.honeyKg * honeyPrice;
    const propRevenueAnnual = colonies * propIncomePerCol;
    const soapRevenueAnnual = colonies * soapIncomePerCol;
    const otherRevenueAnnual = colonies * otherIncomePerCol;
    const totalAnnualRevenue = honeyRevenueAnnual + propRevenueAnnual + soapRevenueAnnual + otherRevenueAnnual;

    const keyCards = `
      <div class="three-cards">
        <div class="mini-card"><h4>Untung bersih setahun (Tahun 1)</h4><div class="badge">RM ${fmtNumber(baseScenario.cashflows[1] || 0)}</div><small class="note">Bersih selepas kos & kontinjensi pada tahun pertama operasi.</small></div>
        <div class="mini-card"><h4>Tahun pulang modal</h4><div class="badge">${paybackText}</div><small class="note">Tahun di mana aliran tunai terkumpul mula positif.</small></div>
        <div class="mini-card"><h4>Harga madu minimum tak rugi</h4><div class="badge">${breakEvenPrice !== null ? 'RM ' + fmtNumber(breakEvenPrice) + ' /kg' : '-'}</div><small class="note">Harga madu anggaran supaya NPV ‚âà 0 (ambil kira hasil lain).</small></div>
      </div>
    `;

    const metricsTable = `
      <h3>Analisis Lanjut / Profesional</h3>
      <table>
        <tr><th style="text-align:left;">Penunjuk</th><th>Nilai</th><th style="text-align:left;">Takrif Ringkas</th></tr>
        <tr><td style="text-align:left;">NPV (Nilai Kini Bersih)</td><td>RM ${coloredFmt(baseScenario.npv)}</td><td style="text-align:left;">Lebihan nilai bersih selepas diskaun pada kadar ${fmtNumber(discountRate*100,0)}%.</td></tr>
        <tr><td style="text-align:left;">IRR (Kadar Pulangan Dalaman)</td><td>${baseScenario.irr !== null ? coloredFmt(baseScenario.irr) + ' %' : '-'}</td><td style="text-align:left;">${irrText}</td></tr>
        <tr><td style="text-align:left;">BCR (Nisbah Faedah-Kos)</td><td>${baseScenario.bcr !== null ? baseScenario.bcr.toFixed(2) : '-'}</td><td style="text-align:left;">Jika &gt; 1, faedah melebihi kos.</td></tr>
        <tr><td style="text-align:left;">ROI (Keseluruhan)</td><td>${roi !== null ? coloredFmt(roi) + ' %' : '-'}</td><td style="text-align:left;">Pulangan sepanjang projek.</td></tr>
        <tr><td style="text-align:left;">ROI Tahun 1</td><td>${roiYear1 !== null ? coloredFmt(roiYear1) + ' %' : '-'}</td><td style="text-align:left;">Pulangan pada tahun operasi pertama sahaja.</td></tr>
        <tr><td style="text-align:left;">Harga Pulang Modal Madu</td><td>${breakEvenPrice !== null ? 'RM ' + fmtNumber(breakEvenPrice) + ' /kg' : '-'}</td><td style="text-align:left;">Harga minimum untuk NPV ‚âà 0 termasuk pendapatan sampingan.</td></tr>
        <tr><td style="text-align:left;">Tempoh Pulang Modal (Payback Period)</td><td>${paybackText}</td><td style="text-align:left;">Tahun aliran tunai terkumpul mula positif.</td></tr>
      </table>
    `;

    let conclusionClass = "conclusion-box";
    let conclusionHeader = "";
    let conclusionText = "";
    let suggestionHtml = "<ul>";

    if (baseScenario.npv > 0 && baseScenario.bcr !== null && baseScenario.bcr > 1 && roi !== null && roi > 20 && (baseScenario.irr === null || baseScenario.irr > discountRate*100)) {
      conclusionClass += " conclusion-good";
      conclusionHeader = "‚úÖ PROJEK BERBALOI";
      conclusionText = "Dengan anggaran semasa, projek ini menunjukkan pulangan yang baik dan berpotensi memberi keuntungan stabil kepada penternak.";
      suggestionHtml += "<li>Tingkatkan pemasaran (jenama sendiri, jual terus kepada pengguna) untuk kekalkan harga jual di paras tinggi.</li>";
      suggestionHtml += "<li>Kekalkan mutu penjagaan koloni supaya hasil madu per koloni stabil atau meningkat.</li>";
      suggestionHtml += "<li>Beli input secara pukal atau melalui koperasi untuk mengurangkan kos.</li>";
      suggestionHtml += "<li>Boleh tambah bilangan koloni secara berperingkat selepas projek stabil.</li>";
    } else if (baseScenario.npv > 0 && baseScenario.bcr !== null && baseScenario.bcr >= 1) {
      conclusionClass += " conclusion-moderate";
      conclusionHeader = "‚ö† PROJEK BERBALOI (BERJAGA-JAGA)";
      conclusionText = "Projek ini masih boleh diteruskan tetapi margin keuntungan tidak terlalu besar. Penternak perlu mengawal kos dan berusaha meningkatkan hasil.";
      suggestionHtml += "<li>Naikkan hasil madu per koloni melalui latihan teknikal dan amalan penternakan yang lebih baik.</li>";
      suggestionHtml += "<li>Bandingkan beberapa pembekal input untuk mendapatkan harga yang lebih rendah.</li>";
      suggestionHtml += "<li>Kawal kos tenaga kerja supaya selari dengan saiz projek.</li>";
      suggestionHtml += "<li>Manfaatkan bantuan kerajaan, program agropreneur atau geran yang tersedia.</li>";
    } else {
      conclusionClass += " conclusion-bad";
      conclusionHeader = "‚ùå PROJEK BERISIKO / KURANG BERBALOI";
      conclusionText = "Dengan anggaran semasa, projek ini kelihatan berisiko atau kurang menguntungkan. Penternak disaran menilai semula sebelum melabur modal yang besar.";
      suggestionHtml += "<li>Cuba tingkatkan harga jual melalui pembungkusan lebih baik, pensijilan atau pemasaran terus kepada pengguna.</li>";
      suggestionHtml += "<li>Tingkatkan hasil per koloni melalui bimbingan teknikal dan pengurusan koloni yang baik.</li>";
      suggestionHtml += "<li>Kurangkan kos pembangunan awal dengan mula pada skala lebih kecil.</li>";
      suggestionHtml += "<li>Kurangkan kos tenaga kerja melalui kerjasama keluarga atau koperasi.</li>";
      suggestionHtml += "<li>Cari bantuan geran, subsidi atau skim sokongan agensi kerajaan untuk mengurangkan beban modal awal.</li>";
    }
    suggestionHtml += "</ul>";

    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = `
      <div class="result-box">
        <p><strong>Nama penternak:</strong> ${farmerName || '-'} | <strong>Kampung / lokasi:</strong> ${villageName || '-'} | <strong>No. telefon:</strong> ${phoneNumber || '-'}</p>
        <p><strong>Mod:</strong> ${params.mode === 'simple' ? 'Ringkas (Kampung)' : 'Terperinci (Profesional)'}</p>
        <p><strong>Bilangan koloni digunakan dalam kiraan:</strong> ${fmtNumber(colonies,0)}</p>
        <p><strong>Jumlah hasil madu tahun pertama:</strong> ${fmtNumber(year1Optional.honeyKg)} kg ‚Üí anggaran nilai: RM ${fmtNumber(honeyRevenueAnnual)}</p>
        <p><strong>Anggaran hasil propolis setahun:</strong> RM ${fmtNumber(propRevenueAnnual)} | <strong>Sabun:</strong> RM ${fmtNumber(soapRevenueAnnual)} | <strong>Lain-lain${otherName}:</strong> RM ${fmtNumber(otherRevenueAnnual)}</p>
        <p><strong>Jumlah semua hasil setahun (Tahun 1):</strong> RM ${fmtNumber(totalAnnualRevenue)}</p>
        <p><strong>Jumlah kos pembangunan (tahun 0):</strong> RM ${fmtNumber(devCost0)}</p>
        <p><strong>Kos bahan input tahunan setara (asas):</strong> RM ${fmtNumber(baseInputAnnual)} / tahun</p>
        <p><strong>Kos tenaga kerja tahunan:</strong> RM ${fmtNumber(baseLabourAnnual)} / tahun | <strong>Kos pelbagai/utiliti:</strong> RM ${fmtNumber(baseMiscAnnual)} / tahun</p>
        <p><strong>Kos tahunan tambahan dipilih:</strong> ${summarizeOptionalCosts(params)}</p>
        <p><strong>Anggaran kos tambahan Tahun 1:</strong> RM ${fmtNumber(year1Optional.total)}${year1Optional.details ? ' (' + year1Optional.details + ')' : ''}</p>
        ${keyCards}
        ${metricsTable}
      </div>
      <div class="${conclusionClass}">
        <div class="conclusion-title">${conclusionHeader}</div>
        <p>${conclusionText}</p>
        <strong>Cara untuk tambah keuntungan / kurangkan risiko:</strong>
        ${suggestionHtml}
      </div>
    `;

    let table = "<h3>Jadual Aliran Tunai</h3>";
    table += "<table><tr><th>Tahun</th><th>Koloni Efektif</th><th>Hasil (RM)</th><th>Jumlah Kos (RM)</th><th>CF (RM)</th></tr>";
    for (let t = 0; t <= T; t++) {
      table += `<tr><td style=\"text-align:center\">${t}</td><td>${fmtNumber(baseScenario.effectiveColoniesSeries[t] || 0,0)}</td><td>${coloredFmt(baseScenario.benefits[t])}</td><td>${coloredFmt(baseScenario.totalCosts[t])}</td><td>${coloredFmt(baseScenario.cashflows[t])}</td></tr>`;
    }
    table += "</table>";
    resultsDiv.innerHTML += table;

    let sensTable = "<h3>Analisis Sensitiviti Harga Madu (NPV, IRR, BCR)</h3>";
    sensTable += "<table><tr><th>Senario</th><th>Faktor Harga</th><th>Harga madu/kg (RM)</th><th>NPV (RM)</th><th>IRR (%)</th><th>BCR</th></tr>";
    const factors = [0.8, 0.9, 1.0, 1.1, 1.2];
    const sensLabels = [];
    const sensNPV = [];
    factors.forEach((f, idx) => {
      const sc = computeScenario({ ...scenarioParams, priceFactor: f });
      sensLabels.push((f * 100).toFixed(0) + "%");
      sensNPV.push(sc.npv);
      sensTable += `<tr><td style=\"text-align:center\">${idx + 1}</td><td>${(f * 100).toFixed(0)}%</td><td>${fmtNumber(honeyPrice * f)}</td><td>${coloredFmt(sc.npv)}</td><td>${sc.irr !== null ? coloredFmt(sc.irr) : '-'}</td><td>${sc.bcr !== null ? sc.bcr.toFixed(2) : '-'}</td></tr>`;
    });
    sensTable += "</table>";
    resultsDiv.innerHTML += sensTable;

    const multiSensitivity = buildMultiFactorSensitivity(params, scenarioParams);
    resultsDiv.innerHTML += multiSensitivity.tableHtml;
    resultsDiv.innerHTML += `<p class=\"note\">Nota: Kadar kontinjensi ditetapkan kepada ${fmtNumber(params.contingencyRate * 100,0)}% dan digunakan ke atas semua kos setiap tahun.</p>`;

    renderCharts(baseScenario, sensLabels, sensNPV);
    renderTornadoChart(multiSensitivity.chartData);

    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

    const now = new Date();
    const dateStr = now.toLocaleDateString('ms-MY');
    const timeStr = now.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });
    document.getElementById('reportMeta').textContent = `Versi kalkulator: v2.1 | Tarikh laporan dijana: ${dateStr} ${timeStr}`;
    saveState();
    setStatusMessage('Analisis berjaya dijana pada ' + dateStr + ' ' + timeStr + '.');
  }

  function downloadPDF() {
    const report = document.getElementById('reportArea');
    if (!report) return;
    const { jsPDF } = window.jspdf;
    html2canvas(report, { scale: 2 }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pdfWidth;
      const imgHeight = canvas.height * pdfWidth / canvas.width;
      let heightLeft = imgHeight;
      let position = 0;
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pdfHeight;
      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pdfHeight;
      }
      pdf.save('Laporan_Projek_Madu_Kelulut_ringkas.pdf');
    });
  }

  function downloadProfessionalPDF() {
    const params = buildParams();
    const scenarioParams = { ...params, baseHoneyPrice: params.honeyPrice, baseLabourAnnual: params.labourAnnual, priceFactor: 1 };
    const sc = computeScenario(scenarioParams);
    const baseNPV = sc.npv;
    const irrVal = sc.irr;
    const bcrVal = sc.bcr;
    const totalCosts = sc.totalCosts.reduce((a,b)=>a+b,0);
    const totalBenefits = sc.benefits.reduce((a,b)=>a+b,0);
    const roi = totalCosts > 0 ? ((totalBenefits - totalCosts) / totalCosts) * 100 : null;
    const roiYear1 = sc.totalCosts[1] > 0 ? (sc.cashflows[1] / sc.totalCosts[1]) * 100 : null;
    const paybackText = sc.paybackYear ? `Tahun ke-${sc.paybackYear}` : "Tidak pulang modal dalam tempoh analisis";

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const margin = 12;
    let y = 14;

    pdf.setFontSize(14);
    pdf.text("Laporan Profesional - Projek Madu Kelulut", margin, y); y += 8;
    pdf.setFontSize(10);
    const now = new Date();
    pdf.text(`Nama penternak: ${document.getElementById('farmerName').value || '-'}`, margin, y); y += 6;
    pdf.text(`Lokasi: ${document.getElementById('villageName').value || '-'}`, margin, y); y += 6;
    pdf.text(`Tarikh/jam: ${now.toLocaleDateString('ms-MY')} ${now.toLocaleTimeString('ms-MY', {hour:'2-digit', minute:'2-digit'})}`, margin, y); y += 6;
    pdf.text(`Versi kalkulator: v2.1`, margin, y); y += 8;

    pdf.setFontSize(12);
    pdf.text("Ringkasan Utama", margin, y); y += 6;
    pdf.setFontSize(10);
    pdf.text(`Untung Tahun 1: RM ${fmtNumber(sc.cashflows[1] || 0)}`, margin, y); y += 6;
    pdf.text(`Payback: ${paybackText}`, margin, y); y += 6;
    pdf.text(`Break-even harga madu: RM ${fmtNumber(computeBreakEvenHoneyPrice(scenarioParams) || 0)} /kg`, margin, y); y += 6;
    pdf.text(`NPV: RM ${fmtNumber(baseNPV)}`, margin, y); y += 6;
    pdf.text(`IRR: ${irrVal !== null ? fmtNumber(irrVal) + ' %' : '-'}`, margin, y); y += 6;
    pdf.text(`BCR: ${bcrVal !== null ? bcrVal.toFixed(2) : '-'}`, margin, y); y += 6;
    pdf.text(`ROI keseluruhan: ${roi !== null ? fmtNumber(roi) + ' %' : '-'}`, margin, y); y += 6;
    pdf.text(`ROI Tahun 1: ${roiYear1 !== null ? fmtNumber(roiYear1) + ' %' : '-'}`, margin, y); y += 10;

    const addTable = (headers, rows) => {
      const colWidth = (pageWidth - margin*2) / headers.length;
      pdf.setFontSize(10);
      headers.forEach((h, idx) => pdf.text(h, margin + idx * colWidth, y));
      y += 6;
      rows.forEach(r => {
        if (y > 280) { pdf.addPage(); y = 14; }
        r.forEach((c, idx) => pdf.text(String(c), margin + idx * colWidth, y));
        y += 6;
      });
      y += 4;
    };

    pdf.setFontSize(12);
    pdf.text("Jadual Aliran Tunai", margin, y); y += 6;
    const cfRows = sc.cashflows.map((cf, t) => [t, fmtNumber(sc.effectiveColoniesSeries[t] || 0,0), fmtNumber(sc.benefits[t]), fmtNumber(sc.totalCosts[t]), fmtNumber(cf)]);
    addTable(["Tahun","Koloni","Hasil","Kos","CF"], cfRows);

    pdf.addPage();
    y = 14;
    pdf.setFontSize(12);
    pdf.text("Analisis Sensitiviti (Pelbagai Faktor)", margin, y); y += 6;
    const multiSens = buildMultiFactorSensitivity(params, scenarioParams);
    const sensRows = multiSens.chartData.map(r => [r.label, fmtNumber(r.low), fmtNumber(baseNPV), fmtNumber(r.high), fmtNumber(r.range)]);
    addTable(["Faktor","NPV Rendah","NPV Asas","NPV Tinggi","Julat"], sensRows);
    pdf.text("Nota: Nilai dalam RM, dibundarkan ke 2 perpuluhan.", margin, y > 280 ? 280 : y);

    const pageCount = pdf.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      pdf.setPage(i);
      pdf.setFontSize(8);
      pdf.text(`Halaman ${i} / ${pageCount}`, pageWidth - margin*2, 290);
    }

    pdf.save('Laporan_Projek_Madu_Kelulut_profesional.pdf');
  }

  function setupListeners() {
    document.getElementById('btnRun').addEventListener('click', runAnalysis);
    document.getElementById('btnReset').addEventListener('click', () => { applyDefaults(); clearResults(); saveState(); updateColonyEstimate(); setStatusMessage('Semua medan telah direset ke nilai asal.'); });
    document.getElementById('btnDemo').addEventListener('click', () => { applyDemo(); setStatusMessage('Contoh demo dimasukkan.'); });
    document.getElementById('btnSave').addEventListener('click', () => { saveState(); setStatusMessage('Data berjaya disimpan di pelayar.'); });
    document.getElementById('btnClearSave').addEventListener('click', () => { localStorage.removeItem(storageKey); applyDefaults(); setStatusMessage('Simpanan dibersihkan.'); });

    ['modeSimple','modeDetailed','areaAcre','density'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', () => { updateColonyEstimate(); saveStateDebounced(); validateInputs(); updateQuickPreview(); });
    });

    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', () => { if (el.id) setError(el.id, ''); saveStateDebounced(); updateQuickPreview(); });
      if (el.type === 'radio') el.addEventListener('change', () => { saveStateDebounced(); updateQuickPreview(); toggleOptionalSections(); });
    });

    document.getElementById('enablePackaging').addEventListener('change', () => { toggleOptionalSections(); saveStateDebounced(); updateQuickPreview(); });
    document.getElementById('enableTransport').addEventListener('change', () => { toggleOptionalSections(); saveStateDebounced(); updateQuickPreview(); });
    document.getElementById('enableFeeding').addEventListener('change', () => { toggleOptionalSections(); saveStateDebounced(); updateQuickPreview(); });
    document.getElementById('enableCompliance').addEventListener('change', () => { toggleOptionalSections(); saveStateDebounced(); updateQuickPreview(); });
    document.getElementById('enableYear1LowerYield').addEventListener('change', () => { saveStateDebounced(); updateQuickPreview(); });
    document.getElementById('enableExpansion').addEventListener('change', () => { saveStateDebounced(); updateQuickPreview(); });
    document.querySelectorAll('input[name="mode"]').forEach(el => el.addEventListener('change', toggleModeUI));
    document.querySelectorAll('input[name="transportMode"]').forEach(el => el.addEventListener('change', () => { toggleOptionalSections(); saveStateDebounced(); }));
    document.querySelectorAll('input[name="expansionMode"]').forEach(el => el.addEventListener('change', () => { saveStateDebounced(); }));
  }

  window.onload = () => {
    applyDefaults();
    loadState();
    toggleModeUI();
    toggleOptionalSections();
    updateColonyEstimate();
    clearErrors();
    setupListeners();
    updateQuickPreview();
  };
</script>
</body>
</html>
