<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KALKULATOR PROJEK MADU KELULUT</title>
  <style>
    :root {
      --gold: #ffca28;
      --amber: #ffd54f;
      --bg: #0b0b0b;
      --panel: #131313;
      --text: #f4f4f4;
      --muted: #c0c0c0;
      --danger: #ff5252;
      --success: #8bc34a;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top left, #3d2b1f 0, #0b0b0b 45%, #000000 100%);
      color: var(--text);
    }
    h1 {
      text-align: center;
      color: var(--amber);
      margin-bottom: 4px;
      letter-spacing: 1px;
    }
    h2 {
      text-align: center;
      color: var(--gold);
      margin-top: 0;
      font-weight: normal;
    }
    .container {
      max-width: 950px;
      margin: auto;
      background: linear-gradient(135deg, #111111 0%, #181818 60%, #121212 100%);
      padding: 16px 18px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.8);
      border: 1px solid rgba(255, 215, 128, 0.6);
    }
    .section-title {
      margin-top: 15px;
      font-weight: bold;
      color: var(--gold);
      border-bottom: 2px solid rgba(255, 213, 79, 0.4);
      padding-bottom: 2px;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.5px;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 14px;
      color: #f1f1f1;
    }
    input, select {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #1e1e1e;
      color: #f4f4f4;
    }
    input::placeholder { color: #888; }
    button {
      margin-top: 8px;
      padding: 10px;
      font-size: 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-primary {
      background: linear-gradient(90deg, #ffca28, #ffa000);
      color: #222;
      font-weight: bold;
      width: 100%;
    }
    .btn-secondary {
      background: transparent;
      color: var(--gold);
      border: 1px solid var(--gold);
    }
    .btn-ghost {
      background: #1c1c1c;
      color: var(--text);
      border: 1px solid #333;
    }
    .btn-inline { width: auto; display: inline-block; margin-right: 8px; }
    .note { font-size: 11px; color: #c0c0c0; margin-top: 6px; }
    .hint { color: #ffecb3; font-size: 11px; display: block; margin-top: 2px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #444;
      padding: 4px;
      text-align: right;
    }
    th { background: #2b2418; color: #ffecb3; }
    td { background: #171717; color: #f1f1f1; }
    canvas { margin-top: 10px; background: #111; border-radius: 4px; border: 1px solid #333; }
    .result-box {
      background: rgba(33,33,33,0.9);
      border-left: 4px solid var(--gold);
      padding: 8px 10px;
      margin-top: 12px;
      border-radius: 4px;
    }
    .conclusion-box {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 4px;
      border-left: 4px solid #999;
      font-size: 13px;
      background: #191919;
    }
    .conclusion-good { background: linear-gradient(90deg, #1b5e20, #2e7d32); border-left-color: #00e676; box-shadow: 0 0 12px rgba(0,230,118,0.6); }
    .conclusion-moderate { background: linear-gradient(90deg, #ff6f00, #ff8f00); border-left-color: #ffd600; box-shadow: 0 0 12px rgba(255,214,0,0.6); color: #1a1a1a; }
    .conclusion-bad { background: linear-gradient(90deg, #b71c1c, #d32f2f); border-left-color: #ff5252; box-shadow: 0 0 12px rgba(255,82,82,0.6); }
    .conclusion-title { font-weight: bold; font-size: 18px; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; color: #fff; }
    .step-card { background: #101010; border: 1px solid #2b2418; border-radius: 8px; padding: 10px 12px; margin-top: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.35); }
    .pill { padding: 4px 8px; border-radius: 12px; background: #1f1f1f; border: 1px solid #333; display: inline-block; margin-right: 6px; }
    .mode-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .inline { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .inline input[type="radio"] { width: auto; }
    details { background: #121212; border: 1px solid #222; border-radius: 6px; padding: 0; margin-top: 8px; }
    summary { cursor: pointer; color: var(--gold); font-weight: bold; padding: 8px 10px; list-style: none; }
    summary::-webkit-details-marker { display: none; }
    details > summary:focus { outline: 2px solid rgba(255, 202, 40, 0.6); outline-offset: 2px; }
    .step { background: #0f0f0f; border: 1px solid #2b2418; border-radius: 10px; margin-top: 12px; }
    .step > summary { background: linear-gradient(90deg, rgba(255,202,40,0.18), rgba(18,18,18,0.9)); font-size: 16px; padding: 12px 14px; display: flex; align-items: center; gap: 10px; border-left: 6px solid transparent; }
    .step[data-step="1"] > summary { border-left-color: rgba(255, 193, 7, 0.9); }
    .step[data-step="2"] > summary { border-left-color: rgba(100, 181, 246, 0.9); }
    .step[data-step="3"] > summary { border-left-color: rgba(129, 199, 132, 0.9); }
    .step[open] > summary { border-bottom: 1px solid rgba(255, 213, 79, 0.4); }
    .section { background: #131313; border: 1px solid #2a2a2a; }
    .section > summary { background: #1a1a1a; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .section-body { padding: 8px 10px 10px; }
    .error-text { color: var(--danger); font-size: 11px; min-height: 14px; }
    .invalid { border-color: var(--danger); box-shadow: 0 0 0 1px rgba(255,82,82,0.4); }
    .error-summary { background: rgba(183,28,28,0.15); color: #ffcdd2; border: 1px solid rgba(255,82,82,0.6); padding: 8px; border-radius: 6px; margin-top: 10px; display: none; }
    .three-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 10px; margin-top: 10px; }
    .mini-card { background: #161616; border: 1px solid #333; border-left: 4px solid var(--gold); padding: 8px; border-radius: 6px; }
    .mini-card h4 { margin: 0 0 4px 0; color: var(--amber); }
    .badge { background: #1e1e1e; color: var(--text); border: 1px solid #333; padding: 2px 6px; border-radius: 10px; font-size: 11px; }
    .meta { font-size: 11px; color: var(--muted); text-align: right; }
    .hint-example { font-size: 0.9em; opacity: 0.85; margin-top: 6px; color: #c9c9c9; }
    .helper-box { padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); margin-top: 8px; }
    .note.small { font-size: 11px; color: #d0d0d0; }
    .metric-desc { font-size: 12px; line-height: 1.4; color: #e6e6e6; }
    .metric-desc strong { color: #ffecb3; }
    .info-panels { margin-top: 10px; display: grid; gap: 10px; }
    .info-panel { background: #121212; border: 1px solid rgba(255, 213, 79, 0.2); }
    .info-panel > summary { color: #ffe082; background: rgba(255, 213, 79, 0.08); }
    .info-panel-body { padding: 10px 12px 12px; }
    .hl-val { background: #ffe95c; color: #111; font-weight: 800; padding: 0 6px; border-radius: 6px; }
    .hl-name { background: #7df2ff; color: #111; font-weight: 800; padding: 0 6px; border-radius: 6px; }
    .info-strong { color: #ffe95c; font-weight: 800; }
    .step-badge, .section-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: bold;
      font-size: 11px;
      letter-spacing: 0.4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-transform: uppercase;
      min-width: 48px;
    }
    .step-badge.step-1 { background: rgba(255, 193, 7, 0.85); color: #1b1b1b; }
    .step-badge.step-2 { background: rgba(100, 181, 246, 0.85); color: #0b0b0b; }
    .step-badge.step-3 { background: rgba(129, 199, 132, 0.85); color: #0b0b0b; }
    .section-badge { min-width: 34px; font-size: 10px; color: #0c0c0c; box-shadow: 0 0 0 1px rgba(0,0,0,0.2); }
    .section-a { background: rgba(255, 204, 128, 0.9); }
    .section-b { background: rgba(255, 213, 79, 0.9); }
    .section-b2 { background: rgba(255, 171, 145, 0.9); }
    .section-c { background: rgba(144, 202, 249, 0.9); }
    .section-d { background: rgba(165, 214, 167, 0.9); }
    .section-e { background: rgba(206, 147, 216, 0.9); }
    .section-f { background: rgba(128, 203, 196, 0.9); }
    .section-g { background: rgba(188, 170, 164, 0.9); }
    .section-h { background: rgba(176, 190, 197, 0.9); }
    .req-badge { background: #ffeb3b; color: #2b2b2b; font-size: 10px; font-weight: bold; padding: 1px 6px; border-radius: 999px; margin-left: 6px; border: 1px solid #ffd600; letter-spacing: 0.4px; }
    .req-input { background: #fff7b0; border: 1px solid #ffd400; box-shadow: 0 0 6px rgba(255, 214, 0, 0.45); color: #1e1e1e; }
    .req-input::placeholder { color: #6b5a00; }
    .guide-link { text-align: center; margin-top: 6px; font-size: 12px; }
    .guide-link a { color: var(--amber); text-decoration: none; border-bottom: 1px dashed rgba(255, 213, 79, 0.6); }
    .guide-link a:hover { color: #fff3c0; }
    .guide-section { background: rgba(17, 17, 17, 0.9); border: 1px solid rgba(255, 202, 40, 0.25); padding: 14px; border-radius: 16px; margin: 14px 0 18px; box-shadow: 0 8px 20px rgba(0,0,0,0.35); }
    .guide-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .guide-title { font-size: 18px; margin: 0; color: var(--amber); letter-spacing: 0.3px; }
    .guide-subtext { margin: 4px 0 0; color: #d6d6d6; font-size: 13px; }
    .guide-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .guide-card { position: relative; padding: 14px 16px; border-radius: 16px; background: #151515; border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 6px 16px rgba(0,0,0,0.35); min-height: 180px; }
    .guide-card:not(:last-child)::after { content: "‚Üí"; position: absolute; right: -16px; top: 50%; transform: translateY(-50%); font-size: 22px; color: rgba(255, 255, 255, 0.45); }
    .guide-card .guide-number { font-size: 32px; font-weight: bold; margin-bottom: 6px; }
    .guide-card .guide-icon { font-size: 24px; margin-bottom: 6px; }
    .guide-card h4 { margin: 0 0 8px; font-size: 15px; letter-spacing: 0.3px; }
    .guide-card ul { margin: 0; padding-left: 18px; font-size: 12px; color: #dcdcdc; line-height: 1.5; }
    .guide-card.step-one { border-color: rgba(255, 202, 40, 0.5); box-shadow: 0 0 0 1px rgba(255, 202, 40, 0.2), 0 6px 16px rgba(0,0,0,0.35); }
    .guide-card.step-one .guide-number { color: #ffd54f; }
    .guide-card.step-one h4 { color: #ffe082; }
    .guide-card.step-two { border-color: rgba(100, 181, 246, 0.6); box-shadow: 0 0 0 1px rgba(100, 181, 246, 0.2), 0 6px 16px rgba(0,0,0,0.35); }
    .guide-card.step-two .guide-number { color: #90caf9; }
    .guide-card.step-two h4 { color: #bbdefb; }
    .guide-card.step-three { border-color: rgba(129, 199, 132, 0.6); box-shadow: 0 0 0 1px rgba(129, 199, 132, 0.2), 0 6px 16px rgba(0,0,0,0.35); }
    .guide-card.step-three .guide-number { color: #a5d6a7; }
    .guide-card.step-three h4 { color: #c8e6c9; }
    .guide-tip { margin-top: 12px; padding: 10px 12px; border-radius: 12px; background: rgba(255, 255, 255, 0.06); border: 1px dashed rgba(255, 255, 255, 0.2); font-size: 12px; color: #f0f0f0; }
    .guide-tip strong { color: #ffe082; }
    @media (max-width: 780px) {
      .guide-cards { grid-template-columns: 1fr; }
      .guide-card:not(:last-child)::after { content: "‚Üì"; right: 50%; top: auto; bottom: -18px; transform: translateX(50%); }
    }
    @media (max-width: 600px) { button { width: 100%; } .inline { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>
<div class="container" id="reportArea">
  <h1>KALKULATOR PROJEK MADU KELULUT</h1>
  <h2>Analisis Kewangan</h2>
  <div class="guide-link" id="guideLink" style="display:none;">
    <a href="#" id="showGuideLink">Tunjuk panduan</a>
  </div>
  <div class="meta" id="reportMeta">Versi kalkulator: v2.1</div>

  <p class="note">
    Hai semua! Kalkulator ini membantu penternak menilai sama ada projek madu kelulut berbaloi atau tidak dari sudut kewangan.
  </p>
  <p class="note">
    <strong>Arahan:</strong> Ikuti <strong>Langkah 1 hingga 3</strong>. Pilih <strong>Mod Ringkas</strong> jika mahu isi bilangan koloni terus atau <strong>Mod Terperinci</strong> jika mahu berdasarkan keluasan & kepadatan. Tekan <strong>"Kira Analisis"</strong> untuk lihat NPV, IRR, BCR, ROI, graf dan PDF.
  </p>

  <section class="guide-section" id="guideSection">
    <div class="guide-header">
      <div>
        <h3 class="guide-title">Cara Guna Kalkulator (3 Langkah)</h3>
        <p class="guide-subtext">Ikut langkah di bawah, kemudian tekan ‚ÄòKira Analisis‚Äô di Langkah 3.</p>
      </div>
      <button class="btn-ghost btn-inline" id="hideGuideBtn" type="button">Sembunyikan panduan</button>
    </div>
    <div class="guide-cards">
      <div class="guide-card step-one">
        <div class="guide-number">‚ë†</div>
        <div class="guide-icon">üêù</div>
        <h4>Isi Maklumat & Hasil</h4>
        <ul>
          <li>Bilangan koloni / keluasan</li>
          <li>Hasil madu per koloni</li>
          <li>Harga madu (RM/kg)</li>
        </ul>
      </div>
      <div class="guide-card step-two">
        <div class="guide-number">‚ë°</div>
        <div class="guide-icon">üí∞</div>
        <h4>Isi Kos</h4>
        <ul>
          <li>Modal awal (Tahun 0)</li>
          <li>Belanja setahun (input, upah, sewa)</li>
          <li>Lain-lain (sekali / setahun) jika ada</li>
        </ul>
      </div>
      <div class="guide-card step-three">
        <div class="guide-number">‚ë¢</div>
        <div class="guide-icon">üìÑ</div>
        <h4>Semak Keputusan & PDF</h4>
        <ul>
          <li>Untung Tahun 1, tahun pulang modal, harga madu minimum tak rugi</li>
          <li>NPV/IRR/BCR + jadual & graf</li>
          <li>Muat turun PDF ringkas/profesional</li>
        </ul>
      </div>
    </div>
    <div class="guide-tip"><strong>Tip:</strong> Jika tak pasti nilai sebenar, isi anggaran dahulu. Anda boleh ubah kemudian dan tekan ‚ÄòKira‚Äô semula.</div>
  </section>

  <details class="step" id="step1" data-step="1">
    <summary><span class="step-badge step-1">Langkah 1</span> Maklumat ladang & hasil (Bahagian A, B, B2)</summary>
    <div class="step-card">
      <details class="section" id="secA">
        <summary id="sectionA"><span class="section-badge section-a">A</span> Bahagian A: Maklumat Ladang</summary>
        <div class="section-body">
          <label>Nama penternak:
            <input id="farmerName" type="text">
          </label>
          <label>Nama Kampung (untuk laporan):
            <input id="villageName" type="text">
          </label>
          <label>No. telefon:
            <input id="phoneNumber" type="text">
          </label>
        </div>
      </details>

      <details class="section" id="secB">
        <summary id="sectionB"><span class="section-badge section-b">B</span> Bahagian B: Hasil Produk</summary>
        <div class="section-body">
          <div class="mode-row">
            <label class="pill"><input type="radio" name="mode" value="simple" id="modeSimple"> Mod Ringkas (Kampung)</label>
            <label class="pill"><input type="radio" name="mode" value="detailed" id="modeDetailed" checked> Mod Terperinci (Profesional)</label>
          </div>
          <div id="simpleMode" style="display:none;">
            <label>Bilangan koloni (isi terus): <span class="req-badge">WAJIB</span>
              <input id="coloniesDirect" class="req-input" type="number" min="0" step="1" value="30">
            </label>
            <div class="error-text" id="err-coloniesDirect"></div>
          </div>
          <div id="detailedMode">
            <label>Keluasan (ekar): <span class="req-badge">WAJIB</span>
              <input id="areaAcre" class="req-input" type="number" min="0" step="0.1" value="1">
            </label>
            <div class="error-text" id="err-areaAcre"></div>
            <label>Kepadatan koloni (koloni/ekar): <span class="req-badge">WAJIB</span>
              <input id="density" class="req-input" type="number" min="0" step="1" value="30">
            </label>
            <div class="error-text" id="err-density"></div>
            <div class="note" id="colonyEstimate">Anggaran bilangan koloni: 30</div>
          </div>

          <label>Hasil madu per koloni setahun (kg/koloni/tahun): <span class="req-badge">WAJIB</span>
            <input id="yieldPerColony" class="req-input" type="number" min="0" step="0.1" value="2.5">
            <small class="hint">Contoh anggaran: 1.5 ‚Äì 3.5 kg/koloni/tahun bergantung penjagaan & cuaca.</small>
          </label>
          <div class="error-text" id="err-yieldPerColony"></div>

          <div class="inline" style="margin-top:4px;">
            <label class="pill"><input type="checkbox" id="enableYear1LowerYield"> Tahun 1 hasil lebih rendah</label>
            <div style="max-width:180px;">
              <label>Faktor hasil Tahun 1 (%):
                <input id="year1YieldFactor" type="number" min="0" max="100" step="5" value="70">
              </label>
            </div>
          </div>

          <label>Harga jual madu kelulut (RM/kg): <span class="req-badge">WAJIB</span>
            <input id="price" class="req-input" type="number" min="0" step="1" value="200">
          </label>
          <div class="error-text" id="err-price"></div>
          <label>Hasil propolis (titis) per koloni setahun (RM/koloni/tahun):
            <input id="propIncomePerCol" type="number" min="0" step="1" value="30">
          </label>
          <label>Hasil sabun madu kelulut per koloni setahun (RM/koloni/tahun):
            <input id="soapIncomePerCol" type="number" min="0" step="1" value="20">
          </label>
          <label>Nama lain-lain produk (pilihan):
            <input id="otherProductName" type="text" placeholder="Contoh: Bee bread / minuman kesihatan madu kelulut">
          </label>
          <label>Hasil lain-lain produk per koloni setahun (RM/koloni/tahun):
            <input id="otherIncomePerCol" type="number" min="0" step="1" value="0">
          </label>
        </div>
      </details>

      <details class="section" id="secB2">
        <summary id="sectionB2"><span class="section-badge section-b2">B2</span> Bahagian B2: Risiko Penternakan (Mortaliti)</summary>
        <div class="section-body">
          <label>Kadar koloni mati/rosak setahun (%):
            <input id="mortalityRatePercent" type="number" min="0" max="100" step="0.5" value="0">
            <small class="hint">Anggaran peratus koloni yang mati atau rosak setahun. Jika 2 koloni rosak daripada 40, lebih kurang 5%.</small>
          </label>
          <label>Kos ganti koloni (RM/koloni mati):
            <input id="replacementColonyCost" type="number" min="0" step="50" value="1000">
            <small class="hint">Kos beli atau bina koloni baharu apabila koloni rosak.</small>
          </label>
        </div>
      </details>

      <details class="section" id="secExpansion">
        <summary>Pelan tambah koloni (pilihan)</summary>
        <div class="section-body">
          <div class="inline">
            <label class="pill"><input type="checkbox" id="enableExpansion"> Tambah koloni setiap tahun</label>
            <label class="pill"><input type="radio" name="expansionMode" value="increment" checked> +N koloni/tahun</label>
            <label class="pill"><input type="radio" name="expansionMode" value="percent"> +X% koloni/tahun</label>
          </div>
          <label>Tambah tetap (+N koloni/tahun):
            <input id="expansionIncrement" type="number" min="0" step="1" value="0">
          </label>
          <label>Tambah peratus (+X%/tahun):
            <input id="expansionPercent" type="number" min="0" step="1" value="0">
          </label>
          <p class="note">Kos tambah koloni akan dikira menggunakan kos pembinaan koloni sedia ada (RM/koloni).</p>
        </div>
      </details>

      <div class="inline" style="margin-top:10px;">
        <button class="btn-secondary btn-inline btn-next" data-next-step="step2">Seterusnya (Langkah 2)</button>
      </div>
    </div>
  </details>

  <details class="step" id="step2" data-step="2">
    <summary><span class="step-badge step-2">Langkah 2</span> Kos (Bahagian C ‚Äì F + kos tambahan)</summary>
    <div class="step-card">
      <details class="section" id="secC">
        <summary id="sectionC"><span class="section-badge section-c">C</span> Bahagian C: Kos Pembangunan (Tahun 0)</summary>
        <div class="section-body">
          <label>Pembersihan kawasan (RM/ekar, sekali ‚Äì tahun 0):
            <input id="clearCostPerAcre" type="number" min="0" step="50" value="1000">
          </label>
          <label>Pembinaan pagar (RM/ekar, sekali ‚Äì tahun 0):
            <input id="fenceCostPerAcre" type="number" min="0" step="50" value="1000">
          </label>
          <label>Pembinaan koloni kelulut (kotak + topping) (RM/koloni, tahun 0): <span class="req-badge">WAJIB</span>
            <input id="colonySetupCostPerColony" class="req-input" type="number" min="0" step="50" value="1000">
          </label>
          <div class="error-text" id="err-colonySetupCostPerColony"></div>
          <label>Bilangan alat penyedut madu bermotor (unit ‚Äì tahun 0):
            <input id="numExtractors" type="number" min="0" step="1" value="1">
          </label>
          <label>Kos satu alat penyedut madu bermotor (RM/unit):
            <input id="extractorUnitCost" type="number" min="0" step="10" value="200">
          </label>
          <label>Bilangan bekas simpanan madu (5kg):
            <input id="numContainers" type="number" min="0" step="1" value="1">
          </label>
          <label>Kos satu bekas simpanan madu 5kg (RM/unit):
            <input id="containerUnitCost" type="number" min="0" step="5" value="50">
          </label>
          <label>Kos pembangunan lain-lain (sekali ‚Äì Tahun 0) (RM):
            <input id="devCostOther0" type="number" min="0" step="10" value="0">
          </label>
          <div class="helper-box">
            <div class="hint-example"><strong>Contoh item (sekali beli):</strong></div>
            <ul class="hint-example" style="margin:6px 0 0 18px;">
              <li>Tikar bumbung log kelulut / kanopi (canvas/plywood)</li>
              <li>Bakul/tray pam madu (jika aset)</li>
              <li>Cat/berus/gergaji dan bahan bina awal</li>
            </ul>
          </div>
        </div>
      </details>

      <details class="section" id="secD">
        <summary id="sectionD"><span class="section-badge section-d">D</span> Bahagian D: Kos Bahan Input</summary>
        <div class="section-body">
          <small class="hint">Kos bahan input ialah barang yang habis guna untuk urus koloni & jualan (contoh gula/air gula, botol, label, plastik, sarung tangan, ubat/kawalan semut/perosak dan lain-lain).</small>
          <label>Kos kawalan serangga (RM/setahun):
            <input id="insectControlAnnual" type="number" min="0" step="10" value="100">
          </label>
          <label>Bahan habis pakai lain-lain (RM/setahun):
            <input id="otherOpexAnnual" type="number" min="0" step="10" value="0">
          </label>
          <div class="helper-box">
            <div class="hint-example"><strong>Contoh item (ulang beli):</strong></div>
            <ul class="hint-example" style="margin:6px 0 0 18px;">
              <li>Ethanol 95% (pembersihan)</li>
              <li>Gas butane</li>
              <li>Laminating/label koloni (jika bukan label botol)</li>
              <li>Marker & alat tulis, bahan kecil lain</li>
            </ul>
          </div>
          <div class="helper-box">
            <div class="hint-example"><strong>Cara kira setahun:</strong></div>
            <ul class="hint-example" style="margin:6px 0 0 18px;">
              <li>RM30/bulan ‚Üí RM360/setahun</li>
              <li>RM10/minggu ‚Üí ¬±RM520/setahun</li>
              <li>(Jika tidak pasti, guna anggaran konservatif.)</li>
            </ul>
          </div>
        </div>
      </details>

      <details class="section" id="secE">
        <summary id="sectionE"><span class="section-badge section-e">E</span> Bahagian E: Kos Tenaga Kerja</summary>
        <div class="section-body">
          <label>Kos tenaga kerja (RM/setahun):
            <input id="labourCostAnnual" type="number" min="0" step="50" value="6000">
          </label>
        </div>
      </details>

      <details class="section" id="secF">
        <summary id="sectionF"><span class="section-badge section-f">F</span> Bahagian F: Kos Pelbagai (Penyelenggaraan & Utiliti)</summary>
        <div class="section-body">
          <label>Penyelenggaraan pagar (RM/ekar setiap 3 tahun):
            <input id="fenceMaintPerAcre" type="number" min="0" step="10" value="300">
          </label>
          <label>Penyelenggaraan / alat ganti alat penyedut madu bermotor (RM/setahun):
            <input id="extractorMaintAnnual" type="number" min="0" step="10" value="50">
          </label>
          <label>Penggantian kotak koloni + kotak topping (RM/koloni setiap 2 tahun):
            <input id="colonyReplacementCostPerColony" type="number" min="0" step="10" value="50">
          </label>
          <label>Sewa tanah (RM/ekar setahun ‚Äì kos utiliti):
            <input id="landRentPerAcreAnnual" type="number" min="0" step="10" value="500">
          </label>
        </div>
      </details>

      <details class="section" id="secOptional">
        <summary>Kos tambahan pilihan (boleh tanda jika berkaitan)</summary>
        <div class="section-body">
          <label class="inline"><input type="checkbox" id="enablePackaging"> Aktifkan kos botol & label</label>
          <div id="packagingFields" style="display:none;">
            <label>Saiz botol (ml):
              <input id="bottleSizeMl" type="number" min="1" step="10" value="250">
            </label>
            <label>Kos botol (RM/botol):
              <input id="bottleCost" type="number" min="0" step="0.1" value="1.5">
            </label>
            <label>Kos label (RM/botol):
              <input id="labelCost" type="number" min="0" step="0.1" value="0.5">
            </label>
            <label>Kos pembungkusan tambahan (RM/botol):
              <input id="packagingCost" type="number" min="0" step="0.1" value="0.3">
            </label>
          </div>

          <label class="inline"><input type="checkbox" id="enableTransport"> Aktifkan kos pengangkutan/pos</label>
          <div id="transportFields" style="display:none;">
            <div class="inline">
              <label class="pill"><input type="radio" name="transportMode" value="perKg" checked> Berdasarkan kg madu</label>
              <label class="pill"><input type="radio" name="transportMode" value="annual"> Jumlah setahun</label>
            </div>
            <label>Jika per kg: kos pengangkutan (RM/kg madu):
              <input id="transportCostPerKg" type="number" min="0" step="0.1" value="0">
            </label>
            <label>Jika jumlah setahun: kos pengangkutan (RM/tahun):
              <input id="transportCostAnnual" type="number" min="0" step="10" value="0">
            </label>
          </div>

          <label class="inline"><input type="checkbox" id="enableFeeding"> Aktifkan kos makanan tambahan/umpan</label>
          <div id="feedingFields" style="display:none;">
            <label>Kos makanan tambahan/umpan (RM/setahun):
              <input id="feedingCostAnnual" type="number" min="0" step="10" value="0">
              <small class="hint">Makanan tambahan/umpan ialah gula/air gula/pati. Isi jumlah keseluruhan setahun.</small>
            </label>
          </div>

          <label class="inline"><input type="checkbox" id="enableCompliance"> Aktifkan kos pensijilan/ujian/lesen</label>
          <div id="complianceFields" style="display:none;">
            <label>Kos pensijilan/ujian/lesen (RM/setahun):
              <input id="complianceCostAnnual" type="number" min="0" step="10" value="0">
            </label>
          </div>
        </div>
      </details>

      <details class="section" id="secPreview">
        <summary>Pratonton cepat (anggaran Tahun 1)</summary>
        <div class="section-body">
          <div class="three-cards">
            <div class="mini-card"><h4>Anggaran madu Tahun 1</h4><div class="badge" id="previewHoney">-</div><small class="note">Termasuk faktor hasil Tahun 1 & mortaliti Tahun 1.</small></div>
            <div class="mini-card"><h4>Anggaran botol (jika pembungkusan)</h4><div class="badge" id="previewBottles">-</div><small class="note">Berdasarkan saiz botol & hasil madu Tahun 1.</small></div>
            <div class="mini-card"><h4>Kos tahunan Tahun 1 (RM)</h4><div class="badge" id="previewCost">-</div><small class="note">Kos asas + opsyen + kontinjensi.</small></div>
          </div>
        </div>
      </details>

      <div class="inline" style="margin-top:10px;">
        <button class="btn-secondary btn-inline btn-next" data-next-step="step3">Seterusnya (Langkah 3)</button>
      </div>
    </div>
  </details>

  <details class="step" id="step3" data-step="3">
    <summary><span class="step-badge step-3">Langkah 3</span> Analisis & Keputusan</summary>
    <div class="step-card">
      <details class="section" id="secG">
        <summary id="sectionG"><span class="section-badge section-g">G</span> Bahagian G: Tetapan Kiraan & Tindakan</summary>
        <div class="section-body">
          <div class="note small">Tetapan kiraan ialah perkara yang mengawal analisis seperti tempoh, kadar diskaun dan anggaran kos/hasil tambahan.</div>
          <label>Kadar Diskaun (% setahun): <span class="req-badge">WAJIB</span>
            <input id="discountRate" class="req-input" type="number" min="0" step="0.1" value="3">
            <small class="hint">Nilai duit berubah ikut masa. Jika rasa simpan duit/untung alternatif 3% setahun, isi 3%.</small>
          </label>
          <div class="error-text" id="err-discountRate"></div>
          <label>Tempoh Analisis (tahun ekonomi projek): <span class="req-badge">WAJIB</span>
            <input id="duration" class="req-input" type="number" min="1" step="1" value="7">
            <small class="hint">Berapa tahun anda mahu kira pulangan projek ini.</small>
          </label>
          <div class="error-text" id="err-duration"></div>

          <label>Kontinjensi (% atas kos tahunan):
            <input id="contingencyPercent" type="number" min="0" max="100" step="0.5" value="10">
            <small class="hint">Kos tak dijangka (contoh koloni rosak, alat kecil, minyak tambahan). Julat biasa 5%‚Äì15%.</small>
          </label>

          <label>Kenaikan kos tahunan (inflasi kos) %:
            <input id="costEscalationPercent" type="number" min="0" step="0.1" value="0">
            <small class="hint">Jika kos bahan/upah naik setiap tahun, isi anggaran peratus.</small>
          </label>
          <label>Kenaikan harga madu tahunan (inflasi harga) %:
            <input id="priceEscalationPercent" type="number" min="0" step="0.1" value="0">
            <small class="hint">Jika harga madu dijangka naik setiap tahun, isi anggaran peratus.</small>
          </label>

          <div id="errorSummary" class="error-summary">Sila betulkan medan yang merah.</div>

          <div class="inline" style="margin-top:8px; gap:8px; flex-wrap: wrap;">
            <button class="btn-primary btn-inline" id="btnRun">Kira Analisis</button>
            <button class="btn-secondary btn-inline" id="btnReset">Tetapkan Semula / Kosongkan</button>
            <button class="btn-ghost btn-inline" id="btnDemo">Isi Contoh</button>
            <button class="btn-ghost btn-inline" id="btnSave">Simpan</button>
            <button class="btn-secondary btn-inline" id="btnClearSave">Padam Simpanan</button>
          </div>
          <div class="note" id="statusMessage"></div>
          <p class="note">Auto-simpan akan berlaku secara tertunda (beberapa saat) setiap kali anda ubah nilai. Simpanan disimpan di pelayar (localStorage).</p>
        </div>
      </details>

      <div class="info-panels" id="infoPanels">
        <details class="info-panel" id="infoMonthly">
          <summary>Ringkasan Pantas: Anggaran Bulanan (Tahun 1)</summary>
          <div class="info-panel-body">
            <div class="three-cards">
              <div class="mini-card"><h4>Anggaran Untung Bersih Sebulan (RM)</h4><div class="badge" id="monthlyNetValue">-</div></div>
              <div class="mini-card"><h4>Anggaran Jualan Sebulan (RM)</h4><div class="badge" id="monthlyRevenueValue">-</div></div>
              <div class="mini-card"><h4>Anggaran Kos Operasi Sebulan (RM)</h4><div class="badge" id="monthlyCostValue">-</div></div>
            </div>
            <p class="note small" id="monthlyMessage"></p>
            <p class="note small">Ini anggaran duit lebihan yang tinggal selepas tolak kos. Kiraan ini ambil angka Tahun 1 dan bahagi 12. Kalau hasil ikut musim, angka ini sebagai panduan.</p>
            <p class="note small">Anggaran jualan dan belanja bulanan memudahkan rancangan duit masuk-keluar.</p>
          </div>
        </details>

        <details class="info-panel" id="infoBottles" style="display:none;">
          <summary>Anggaran Botol (Jika Jual Dalam Botol)</summary>
          <div class="info-panel-body">
            <div class="three-cards">
              <div class="mini-card"><h4>Anggaran Botol Sebulan</h4><div class="badge" id="monthlyBottleValue">-</div></div>
              <div class="mini-card"><h4>Anggaran Botol Setahun</h4><div class="badge" id="annualBottleValue">-</div></div>
            </div>
            <p class="note small">Ini anggaran bilangan botol yang boleh diisi dan dijual berdasarkan jumlah madu dianggarkan.</p>
            <p class="note small">Tip: Isi kos botol dan label supaya untung lebih tepat.</p>
          </div>
        </details>

        <details class="info-panel" id="infoAssumptions">
          <summary>Ringkasan Andaian (berdasarkan input anda)</summary>
          <div class="info-panel-body">
            <p class="note small" id="assumptionIdentity">Nama penternak: - | Nama kampung: -</p>
            <p class="note small" id="assumptionText"></p>
          </div>
        </details>

        <details class="info-panel" id="infoGuide">
          <summary>Cara Baca Keputusan (mudah)</summary>
          <div class="info-panel-body">
            <div class="helper-box">
              <p class="note small"><strong>Nilai Kini Bersih (NPV)</strong><br>Apa maksud: Lebihan nilai untung selepas ambil kira nilai duit ikut masa (kadar diskaun).<br>Cara baca: Jika NPV &gt; 0, biasanya projek berbaloi pada tetapan semasa.<br>Contoh: NPV RM5,000 bermaksud selepas kira nilai duit ikut masa, projek masih ada lebihan lebih kurang RM5,000.</p>
              <p class="note small"><strong>Kadar Pulangan Dalaman (IRR)</strong><br>Apa maksud: Anggaran kadar untung projek.<br>Cara baca: Jika IRR lebih tinggi daripada kadar diskaun, projek biasanya lebih menarik.<br>Contoh: IRR 18% lebih tinggi daripada diskaun 3%.</p>
              <p class="note small"><strong>Nisbah Faedah-Kos (BCR)</strong><br>Apa maksud: Setiap RM1 kos memberi berapa RM manfaat.<br>Cara baca: Jika BCR &gt; 1, manfaat melebihi kos.<br>Contoh: BCR 1.30 = RM1 kos ‚Üí RM1.30 manfaat.</p>
              <p class="note small"><strong>Pulangan atas Kos (ROI)</strong><br>Apa maksud: Peratus untung berbanding jumlah kos.<br>Cara baca: Lebih tinggi, lebih baik (tetapi masih bergantung risiko).<br>Contoh: ROI 50% bermaksud untung kira-kira separuh daripada jumlah kos (mengikut tempoh analisis).</p>
              <p class="note small"><strong>Tahun pulang modal</strong><br>Apa maksud: Tahun bila modal permulaan kembali apabila Aliran Tunai Terkumpul mula positif.<br>Contoh: Jika pulang modal Tahun 4, biasanya sekitar tahun ke-4 modal awal sudah kembali.</p>
              <p class="note small"><strong>Harga madu minimum tak rugi</strong><br>Apa maksud: Harga madu paling rendah supaya projek tidak rugi dengan hasil &amp; kos semasa.<br>Contoh: Jika minimum RM120/kg dan harga pasaran RM150/kg, projek biasanya lebih selamat.</p>
            </div>
          </div>
        </details>

        <details class="info-panel" id="infoTarget">
          <summary>Sasaran Pendapatan (Pilihan)</summary>
          <div class="info-panel-body">
            <p class="note small">Masukkan sasaran pendapatan bersih sebulan (contoh RM500, RM1000). Kalkulator akan anggarkan berapa koloni diperlukan berdasarkan hasil dan kos yang anda isi.</p>
            <p class="note small">Nota: Ini anggaran kasar. Jika kos atau hasil berubah, bilangan koloni yang diperlukan juga akan berubah.</p>
            <label for="targetMonthlyNet">Sasaran pendapatan bersih (RM/bulan):</label>
            <input id="targetMonthlyNet" type="number" min="0" step="50" value="0">
            <button class="btn-secondary btn-inline" id="btnTargetMonthly" type="button">Anggar bilangan koloni</button>
            <div class="note small" id="targetMonthlyResult"></div>
          </div>
        </details>
      </div>

      <details class="section" id="secResults">
        <summary>Keputusan & Ringkasan</summary>
        <div class="section-body">
          <div id="results" class="summary"></div>
        </div>
      </details>

      <details class="section" id="secH">
        <summary id="sectionH"><span class="section-badge section-h">H</span> Bahagian H: Graf Visual</summary>
        <div class="section-body">
          <p class="note">Graf membantu melihat aliran tunai, bila projek pulang modal dan kesan perubahan harga madu.</p>
          <canvas id="cfChart" height="180"></canvas>
          <canvas id="cumCfChart" height="180"></canvas>
          <canvas id="npvSensChart" height="180"></canvas>
          <canvas id="tornadoChart" height="200"></canvas>

          <div style="margin-top:16px;" class="inline">
            <button class="btn-secondary" onclick="downloadPdfRingkasClean()">üìÑ Muat Turun PDF Ringkas</button>
            <button class="btn-ghost" onclick="downloadPDF()">üìÑ PDF Imej Skrin (Opsyen)</button>
            <button class="btn-secondary" onclick="downloadProfessionalPDF()">üìÑ Muat Turun PDF Profesional (Lengkap)</button>
            <button class="btn-ghost" onclick="downloadCashflowCSV()">‚¨áÔ∏è Muat Turun CSV ‚Äì Aliran Tunai</button>
            <button class="btn-ghost" onclick="downloadSensitivityCSV()">‚¨áÔ∏è Muat Turun CSV ‚Äì Sensitiviti</button>
          </div>
        </div>
      </details>
    </div>
  </details>
  <div class="disclaimer">
    <p class="note" style="font-size:10px; color:#bbbbbb; line-height:1.4;">
      <strong>Penafian ‚Äì Bahasa Melayu:</strong><br>
      Kalkulator ini disediakan untuk tujuan pembelajaran dan anggaran kasar sahaja.
      Nilai kos, hasil dan pulangan sebenar mungkin berbeza mengikut lokasi, keadaan ternakan,
      kemahiran pengurusan, harga pasaran serta faktor-faktor lain di luar kawalan pengeluar.
      Pengguna dinasihatkan mendapatkan nasihat lanjut daripada pegawai atau pakar berkaitan
      sebelum membuat keputusan pelaburan. Penyedia kalkulator tidak bertanggungjawab
      terhadap sebarang kerugian, kerosakan atau tuntutan yang timbul daripada penggunaan
      kalkulator ini.
    </p>

    <p class="note" style="font-size:10px; color:#999999; text-align:center;">
      &copy; 2025 Assis Kamu, Universiti Malaysia Sabah. Hak cipta terpelihara.
    </p>
  </div>
</div>

<!-- PDF libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let cfChartInstance = null;
  let cumCfChartInstance = null;
  let npvSensChartInstance = null;
  let tornadoChartInstance = null;

  const storageKey = "kelulutCalc_v2_state";
  const currencyFmt = new Intl.NumberFormat('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  function fmtNumber(x, decimals = 2) {
    if (x === null || x === undefined || isNaN(x)) return "-";
    const formatter = new Intl.NumberFormat('ms-MY', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    return formatter.format(Number(x));
  }
  function numOrZero(x) {
    const num = Number(x);
    return Number.isFinite(num) ? num : 0;
  }
  function fmtRM(x) {
    return currencyFmt.format(numOrZero(x));
  }
  function coloredFmt(x, decimals = 2) {
    if (x === null || isNaN(x)) return "-";
    const formatted = fmtNumber(x, decimals);
    const color = x < 0 ? '#ff5252' : '#f1f1f1';
    return `<span style="color:${color};">${formatted}</span>`;
  }
  function coloredFmtRM(x) {
    const value = numOrZero(x);
    const formatted = fmtRM(value);
    const color = value < 0 ? '#ff5252' : '#f1f1f1';
    return `<span style="color:${color};">${formatted}</span>`;
  }
  function clamp(value, min, max) { return Math.min(Math.max(value, min), max); }
  function inputsAreIncomplete(params) {
    return params.colonies <= 0 || params.honeyYieldPerColony <= 0 || params.honeyPrice <= 0;
  }

  const defaultState = {
    mode: "detailed",
    farmerName: "",
    villageName: "",
    phoneNumber: "",
    coloniesDirect: 30,
    areaAcre: 1,
    density: 30,
    yieldPerColony: 2.5,
    price: 200,
    propIncomePerCol: 30,
    soapIncomePerCol: 20,
    otherProductName: "",
    otherIncomePerCol: 0,
    clearCostPerAcre: 1000,
    fenceCostPerAcre: 1000,
    colonySetupCostPerColony: 1000,
    numExtractors: 1,
    extractorUnitCost: 200,
    numContainers: 1,
    containerUnitCost: 50,
    devCostOther0: 0,
    insectControlAnnual: 100,
    otherOpexAnnual: 0,
    labourCostAnnual: 6000,
    fenceMaintPerAcre: 300,
    extractorMaintAnnual: 50,
    colonyReplacementCostPerColony: 50,
    landRentPerAcreAnnual: 500,
    discountRate: 3,
    duration: 7,
    mortalityRatePercent: 0,
    replacementColonyCost: 1000,
    costEscalationPercent: 0,
    priceEscalationPercent: 0,
    enablePackaging: false,
    bottleSizeMl: 250,
    bottleCost: 1.5,
    labelCost: 0.5,
    packagingCost: 0.3,
    enableTransport: false,
    transportMode: "perKg",
    transportCostPerKg: 0,
    transportCostAnnual: 0,
    enableFeeding: false,
    feedingCostAnnual: 0,
    enableCompliance: false,
    complianceCostAnnual: 0,
    enableYear1LowerYield: false,
    year1YieldFactor: 70,
    contingencyPercent: 10,
    enableExpansion: false,
    expansionMode: "increment",
    expansionIncrement: 0,
    expansionPercent: 0,
    targetMonthlyNet: 0
  };

  function npv(rate, cashflows) {
    return cashflows.reduce((acc, cf, t) => acc + cf / Math.pow(1 + rate, t), 0);
  }

  function irr(cashflows, guess = 0.1) {
    let rate = guess;
    for (let i = 0; i < 100; i++) {
      let npvVal = 0;
      let dNpv = 0;
      for (let t = 0; t < cashflows.length; t++) {
        const denom = Math.pow(1 + rate, t);
        npvVal += cashflows[t] / denom;
        if (t > 0) dNpv -= t * cashflows[t] / (denom * (1 + rate));
      }
      if (!isFinite(npvVal) || !isFinite(dNpv) || Math.abs(dNpv) < 1e-10) break;
      const newRate = rate - npvVal / dNpv;
      if (!isFinite(newRate)) break;
      if (Math.abs(newRate - rate) < 1e-7) return newRate;
      rate = newRate;
    }
    return rate;
  }

  function safeIRR(cashflows) {
    const hasPos = cashflows.some(v => v > 0);
    const hasNeg = cashflows.some(v => v < 0);
    if (!hasPos || !hasNeg) return null;
    const rate = irr(cashflows);
    if (!isFinite(rate) || rate < -0.99 || rate > 5) return null;
    return rate * 100;
  }

  function coloniesPlanAtYear(params, t) {
    const base = params.colonies;
    if (t <= 1 || !params.enableExpansion) return Math.max(0, base);
    if (params.expansionMode === 'percent') {
      return Math.max(0, Math.round(base * Math.pow(1 + params.expansionPercent, t - 1)));
    }
    return Math.max(0, base + (t - 1) * params.expansionIncrement);
  }

  function computeScenario(params) {
    const {
      T,
      colonies,
      honeyYieldPerColony,
      baseHoneyPrice,
      propIncomePerColony,
      soapIncomePerColony,
      otherIncomePerColony,
      devCost0,
      baseInputAnnual,
      baseLabourAnnual,
      baseMiscAnnual,
      bottleSizeMl,
      bottleCost,
      labelCost,
      packagingCost,
      enablePackaging,
      enableTransport,
      transportMode,
      transportCostPerKg,
      transportCostAnnual,
      enableFeeding,
      feedingCostAnnual,
      enableCompliance,
      complianceCostAnnual,
      mortalityRate,
      replacementColonyCost,
      costEscalation,
      priceEscalation,
      discountRate,
      priceFactor,
      contingencyRate,
      enableYear1LowerYield,
      year1YieldFactor,
      enableExpansion,
      expansionMode,
      expansionIncrement,
      expansionPercent,
      colonySetupCostPerColony
    } = params;

    let cashflows = [];
    let benefits = [];
    let totalCosts = [];
    let effectiveColoniesSeries = [];
    let pvBenefits = 0;
    let pvCosts = 0;
    let cumCF = 0;
    let paybackYear = null;

    for (let t = 0; t <= T; t++) {
      const yearFactor = t > 0 ? Math.pow(1 + costEscalation, t - 1) : 1;
      const price = t > 0 ? baseHoneyPrice * priceFactor * Math.pow(1 + priceEscalation, t - 1) : baseHoneyPrice * priceFactor;
      const plannedColonies = coloniesPlanAtYear({ colonies, enableExpansion, expansionMode, expansionIncrement, expansionPercent }, t);
      const effectiveColonies = t === 0 ? colonies : Math.max(0, plannedColonies * Math.pow(1 - mortalityRate, Math.max(0, t - 1)));
      effectiveColoniesSeries.push(effectiveColonies);

      let benefit = 0;
      if (t > 0) {
        const yieldFactor = enableYear1LowerYield && t === 1 ? year1YieldFactor : 1;
        const honeyKg = effectiveColonies * honeyYieldPerColony * yieldFactor;
        const honeyRev = honeyKg * price;
        const propRev  = effectiveColonies * propIncomePerColony * yieldFactor;
        const soapRev  = effectiveColonies * soapIncomePerColony * yieldFactor;
        const otherRev = effectiveColonies * otherIncomePerColony * yieldFactor;
        benefit = honeyRev + propRev + soapRev + otherRev;
      }

      let directCost = 0;
      if (t === 0) {
        directCost = devCost0;
      } else {
        const yieldFactor = enableYear1LowerYield && t === 1 ? year1YieldFactor : 1;
        const honeyKg = effectiveColonies * honeyYieldPerColony * yieldFactor;
        let packagingAnnual = 0;
        if (enablePackaging && honeyKg > 0) {
          const bottles = Math.ceil((honeyKg * 1000) / bottleSizeMl);
          packagingAnnual = bottles * (bottleCost + labelCost + packagingCost);
        }

        let transportAnnual = 0;
        if (enableTransport) {
          transportAnnual = transportMode === "perKg" ? honeyKg * transportCostPerKg : transportCostAnnual;
        }

        const feedingAnnual = enableFeeding ? feedingCostAnnual : 0;
        const complianceAnnual = enableCompliance ? complianceCostAnnual : 0;
        const mortalityReplacement = effectiveColonies * mortalityRate * replacementColonyCost;

        let costNewColonies = 0;
        if (t > 1 && enableExpansion) {
          const prevPlan = coloniesPlanAtYear({ colonies, enableExpansion, expansionMode, expansionIncrement, expansionPercent }, t - 1);
          const delta = Math.max(0, plannedColonies - prevPlan);
          costNewColonies = delta * colonySetupCostPerColony;
        }

        const annualBase = baseInputAnnual + baseLabourAnnual + baseMiscAnnual;
        const annualOption = packagingAnnual + transportAnnual + feedingAnnual + complianceAnnual + mortalityReplacement + costNewColonies;
        directCost = (annualBase + annualOption) * yearFactor;
      }

      const contingency = directCost * contingencyRate;
      const totalCost = directCost + contingency;
      const cf = benefit - totalCost;

      cashflows.push(cf);
      benefits.push(benefit);
      totalCosts.push(totalCost);

      cumCF += cf;
      if (paybackYear === null && cumCF >= 0 && t > 0) paybackYear = t;

      const df = Math.pow(1 + discountRate, t);
      pvBenefits += benefit / df;
      pvCosts += totalCost / df;
    }

    const npvVal = npv(discountRate, cashflows);
    const irrVal = safeIRR(cashflows);
    const bcrVal = pvCosts > 0 ? pvBenefits / pvCosts : null;

    return {
      priceFactor,
      cashflows,
      benefits,
      totalCosts,
      npv: npvVal,
      irr: irrVal,
      bcr: bcrVal,
      paybackYear,
      effectiveColoniesSeries
    };
  }

  function computeBreakEvenHoneyPrice(params) {
    const { baseHoneyPrice } = params;
    let low = 0;
    let high = baseHoneyPrice * 5 + 200;

    const evalPrice = (price) => {
      const scenario = computeScenario({ ...params, baseHoneyPrice: price, priceFactor: 1 });
      return scenario.npv;
    };

    let lowNpv = evalPrice(low);
    let highNpv = evalPrice(high);

    if (lowNpv === null || highNpv === null) return null;
    if (lowNpv > 0) return 0;
    if (highNpv < 0) return null;

    for (let i = 0; i < 40; i++) {
      const mid = (low + high) / 2;
      const midNpv = evalPrice(mid);
      if (Math.abs(midNpv) < 1e-2) return mid;
      if (midNpv > 0) {
        high = mid;
        highNpv = midNpv;
      } else {
        low = mid;
        lowNpv = midNpv;
      }
    }
    return (low + high) / 2;
  }

  function setValue(id, val) {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.type === 'checkbox') {
      el.checked = Boolean(val);
    } else if (el.type === 'radio') {
      const opt = document.querySelector(`input[name="${el.name}"][value="${val}"]`);
      if (opt) opt.checked = true;
    } else {
      el.value = val;
    }
  }

  function toggleModeUI() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    document.getElementById('simpleMode').style.display = mode === 'simple' ? 'block' : 'none';
    document.getElementById('detailedMode').style.display = mode === 'detailed' ? 'block' : 'none';
    updateColonyEstimate();
  }

  function toggleOptionalSections() {
    document.getElementById('packagingFields').style.display = document.getElementById('enablePackaging').checked ? 'block' : 'none';
    document.getElementById('transportFields').style.display = document.getElementById('enableTransport').checked ? 'block' : 'none';
    document.getElementById('feedingFields').style.display = document.getElementById('enableFeeding').checked ? 'block' : 'none';
    document.getElementById('complianceFields').style.display = document.getElementById('enableCompliance').checked ? 'block' : 'none';
    const transportMode = document.querySelector('input[name="transportMode"]:checked').value;
    document.getElementById('transportCostPerKg').parentElement.style.display = transportMode === 'perKg' ? 'block' : 'none';
    document.getElementById('transportCostAnnual').parentElement.style.display = transportMode === 'annual' ? 'block' : 'none';
  }

  function updateColonyEstimate() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    if (mode === 'detailed') {
      const area = parseFloat(document.getElementById('areaAcre').value) || 0;
      const density = parseFloat(document.getElementById('density').value) || 0;
      const colonies = Math.max(0, Math.round(area * density));
      document.getElementById('colonyEstimate').textContent = `Anggaran bilangan koloni: ${fmtNumber(colonies,0)}`;
    } else {
      document.getElementById('colonyEstimate').textContent = '';
    }
  }

  function setError(id, message) {
    const err = document.getElementById(`err-${id}`);
    const input = document.getElementById(id);
    if (err) err.textContent = message || '';
    if (input) input.classList.toggle('invalid', Boolean(message));
  }

  function validateInputs() {
    let valid = true;
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const requiredMandatory = new Set(['yieldPerColony', 'price', 'discountRate', 'duration', 'colonySetupCostPerColony']);
    const requiredNonZero = new Set(['yieldPerColony', 'price', 'duration', 'colonySetupCostPerColony']);
    const required = [
      { id: 'yieldPerColony', min: 0 },
      { id: 'price', min: 0 },
      { id: 'discountRate', min: 0, max: 100 },
      { id: 'duration', min: 1, max: 30 },
      { id: 'mortalityRatePercent', min: 0, max: 100 },
      { id: 'contingencyPercent', min: 0, max: 100 },
      { id: 'devCostOther0', min: 0 },
      { id: 'otherOpexAnnual', min: 0 },
      { id: 'colonySetupCostPerColony', min: 0 }
    ];
    if (mode === 'detailed') {
      required.push({ id: 'areaAcre', min: 0 }, { id: 'density', min: 0 });
      requiredMandatory.add('areaAcre');
      requiredMandatory.add('density');
      requiredNonZero.add('areaAcre');
      requiredNonZero.add('density');
    } else {
      required.push({ id: 'coloniesDirect', min: 0 });
      requiredMandatory.add('coloniesDirect');
      requiredNonZero.add('coloniesDirect');
    }

    required.forEach(f => {
      const rawVal = document.getElementById(f.id).value.trim();
      if (requiredMandatory.has(f.id) && rawVal === '') {
        setError(f.id, 'Ruangan ini wajib diisi');
        valid = false;
        return;
      }
      const val = parseFloat(rawVal);
      if (requiredNonZero.has(f.id) && (!isFinite(val) || val === 0)) {
        setError(f.id, 'Ruangan ini wajib diisi');
        valid = false;
        return;
      }
      if (isNaN(val) || val < f.min || (f.max !== undefined && val > f.max)) {
        const limitText = f.max !== undefined ? `${f.min} - ${f.max}` : `>= ${f.min}`;
        setError(f.id, 'Isi nombor sah (' + limitText + ').');
        valid = false;
      } else {
        setError(f.id, '');
      }
    });

    if (document.getElementById('enablePackaging').checked) {
      const bottleSize = parseFloat(document.getElementById('bottleSizeMl').value);
      if (isNaN(bottleSize) || bottleSize < 1) {
        setError('bottleSizeMl', 'Saiz botol mesti sekurang-kurangnya 1 ml.');
        valid = false;
      }
    } else {
      setError('bottleSizeMl', '');
    }

    const errorSummary = document.getElementById('errorSummary');
    errorSummary.style.display = valid ? 'none' : 'block';
    return valid;
  }

  function buildParams() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const areaAcre = parseFloat(document.getElementById('areaAcre').value) || 0;
    const density = parseFloat(document.getElementById('density').value) || 0;
    const coloniesDirect = parseFloat(document.getElementById('coloniesDirect').value) || 0;
    const colonies = mode === 'simple' ? Math.max(0, Math.round(coloniesDirect)) : Math.max(0, Math.round(areaAcre * density));

    const honeyYieldPerColony = parseFloat(document.getElementById('yieldPerColony').value) || 0;
    const honeyPrice = parseFloat(document.getElementById('price').value) || 0;
    let propIncomePerCol = parseFloat(document.getElementById('propIncomePerCol').value); if (isNaN(propIncomePerCol)) propIncomePerCol = 0;
    let soapIncomePerCol = parseFloat(document.getElementById('soapIncomePerCol').value); if (isNaN(soapIncomePerCol)) soapIncomePerCol = 0;
    let otherIncomePerCol = parseFloat(document.getElementById('otherIncomePerCol').value); if (isNaN(otherIncomePerCol)) otherIncomePerCol = 0;

    const clearCostPerAcre = parseFloat(document.getElementById('clearCostPerAcre').value) || 0;
    const fenceCostPerAcre = parseFloat(document.getElementById('fenceCostPerAcre').value) || 0;
    const colonySetupCostPerColony = parseFloat(document.getElementById('colonySetupCostPerColony').value) || 0;
    const numExtractors = parseFloat(document.getElementById('numExtractors').value) || 0;
    const extractorUnitCost = parseFloat(document.getElementById('extractorUnitCost').value) || 0;
    const numContainers = parseFloat(document.getElementById('numContainers').value) || 0;
    const containerUnitCost = parseFloat(document.getElementById('containerUnitCost').value) || 0;
    const devCostOther0 = parseFloat(document.getElementById('devCostOther0').value) || 0;

    const insectControlAnnual = parseFloat(document.getElementById('insectControlAnnual').value) || 0;
    const otherOpexAnnual = parseFloat(document.getElementById('otherOpexAnnual').value) || 0;
    const labourAnnual = parseFloat(document.getElementById('labourCostAnnual').value) || 0;
    const fenceMaintPerAcre = parseFloat(document.getElementById('fenceMaintPerAcre').value) || 0;
    const extractorMaintAnnual = parseFloat(document.getElementById('extractorMaintAnnual').value) || 0;
    const colonyReplaceCostPerCol = parseFloat(document.getElementById('colonyReplacementCostPerColony').value) || 0;
    const landRentPerAcreAnnual = parseFloat(document.getElementById('landRentPerAcreAnnual').value) || 0;

    const T = clamp(parseInt(document.getElementById('duration').value) || 0, 1, 30);
    const discountRate = clamp((parseFloat(document.getElementById('discountRate').value) || 0), 0, 100) / 100;
    const contingencyRate = clamp((parseFloat(document.getElementById('contingencyPercent').value) || 0), 0, 100) / 100;

    const mortalityRate = clamp((parseFloat(document.getElementById('mortalityRatePercent').value) || 0), 0, 100) / 100;
    const replacementColonyCost = parseFloat(document.getElementById('replacementColonyCost').value) || 0;
    const costEscalation = (parseFloat(document.getElementById('costEscalationPercent').value) || 0) / 100;
    const priceEscalation = (parseFloat(document.getElementById('priceEscalationPercent').value) || 0) / 100;

    const enablePackaging = document.getElementById('enablePackaging').checked;
    const bottleSizeMl = parseFloat(document.getElementById('bottleSizeMl').value) || 250;
    const bottleCost = parseFloat(document.getElementById('bottleCost').value) || 0;
    const labelCost = parseFloat(document.getElementById('labelCost').value) || 0;
    const packagingCost = parseFloat(document.getElementById('packagingCost').value) || 0;

    const enableTransport = document.getElementById('enableTransport').checked;
    const transportMode = document.querySelector('input[name="transportMode"]:checked').value;
    const transportCostPerKg = parseFloat(document.getElementById('transportCostPerKg').value) || 0;
    const transportCostAnnual = parseFloat(document.getElementById('transportCostAnnual').value) || 0;

    const enableFeeding = document.getElementById('enableFeeding').checked;
    const feedingCostAnnual = parseFloat(document.getElementById('feedingCostAnnual').value) || 0;

    const enableCompliance = document.getElementById('enableCompliance').checked;
    const complianceCostAnnual = parseFloat(document.getElementById('complianceCostAnnual').value) || 0;

    const devCostClearing = areaAcre * clearCostPerAcre;
    const devCostFence = areaAcre * fenceCostPerAcre;
    const devCostColonies = colonies * colonySetupCostPerColony;
    const devCostExtract = numExtractors * extractorUnitCost;
    const devCostCont = numContainers * containerUnitCost;
    const devCost0 = devCostClearing + devCostFence + devCostColonies + devCostExtract + devCostCont + devCostOther0;

    const annualFenceMaintEq = areaAcre * fenceMaintPerAcre / 3;
    const annualColonyReplaceEq = colonies * colonyReplaceCostPerCol / 2;
    const baseInputAnnual = annualFenceMaintEq + annualColonyReplaceEq + extractorMaintAnnual + insectControlAnnual + otherOpexAnnual;
    const baseLabourAnnual = labourAnnual;
    const baseMiscAnnual = areaAcre * landRentPerAcreAnnual;

    const enableYear1LowerYield = document.getElementById('enableYear1LowerYield').checked;
    const year1YieldFactor = clamp((parseFloat(document.getElementById('year1YieldFactor').value) || 70) / 100, 0, 1.5);

    const enableExpansion = document.getElementById('enableExpansion').checked;
    const expansionMode = document.querySelector('input[name="expansionMode"]:checked').value;
    const expansionIncrement = parseFloat(document.getElementById('expansionIncrement').value) || 0;
    const expansionPercent = ((parseFloat(document.getElementById('expansionPercent').value) || 0) / 100);

    return {
      mode,
      colonies,
      areaAcre,
      density,
      honeyYieldPerColony,
      honeyPrice,
      propIncomePerCol,
      soapIncomePerCol,
      otherIncomePerCol,
      otherProductName: document.getElementById('otherProductName').value.trim(),
      devCost0,
      devCostOther0,
      baseInputAnnual,
      otherOpexAnnual,
      baseLabourAnnual,
      baseMiscAnnual,
      T,
      discountRate,
      mortalityRate,
      replacementColonyCost,
      costEscalation,
      priceEscalation,
      enablePackaging,
      bottleSizeMl,
      bottleCost,
      labelCost,
      packagingCost,
      enableTransport,
      transportMode,
      transportCostPerKg,
      transportCostAnnual,
      enableFeeding,
      feedingCostAnnual,
      enableCompliance,
      complianceCostAnnual,
      clearCostPerAcre,
      fenceCostPerAcre,
      colonySetupCostPerColony,
      numExtractors,
      extractorUnitCost,
      numContainers,
      containerUnitCost,
      insectControlAnnual,
      labourAnnual,
      fenceMaintPerAcre,
      extractorMaintAnnual,
      colonyReplaceCostPerCol,
      landRentPerAcreAnnual,
      contingencyRate,
      enableYear1LowerYield,
      year1YieldFactor,
      enableExpansion,
      expansionMode,
      expansionIncrement,
      expansionPercent
    };
  }

  function debounce(fn, delay = 400) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(null, args), delay);
    };
  }
  const saveStateDebounced = debounce(saveState, 400);

  function saveState() {
    const data = {};
    Object.keys(defaultState).forEach(key => {
      const el = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
      if (!el) return;
      if (el.type === 'radio') {
        const checked = document.querySelector(`input[name="${key}"]:checked`);
        data[key] = checked ? checked.value : defaultState[key];
      } else if (el.type === 'checkbox') {
        data[key] = el.checked;
      } else {
        data[key] = el.value;
      }
    });
    localStorage.setItem(storageKey, JSON.stringify(data));
  }

  function clearErrors() {
    document.querySelectorAll('.error-text').forEach(el => el.textContent = '');
    document.querySelectorAll('input').forEach(el => el.classList.remove('invalid'));
    const errorSummary = document.getElementById('errorSummary');
    if (errorSummary) errorSummary.style.display = 'none';
  }

  function setStatusMessage(msg, tone = 'info') {
    const el = document.getElementById('statusMessage');
    if (!el) return;
    el.textContent = msg || '';
    el.style.color = tone === 'warn' ? '#ffb74d' : '#c0c0c0';
  }

  function loadState() {
    const stored = localStorage.getItem(storageKey);
    if (!stored) return;
    try {
      const data = JSON.parse(stored);
      Object.keys(defaultState).forEach(key => {
        if (data[key] !== undefined) setValue(key, data[key]);
      });
    } catch (e) { console.warn('Tidak dapat memuat simpanan.'); }
  }

  function applyDefaults() {
    Object.entries(defaultState).forEach(([key, val]) => setValue(key, val));
    toggleModeUI();
    toggleOptionalSections();
    updateColonyEstimate();
    clearResults();
    clearErrors();
    setStatusMessage('');
    const targetResult = document.getElementById('targetMonthlyResult');
    if (targetResult) targetResult.textContent = '';
    updateQuickPreview();
  }

  function applyDemo() {
    const demoState = {
      mode: 'detailed',
      areaAcre: 2,
      density: 35,
      coloniesDirect: 60,
      yieldPerColony: 3,
      price: 180,
      propIncomePerCol: 40,
      soapIncomePerCol: 25,
      otherIncomePerCol: 10,
      otherProductName: 'Roti lebah',
      clearCostPerAcre: 1200,
      fenceCostPerAcre: 900,
      colonySetupCostPerColony: 1100,
      numExtractors: 1,
      extractorUnitCost: 250,
      numContainers: 2,
      containerUnitCost: 60,
      devCostOther0: 500,
      insectControlAnnual: 150,
      otherOpexAnnual: 250,
      labourCostAnnual: 7200,
      fenceMaintPerAcre: 320,
      extractorMaintAnnual: 80,
      colonyReplacementCostPerColony: 60,
      landRentPerAcreAnnual: 550,
      discountRate: 4,
      duration: 8,
      mortalityRatePercent: 5,
      replacementColonyCost: 900,
      costEscalationPercent: 2,
      priceEscalationPercent: 1.5,
      enablePackaging: true,
      bottleSizeMl: 250,
      bottleCost: 1.6,
      labelCost: 0.6,
      packagingCost: 0.4,
      enableTransport: true,
      transportMode: 'perKg',
      transportCostPerKg: 1.5,
      transportCostAnnual: 0,
      enableFeeding: true,
      feedingCostAnnual: 800,
      enableCompliance: true,
      complianceCostAnnual: 600,
      enableYear1LowerYield: true,
      year1YieldFactor: 70,
      contingencyPercent: 10,
      enableExpansion: true,
      expansionMode: 'increment',
      expansionIncrement: 5,
      expansionPercent: 0
    };
    Object.entries({ ...defaultState, ...demoState }).forEach(([k,v]) => setValue(k,v));
    toggleModeUI();
    toggleOptionalSections();
    updateColonyEstimate();
    clearErrors();
    updateQuickPreview();
  }

  function clearResults() {
    document.getElementById('results').innerHTML = '';
    if (cfChartInstance) { cfChartInstance.destroy(); cfChartInstance = null; }
    if (cumCfChartInstance) { cumCfChartInstance.destroy(); cumCfChartInstance = null; }
    if (npvSensChartInstance) { npvSensChartInstance.destroy(); npvSensChartInstance = null; }
    if (tornadoChartInstance) { tornadoChartInstance.destroy(); tornadoChartInstance = null; }
  }

  function summarizeOptionalCosts(params) {
    const items = [];
    if (params.enablePackaging) items.push('Botol/label/pembungkusan');
    if (params.enableTransport) items.push('Pengangkutan/pos');
    if (params.enableFeeding) items.push('Makanan tambahan/umpan');
    if (params.enableCompliance) items.push('Pensijilan/ujian/lesen');
    if (params.enableExpansion) items.push('Tambah koloni tahunan');
    return items.length ? items.join(', ') : 'Tiada kos tambahan dipilih';
  }

  function computeYear1OptionalCosts(params) {
    const plannedColonies = coloniesPlanAtYear(params, 1);
    const effectiveColoniesYear1 = plannedColonies;
    const yieldFactor = params.enableYear1LowerYield ? params.year1YieldFactor : 1;
    const honeyKg = effectiveColoniesYear1 * params.honeyYieldPerColony * yieldFactor;
    let packaging = 0;
    if (params.enablePackaging && honeyKg > 0) {
      const bottles = Math.ceil((honeyKg * 1000) / params.bottleSizeMl);
      packaging = bottles * (params.bottleCost + params.labelCost + params.packagingCost);
    }
    const transport = params.enableTransport ? (params.transportMode === 'perKg' ? honeyKg * params.transportCostPerKg : params.transportCostAnnual) : 0;
    const feeding = params.enableFeeding ? params.feedingCostAnnual : 0;
    const compliance = params.enableCompliance ? params.complianceCostAnnual : 0;
    const mortalityReplace = effectiveColoniesYear1 * params.mortalityRate * params.replacementColonyCost;
    const total = packaging + transport + feeding + compliance + mortalityReplace;
    const details = [
      params.enablePackaging ? `Pembotolan/label: RM ${fmtNumber(packaging)}` : null,
      params.enableTransport ? `Pengangkutan/pos: RM ${fmtNumber(transport)}` : null,
      params.enableFeeding ? `Makanan tambahan/umpan: RM ${fmtNumber(feeding)}` : null,
      params.enableCompliance ? `Pensijilan/ujian: RM ${fmtNumber(compliance)}` : null,
      params.mortalityRate > 0 ? `Ganti koloni (risiko): RM ${fmtNumber(mortalityReplace)}` : null
    ].filter(Boolean).join(' | ');
    return { total, details, honeyKg };
  }

  function updateQuickPreview() {
    const params = buildParams();
    const plannedColonies = coloniesPlanAtYear(params, 1);
    const effectiveColoniesYear1 = plannedColonies;
    const yieldFactor = params.enableYear1LowerYield ? params.year1YieldFactor : 1;
    const honeyKg = effectiveColoniesYear1 * params.honeyYieldPerColony * yieldFactor;
    const bottles = params.enablePackaging ? Math.ceil((honeyKg * 1000) / Math.max(1, params.bottleSizeMl)) : 0;

    const year1Optional = computeYear1OptionalCosts(params);
    const annualBase = params.baseInputAnnual + params.baseLabourAnnual + params.baseMiscAnnual;
    const directCost = annualBase + year1Optional.total;
    const totalCost = directCost + directCost * params.contingencyRate;

    document.getElementById('previewHoney').textContent = `${fmtNumber(honeyKg)} kg`;
    document.getElementById('previewBottles').textContent = params.enablePackaging ? fmtNumber(bottles,0) + ' botol' : 'Tidak aktif';
    document.getElementById('previewCost').textContent = 'RM ' + fmtNumber(totalCost);
  }

  function buildMultiFactorSensitivity(params, scenarioParams) {
    const baseScenarioParams = {
      ...scenarioParams,
      baseHoneyPrice: Number.isFinite(scenarioParams.baseHoneyPrice) ? scenarioParams.baseHoneyPrice : params.honeyPrice,
      honeyYieldPerColony: Number.isFinite(scenarioParams.honeyYieldPerColony) ? scenarioParams.honeyYieldPerColony : params.honeyYieldPerColony,
      baseLabourAnnual: Number.isFinite(scenarioParams.baseLabourAnnual) ? scenarioParams.baseLabourAnnual : params.baseLabourAnnual,
      mortalityRate: Number.isFinite(scenarioParams.mortalityRate) ? scenarioParams.mortalityRate : params.mortalityRate
    };
    if (!Number.isFinite(baseScenarioParams.mortalityRate) && Number.isFinite(scenarioParams.mortalityRatePercent)) {
      baseScenarioParams.mortalityRate = scenarioParams.mortalityRatePercent / 100;
    }
    baseScenarioParams.mortalityRate = clamp(baseScenarioParams.mortalityRate || 0, 0, 1);

    const baseNPV = computeScenario({ ...baseScenarioParams, priceFactor: 1 }).npv;
    const cases = [
      { key: 'baseHoneyPrice', label: 'Harga madu', low: 0.8, high: 1.2, clamp: (v) => Math.max(0, v) },
      { key: 'honeyYieldPerColony', label: 'Hasil per koloni', low: 0.8, high: 1.2, clamp: (v) => Math.max(0, v) },
      { key: 'mortalityRate', label: 'Mortaliti koloni', low: 0.8, high: 1.2, clamp: (v) => clamp(v, 0, 1) },
      { key: 'baseLabourAnnual', label: 'Kos tenaga kerja', low: 0.8, high: 1.2, clamp: (v) => Math.max(0, v) }
    ];

    const rows = cases.map(c => {
      const baseValue = baseScenarioParams[c.key];
      const lowValue = c.clamp(baseValue * c.low);
      const highValue = c.clamp(baseValue * c.high);

      const lowScenario = computeScenario({ ...baseScenarioParams, [c.key]: lowValue, priceFactor: 1 });
      const highScenario = computeScenario({ ...baseScenarioParams, [c.key]: highValue, priceFactor: 1 });

      const lowNPV = lowScenario.npv;
      const highNPV = highScenario.npv;
      const range = highNPV - lowNPV;
      return { label: c.label, lowNPV, baseNPV, highNPV, range };
    });

    rows.sort((a,b) => Math.abs(b.range) - Math.abs(a.range));

    let tableHtml = "<h3>Analisis Sensitiviti Pelbagai Faktor (NPV)</h3>";
    tableHtml += "<table><tr><th>Faktor</th><th>NPV Rendah</th><th>NPV Asas</th><th>NPV Tinggi</th><th>Julat</th></tr>";
    rows.forEach(r => {
      tableHtml += `<tr><td style="text-align:left">${r.label}</td><td>${coloredFmt(r.lowNPV)}</td><td>${coloredFmt(r.baseNPV)}</td><td>${coloredFmt(r.highNPV)}</td><td>${coloredFmt(r.range)}</td></tr>`;
    });
    tableHtml += "</table>";

    const chartData = rows.map(r => ({
      label: r.label,
      low: r.lowNPV,
      high: r.highNPV,
      range: r.range
    }));

    return { tableHtml, chartData };
  }

  function renderCharts(baseScenario, sensLabels, sensNPV) {
    const yearLabels = [];
    const cfData = [];
    let cum = 0;
    const cumData = [];

    for (let t = 0; t < baseScenario.cashflows.length; t++) {
      yearLabels.push("Tahun " + t);
      const cf = baseScenario.cashflows[t];
      cfData.push(cf);
      cum += cf;
      cumData.push(cum);
    }

    const cfColors = cfData.map(v => v < 0 ? 'rgba(255, 82, 82, 0.9)' : 'rgba(255, 202, 40, 0.7)');
    const cfBorderColors = cfData.map(v => v < 0 ? 'rgba(255, 82, 82, 1)' : 'rgba(255, 202, 40, 1)');

    if (cfChartInstance) cfChartInstance.destroy();
    const cfCtx = document.getElementById('cfChart').getContext('2d');
    cfChartInstance = new Chart(cfCtx, {
      type: 'bar',
      data: { labels: yearLabels, datasets: [{ label: 'Aliran Tunai Bersih (RM)', data: cfData, backgroundColor: cfColors, borderColor: cfBorderColors, borderWidth: 1 }] },
      options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });

    const cumNegative = cumData[cumData.length - 1] < 0;
    const cumLineColor = cumNegative ? 'rgba(255, 82, 82, 1)' : 'rgba(129, 199, 132, 1)';
    const cumFillColor = cumNegative ? 'rgba(255, 82, 82, 0.3)' : 'rgba(129, 199, 132, 0.3)';

    if (cumCfChartInstance) cumCfChartInstance.destroy();
    const cumCtx = document.getElementById('cumCfChart').getContext('2d');
    cumCfChartInstance = new Chart(cumCtx, {
      type: 'line',
      data: { labels: yearLabels, datasets: [{ label: 'Aliran Tunai Terkumpul (RM)', data: cumData, fill: false, borderColor: cumLineColor, backgroundColor: cumFillColor, tension: 0.2, borderWidth: 2 }] },
      options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });

    const npvBarColors = sensNPV.map(v => v < 0 ? 'rgba(255, 82, 82, 0.9)' : 'rgba(255, 213, 79, 0.7)');
    const npvBorderColors = sensNPV.map(v => v < 0 ? 'rgba(255, 82, 82, 1)' : 'rgba(255, 213, 79, 1)');

    if (npvSensChartInstance) npvSensChartInstance.destroy();
    const npvCtx = document.getElementById('npvSensChart').getContext('2d');
    npvSensChartInstance = new Chart(npvCtx, {
      type: 'bar',
      data: { labels: sensLabels, datasets: [{ label: 'NPV mengikut Tetapan Harga Madu (RM)', data: sensNPV, backgroundColor: npvBarColors, borderColor: npvBorderColors, borderWidth: 1 }] },
      options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });
  }

  function renderTornadoChart(chartData) {
    const labels = chartData.map(d => d.label);
    const lowValues = chartData.map(d => d.low);
    const highValues = chartData.map(d => d.high);

    if (tornadoChartInstance) tornadoChartInstance.destroy();
    const ctx = document.getElementById('tornadoChart').getContext('2d');
    tornadoChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'NPV Rendah', data: lowValues, backgroundColor: 'rgba(255,82,82,0.6)', borderColor: 'rgba(255,82,82,1)', borderWidth: 1 },
          { label: 'NPV Tinggi', data: highValues, backgroundColor: 'rgba(139,195,74,0.6)', borderColor: 'rgba(139,195,74,1)', borderWidth: 1 }
        ]
      },
      options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: true } }, scales: { x: { beginAtZero: true } } }
    });
  }

  function downloadCSV(filename, rows) {
    const csvContent = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  function downloadCashflowCSV() {
    const params = buildParams();
    const scenarioParams = { ...params, baseHoneyPrice: params.honeyPrice, baseLabourAnnual: params.labourAnnual, priceFactor: 1 };
    const sc = computeScenario(scenarioParams);
    const rows = [["Tahun","Koloni Efektif","Hasil (RM)","Kos (RM)","Aliran Tunai Bersih (RM)","Aliran Tunai Terkumpul (RM)","Nilai Kini Aliran Tunai (RM)"]];
    let cum = 0;
    sc.cashflows.forEach((cf, t) => {
      cum += cf;
      const pv = cf / Math.pow(1 + params.discountRate, t);
      rows.push([t, fmtNumber(sc.effectiveColoniesSeries[t] || 0,0), fmtNumber(sc.benefits[t]), fmtNumber(sc.totalCosts[t]), fmtNumber(cf), fmtNumber(cum), fmtNumber(pv)]);
    });
    downloadCSV("aliran_tunai_kelulut.csv", rows);
  }

  function downloadSensitivityCSV() {
    const params = buildParams();
    const scenarioParams = { ...params, baseHoneyPrice: params.honeyPrice, baseLabourAnnual: params.labourAnnual, priceFactor: 1 };
    const multiSens = buildMultiFactorSensitivity(params, scenarioParams);
    const baseNPV = computeScenario(scenarioParams).npv;
    const rows = [["Faktor","NPV Rendah","NPV Asas","NPV Tinggi","Julat NPV"]];
    multiSens.chartData.forEach(r => rows.push([r.label, fmtNumber(r.low), fmtNumber(baseNPV), fmtNumber(r.high), fmtNumber(r.range)]));
    downloadCSV("sensitiviti_kelulut.csv", rows);
  }

  function buildScenarioParamsFromParams(params) {
    return {
      T: params.T,
      colonies: params.colonies,
      honeyYieldPerColony: params.honeyYieldPerColony,
      baseHoneyPrice: params.honeyPrice,
      propIncomePerColony: params.propIncomePerCol,
      soapIncomePerColony: params.soapIncomePerCol,
      otherIncomePerColony: params.otherIncomePerCol,
      devCost0: params.devCost0,
      baseInputAnnual: params.baseInputAnnual,
      baseLabourAnnual: params.baseLabourAnnual,
      baseMiscAnnual: params.baseMiscAnnual,
      bottleSizeMl: params.bottleSizeMl,
      bottleCost: params.bottleCost,
      labelCost: params.labelCost,
      packagingCost: params.packagingCost,
      enablePackaging: params.enablePackaging,
      enableTransport: params.enableTransport,
      transportMode: params.transportMode,
      transportCostPerKg: params.transportCostPerKg,
      transportCostAnnual: params.transportCostAnnual,
      enableFeeding: params.enableFeeding,
      feedingCostAnnual: params.feedingCostAnnual,
      enableCompliance: params.enableCompliance,
      complianceCostAnnual: params.complianceCostAnnual,
      mortalityRate: params.mortalityRate,
      replacementColonyCost: params.replacementColonyCost,
      costEscalation: params.costEscalation,
      priceEscalation: params.priceEscalation,
      discountRate: params.discountRate,
      priceFactor: 1,
      contingencyRate: params.contingencyRate,
      enableYear1LowerYield: params.enableYear1LowerYield,
      year1YieldFactor: params.year1YieldFactor,
      enableExpansion: params.enableExpansion,
      expansionMode: params.expansionMode,
      expansionIncrement: params.expansionIncrement,
      expansionPercent: params.expansionPercent,
      colonySetupCostPerColony: params.colonySetupCostPerColony
    };
  }

  function runAnalysis() {
    if (!validateInputs()) return;
    const farmerName = document.getElementById('farmerName').value.trim();
    const villageName = document.getElementById('villageName').value.trim();
    const phoneNumber = document.getElementById('phoneNumber').value.trim();

    const params = buildParams();
    const {
      colonies, honeyYieldPerColony, honeyPrice, propIncomePerCol, soapIncomePerCol, otherIncomePerCol,
      devCost0, devCostOther0, baseInputAnnual, otherOpexAnnual, baseLabourAnnual, baseMiscAnnual, T, discountRate,
      mortalityRate, replacementColonyCost, costEscalation, priceEscalation, contingencyRate
    } = params;

    const scenarioParams = buildScenarioParamsFromParams(params);

    const baseScenario = computeScenario(scenarioParams);
    const inputsIncomplete = inputsAreIncomplete(params);
    const breakEvenPrice = computeBreakEvenHoneyPrice(scenarioParams);

    const totalBenefits = baseScenario.benefits.reduce((a,b) => a + b, 0);
    const totalCosts = baseScenario.totalCosts.reduce((a,b) => a + b, 0);
    const roi = totalCosts > 0 ? ((totalBenefits - totalCosts) / totalCosts) * 100 : null;
    const roiYear1 = baseScenario.totalCosts[1] > 0 ? (baseScenario.cashflows[1] / baseScenario.totalCosts[1]) * 100 : null;

    const paybackText = baseScenario.paybackYear ? "Tahun ke-" + baseScenario.paybackYear : "Tidak pulang modal dalam tempoh analisis";
    const otherName = params.otherProductName ? ` (${params.otherProductName})` : '';
    const year1Optional = computeYear1OptionalCosts(params);
    const honeyRevenueAnnual = year1Optional.honeyKg * honeyPrice;
    const propRevenueAnnual = colonies * propIncomePerCol;
    const soapRevenueAnnual = colonies * soapIncomePerCol;
    const otherRevenueAnnual = colonies * otherIncomePerCol;
    const totalAnnualRevenue = honeyRevenueAnnual + propRevenueAnnual + soapRevenueAnnual + otherRevenueAnnual;

    const monthlyNetEl = document.getElementById('monthlyNetValue');
    const monthlyRevenueEl = document.getElementById('monthlyRevenueValue');
    const monthlyCostEl = document.getElementById('monthlyCostValue');
    const monthlyMessageEl = document.getElementById('monthlyMessage');
    if (inputsIncomplete) {
      if (monthlyNetEl) monthlyNetEl.textContent = '-';
      if (monthlyRevenueEl) monthlyRevenueEl.textContent = '-';
      if (monthlyCostEl) monthlyCostEl.textContent = '-';
      if (monthlyMessageEl) monthlyMessageEl.textContent = 'Sila lengkapkan maklumat hasil dan kos dahulu.';
    } else {
      const monthlyNet = numOrZero(baseScenario.cashflows[1]) / 12;
      const monthlyRevenue = numOrZero(baseScenario.benefits[1]) / 12;
      const monthlyCost = numOrZero(baseScenario.totalCosts[1]) / 12;
      if (monthlyNetEl) monthlyNetEl.textContent = `RM ${fmtNumber(monthlyNet)}`;
      if (monthlyRevenueEl) monthlyRevenueEl.textContent = `RM ${fmtNumber(monthlyRevenue)}`;
      if (monthlyCostEl) monthlyCostEl.textContent = `RM ${fmtNumber(monthlyCost)}`;
      if (monthlyMessageEl) monthlyMessageEl.textContent = '';
    }

    const bottlePanel = document.getElementById('infoBottles');
    const monthlyBottleEl = document.getElementById('monthlyBottleValue');
    const annualBottleEl = document.getElementById('annualBottleValue');
    if (bottlePanel) bottlePanel.style.display = params.enablePackaging ? 'block' : 'none';
    if (params.enablePackaging) {
      const bottleSizeSafe = Math.max(1, params.bottleSizeMl || 1);
      const bottlesAnnual = year1Optional.honeyKg > 0 ? Math.ceil((year1Optional.honeyKg * 1000) / bottleSizeSafe) : 0;
      const bottlesMonthly = Math.ceil(bottlesAnnual / 12);
      if (monthlyBottleEl) monthlyBottleEl.textContent = fmtNumber(bottlesMonthly, 0) + ' botol';
      if (annualBottleEl) annualBottleEl.textContent = fmtNumber(bottlesAnnual, 0) + ' botol';
    } else {
      if (monthlyBottleEl) monthlyBottleEl.textContent = '-';
      if (annualBottleEl) annualBottleEl.textContent = '-';
    }

    const assumptionIdentityEl = document.getElementById('assumptionIdentity');
    const assumptionTextEl = document.getElementById('assumptionText');
    const farmerDisplay = farmerName ? `<span class="hl-name">${farmerName}</span>` : '-';
    const villageDisplay = villageName ? `<span class="hl-name">${villageName}</span>` : '-';
    if (assumptionIdentityEl) {
      assumptionIdentityEl.innerHTML = `Nama penternak: ${farmerDisplay} | Nama kampung: ${villageDisplay}`;
    }
    if (assumptionTextEl) {
      assumptionTextEl.innerHTML = `Laporan ini menganggarkan projek anda berdasarkan bilangan koloni <span class="hl-val">${fmtNumber(colonies, 0)}</span>, hasil madu sekitar <span class="hl-val">${fmtNumber(honeyYieldPerColony)}</span> kg/koloni setahun, harga madu RM<span class="hl-val">${fmtNumber(honeyPrice)}</span>/kg, dan tempoh analisis <span class="hl-val">${fmtNumber(T, 0)}</span> tahun. Kos utama termasuk modal permulaan (Tahun 0), belanja operasi tahunan (upah, bahan habis pakai, kawalan serangga, sewa dan lain-lain), serta tetapan seperti kontinjensi dan kadar diskaun. Jika ada angka yang belum pasti, anda boleh ubah input dan tekan ‚ÄòKira‚Äô semula.`;
    }

    const keyCards = `
      <div class="three-cards">
        <div class="mini-card"><h4>Untung bersih setahun (Tahun 1)</h4><div class="badge">RM ${fmtNumber(baseScenario.cashflows[1] || 0)}</div><small class="note">Bersih selepas kos & kontinjensi pada tahun pertama operasi.</small></div>
        <div class="mini-card"><h4>Tahun pulang modal</h4><div class="badge">${paybackText}</div><small class="note">Tahun di mana aliran tunai terkumpul mula positif.</small></div>
        <div class="mini-card"><h4>Harga madu minimum tak rugi</h4><div class="badge">${breakEvenPrice !== null ? 'RM ' + fmtNumber(breakEvenPrice) + ' /kg' : '-'}</div><small class="note">Harga madu anggaran supaya NPV ‚âà 0 (ambil kira hasil lain).</small></div>
      </div>
    `;

    const metricsTable = `
      <h3>Analisis Lanjut / Profesional</h3>
      <table>
        <tr><th style="text-align:left;">Penunjuk</th><th>Nilai</th><th style="text-align:left;">Takrif Ringkas</th></tr>
        <tr>
          <td style="text-align:left;">NPV (Nilai Kini Bersih)</td>
          <td>RM ${coloredFmt(baseScenario.npv)}</td>
          <td style="text-align:left;">
            <div class="metric-desc"><strong>Apa maksud:</strong> Lebihan nilai untung selepas ambil kira nilai duit ikut masa (kadar diskaun). Semua aliran tunai masa depan ditukar kepada nilai hari ini.<br><strong>Cara baca:</strong> NPV &gt; 0 biasanya berbaloi kerana masih ada lebihan selepas diskaun.<br><strong>Contoh:</strong> NPV RM 5,000 bermakna projek ada lebihan ¬±RM 5,000 pada nilai hari ini.</div>
          </td>
        </tr>
        <tr>
          <td style="text-align:left;">IRR (Kadar Pulangan Dalaman)</td>
          <td>${baseScenario.irr !== null ? coloredFmt(baseScenario.irr) + ' %' : '-'}</td>
          <td style="text-align:left;">
            <div class="metric-desc"><strong>Apa maksud:</strong> Macam ‚Äúkadar untung‚Äù dalaman projek (peratus pulangan sebenar).<br><strong>Cara baca:</strong> Jika IRR &gt; kadar diskaun atau kadar simpanan bank, projek biasanya lebih menarik.<br><strong>Contoh:</strong> IRR 18% lebih tinggi daripada diskaun 3%.</div>
          </td>
        </tr>
        <tr>
          <td style="text-align:left;">BCR (Nisbah Faedah-Kos)</td>
          <td>${baseScenario.bcr !== null ? baseScenario.bcr.toFixed(2) : '-'}</td>
          <td style="text-align:left;">
            <div class="metric-desc"><strong>Apa maksud:</strong> Nisbah manfaat berbanding kos; setiap RM1 kos beri berapa RM manfaat.<br><strong>Cara baca:</strong> BCR &gt; 1 bermakna manfaat lebih tinggi daripada kos.<br><strong>Contoh:</strong> BCR 1.30 = RM1 kos ‚Üí RM1.30 manfaat.</div>
          </td>
        </tr>
        <tr>
          <td style="text-align:left;">ROI (Keseluruhan)</td>
          <td>${roi !== null ? coloredFmt(roi) + ' %' : '-'}</td>
          <td style="text-align:left;">
            <div class="metric-desc"><strong>Apa maksud:</strong> Peratus untung bersih berbanding jumlah kos sepanjang tempoh projek.<br><strong>Cara baca:</strong> Lagi tinggi, lagi banyak lebihan berbanding modal dikeluarkan.<br><strong>Contoh:</strong> Kos RM10,000, untung RM2,000 ‚Üí ROI ¬±20%.</div>
          </td>
        </tr>
        <tr><td style="text-align:left;">ROI Tahun 1</td><td>${roiYear1 !== null ? coloredFmt(roiYear1) + ' %' : '-'}</td><td style="text-align:left;">Pulangan pada tahun operasi pertama sahaja.</td></tr>
        <tr>
          <td style="text-align:left;">Harga madu minimum tak rugi</td>
          <td>${breakEvenPrice !== null ? 'RM ' + fmtNumber(breakEvenPrice) + ' /kg' : '-'}</td>
          <td style="text-align:left;">
            <div class="metric-desc"><strong>Apa maksud:</strong> Harga madu minimum supaya projek tak rugi (NPV ‚âà 0), selepas ambil kira hasil sampingan lain.<br><strong>Cara baca:</strong> Jika harga pasaran lebih tinggi daripada nilai ini, projek biasanya lebih selamat.<br><strong>Contoh:</strong> Harga minimum RM 120/kg, harga RM 150/kg lazimnya ada lebihan.</div>
          </td>
        </tr>
        <tr>
          <td style="text-align:left;">Tahun pulang modal</td>
          <td>${paybackText}</td>
          <td style="text-align:left;">
            <div class="metric-desc"><strong>Apa maksud:</strong> Tahun bila modal awal kembali apabila aliran tunai terkumpul mula positif.<br><strong>Cara baca:</strong> Lagi awal, lagi cepat modal kembali dan risiko lebih rendah.<br><strong>Contoh:</strong> ‚ÄúTahun ke-4‚Äù bermakna sekitar tahun 4 modal baru pulih.</div>
          </td>
        </tr>
      </table>
    `;

    let conclusionClass = "conclusion-box";
    let conclusionHeader = "";
    let conclusionText = "";
    let suggestionHtml = "<ul>";

    if (baseScenario.npv > 0 && baseScenario.bcr !== null && baseScenario.bcr > 1 && roi !== null && roi > 20 && (baseScenario.irr === null || baseScenario.irr > discountRate*100)) {
      conclusionClass += " conclusion-good";
      conclusionHeader = "‚úÖ PROJEK BERBALOI";
      conclusionText = "Dengan anggaran semasa, projek ini menunjukkan pulangan yang baik dan berpotensi memberi keuntungan stabil kepada penternak.";
      suggestionHtml += "<li>Tingkatkan pemasaran (jenama sendiri, jual terus kepada pengguna) untuk kekalkan harga jual di paras tinggi.</li>";
      suggestionHtml += "<li>Kekalkan mutu penjagaan koloni supaya hasil madu per koloni stabil atau meningkat.</li>";
      suggestionHtml += "<li>Beli input secara pukal atau melalui koperasi untuk mengurangkan kos.</li>";
      suggestionHtml += "<li>Boleh tambah bilangan koloni secara berperingkat selepas projek stabil.</li>";
    } else if (baseScenario.npv > 0 && baseScenario.bcr !== null && baseScenario.bcr >= 1) {
      conclusionClass += " conclusion-moderate";
      conclusionHeader = "‚ö† PROJEK BERBALOI (BERJAGA-JAGA)";
      conclusionText = "Projek ini masih boleh diteruskan tetapi margin keuntungan tidak terlalu besar. Penternak perlu mengawal kos dan berusaha meningkatkan hasil.";
      suggestionHtml += "<li>Naikkan hasil madu per koloni melalui latihan teknikal dan amalan penternakan yang lebih baik.</li>";
      suggestionHtml += "<li>Bandingkan beberapa pembekal input untuk mendapatkan harga yang lebih rendah.</li>";
      suggestionHtml += "<li>Kawal kos tenaga kerja supaya selari dengan saiz projek.</li>";
      suggestionHtml += "<li>Manfaatkan bantuan kerajaan, program agropreneur atau geran yang tersedia.</li>";
    } else {
      conclusionClass += " conclusion-bad";
      conclusionHeader = "‚ùå PROJEK BERISIKO / KURANG BERBALOI";
      conclusionText = "Dengan anggaran semasa, projek ini kelihatan berisiko atau kurang menguntungkan. Penternak disaran menilai semula sebelum melabur modal yang besar.";
      suggestionHtml += "<li>Cuba tingkatkan harga jual melalui pembungkusan lebih baik, pensijilan atau pemasaran terus kepada pengguna.</li>";
      suggestionHtml += "<li>Tingkatkan hasil per koloni melalui bimbingan teknikal dan pengurusan koloni yang baik.</li>";
      suggestionHtml += "<li>Kurangkan kos pembangunan awal dengan mula pada skala lebih kecil.</li>";
      suggestionHtml += "<li>Kurangkan kos tenaga kerja melalui kerjasama keluarga atau koperasi.</li>";
      suggestionHtml += "<li>Cari bantuan geran, subsidi atau skim sokongan agensi kerajaan untuk mengurangkan beban modal awal.</li>";
    }
    suggestionHtml += "</ul>";

    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = `
      <div class="result-box">
        <p><strong>Nama penternak:</strong> ${farmerName || '-'} | <strong>Kampung / lokasi:</strong> ${villageName || '-'} | <strong>No. telefon:</strong> ${phoneNumber || '-'}</p>
        <p><strong>Mod:</strong> ${params.mode === 'simple' ? 'Ringkas (Kampung)' : 'Terperinci (Profesional)'}</p>
        <p><strong>Bilangan koloni digunakan dalam kiraan:</strong> ${fmtNumber(colonies,0)}</p>
        <p><strong>Jumlah hasil madu tahun pertama:</strong> ${fmtNumber(year1Optional.honeyKg)} kg ‚Üí anggaran nilai: RM ${fmtNumber(honeyRevenueAnnual)}</p>
        <p><strong>Anggaran hasil propolis setahun:</strong> RM ${fmtNumber(propRevenueAnnual)} | <strong>Sabun:</strong> RM ${fmtNumber(soapRevenueAnnual)} | <strong>Lain-lain${otherName}:</strong> RM ${fmtNumber(otherRevenueAnnual)}</p>
        <p><strong>Jumlah semua hasil setahun (Tahun 1):</strong> RM ${fmtNumber(totalAnnualRevenue)}</p>
        <p><strong>Jumlah kos pembangunan (tahun 0):</strong> RM ${fmtNumber(devCost0)}</p>
        <p><strong>Kos pembangunan lain-lain (Tahun 0):</strong> RM ${fmtNumber(devCostOther0)}</p>
        <p><strong>Kos bahan input tahunan setara (asas):</strong> RM ${fmtNumber(baseInputAnnual)} / tahun</p>
        <p><strong>Bahan habis pakai lain-lain (setahun):</strong> RM ${fmtNumber(otherOpexAnnual)} / tahun</p>
        <p><strong>Kos tenaga kerja tahunan:</strong> RM ${fmtNumber(baseLabourAnnual)} / tahun | <strong>Kos pelbagai/utiliti:</strong> RM ${fmtNumber(baseMiscAnnual)} / tahun</p>
        <p><strong>Kos tahunan tambahan dipilih:</strong> ${summarizeOptionalCosts(params)}</p>
        <p><strong>Anggaran kos tambahan Tahun 1:</strong> RM ${fmtNumber(year1Optional.total)}${year1Optional.details ? ' (' + year1Optional.details + ')' : ''}</p>
        ${keyCards}
        ${metricsTable}
      </div>
      <div class="${conclusionClass}">
        <div class="conclusion-title">${conclusionHeader}</div>
        <p>${conclusionText}</p>
        <strong>Cara untuk tambah keuntungan / kurangkan risiko:</strong>
        ${suggestionHtml}
      </div>
    `;

    let table = "<h3>Jadual Aliran Tunai</h3>";
    if (inputsIncomplete) {
      table += "<p class=\"note\">Nota: Ada input hasil/kos yang belum lengkap. Jadual dipaparkan sebagai 0.00 untuk medan yang tidak lengkap. Sila semak Langkah 1 & 2.</p>";
    }
    table += "<table><tr><th>Tahun</th><th>Koloni Efektif</th><th>Hasil (RM)</th><th>Jumlah Kos (RM)</th><th>Aliran Tunai Bersih (RM)</th><th>Aliran Tunai Terkumpul (RM)</th><th>Nilai Kini Aliran Tunai (RM)</th></tr>";
    let cum = 0;
    for (let t = 0; t <= T; t++) {
      const cf = numOrZero(baseScenario.cashflows[t]);
      cum += cf;
      const pv = cf / Math.pow(1 + discountRate, t);
      table += `<tr><td style=\"text-align:center\">${t}</td><td>${fmtNumber(baseScenario.effectiveColoniesSeries[t] || 0,0)}</td><td>${coloredFmtRM(baseScenario.benefits[t])}</td><td>${coloredFmtRM(baseScenario.totalCosts[t])}</td><td>${coloredFmtRM(cf)}</td><td>${coloredFmtRM(cum)}</td><td>${coloredFmtRM(pv)}</td></tr>`;
    }
    table += "</table>";
    table += "<p class=\"note small\">Aliran Tunai Bersih = Hasil - Kos. Jika negatif, bermaksud belanja lebih daripada hasil pada tahun tersebut.</p>";
    resultsDiv.innerHTML += table;

    let sensTable = "<h3>Analisis Sensitiviti Harga Madu (NPV, IRR, BCR)</h3>";
    sensTable += "<table><tr><th>Tetapan</th><th>Faktor Harga</th><th>Harga madu/kg (RM)</th><th>NPV (RM)</th><th>IRR (%)</th><th>BCR</th></tr>";
    const factors = [0.8, 0.9, 1.0, 1.1, 1.2];
    const sensLabels = [];
    const sensNPV = [];
    factors.forEach((f, idx) => {
      const sc = computeScenario({ ...scenarioParams, priceFactor: f });
      sensLabels.push((f * 100).toFixed(0) + "%");
      sensNPV.push(sc.npv);
      sensTable += `<tr><td style=\"text-align:center\">${idx + 1}</td><td>${(f * 100).toFixed(0)}%</td><td>${fmtNumber(honeyPrice * f)}</td><td>${coloredFmt(sc.npv)}</td><td>${sc.irr !== null ? coloredFmt(sc.irr) : '-'}</td><td>${sc.bcr !== null ? sc.bcr.toFixed(2) : '-'}</td></tr>`;
    });
    sensTable += "</table>";
    resultsDiv.innerHTML += sensTable;

    const multiSensitivity = buildMultiFactorSensitivity(params, scenarioParams);
    resultsDiv.innerHTML += multiSensitivity.tableHtml;
    resultsDiv.innerHTML += `<p class=\"note\">Nota: Kadar kontinjensi ditetapkan kepada ${fmtNumber(params.contingencyRate * 100,0)}% dan digunakan ke atas semua kos setiap tahun.</p>`;

    renderCharts(baseScenario, sensLabels, sensNPV);
    renderTornadoChart(multiSensitivity.chartData);

    const step3 = document.getElementById('step3');
    const resultsSection = document.getElementById('secResults');
    if (step3) step3.open = true;
    if (resultsSection) resultsSection.open = true;
    const infoMonthly = document.getElementById('infoMonthly');
    if (infoMonthly) infoMonthly.open = true;

    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

    const now = new Date();
    const dateStr = now.toLocaleDateString('ms-MY');
    const timeStr = now.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });
    document.getElementById('reportMeta').textContent = `Versi kalkulator: v2.1 | Tarikh laporan dijana: ${dateStr} ${timeStr}`;
    saveState();
    setStatusMessage('Analisis berjaya dijana pada ' + dateStr + ' ' + timeStr + '.');
  }

  function estimateTargetMonthlyColonies() {
    const targetInput = document.getElementById('targetMonthlyNet');
    const resultEl = document.getElementById('targetMonthlyResult');
    if (!targetInput || !resultEl) return;
    const targetMonthly = parseFloat(targetInput.value) || 0;
    if (targetMonthly <= 0) {
      resultEl.textContent = 'Sila masukkan sasaran pendapatan (RM/bulan).';
      return;
    }

    const params = buildParams();
    if (inputsAreIncomplete(params)) {
      resultEl.textContent = 'Sila lengkapkan Maklumat Hasil (Langkah 1) dan Kos (Langkah 2) dahulu untuk anggaran yang lebih tepat.';
      return;
    }

    const scenarioParams = buildScenarioParamsFromParams(params);
    const sc = computeScenario(scenarioParams);
    const coloniesForCalc = params.colonies > 0 ? params.colonies : 1;
    const untungSetahunPerKoloni = numOrZero(sc.cashflows[1]) / coloniesForCalc;
    if (untungSetahunPerKoloni <= 0) {
      resultEl.textContent = 'Berdasarkan input semasa, projek tidak menunjukkan untung per koloni. Sila semak harga madu, hasil, atau kos.';
      return;
    }
    const targetSetahun = targetMonthly * 12;
    const coloniesNeeded = Math.ceil(targetSetahun / untungSetahunPerKoloni);
    resultEl.innerHTML = `Anggaran bilangan koloni diperlukan: <span class="hl-val">${fmtNumber(coloniesNeeded, 0)}</span> koloni.`;
  }

  function downloadPDF() {
    const report = document.getElementById('reportArea');
    if (!report) return;
    const { jsPDF } = window.jspdf;
    html2canvas(report, { scale: 2 }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pdfWidth;
      const imgHeight = canvas.height * pdfWidth / canvas.width;
      let heightLeft = imgHeight;
      let position = 0;
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pdfHeight;
      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pdfHeight;
      }
      pdf.save('Laporan_Projek_Madu_Kelulut_imej_skrin.pdf');
    });
  }

  function downloadPdfRingkasClean() {
    const params = buildParams();
    const scenarioParams = { ...params, baseHoneyPrice: params.honeyPrice, baseLabourAnnual: params.labourAnnual, priceFactor: 1 };
    const sc = computeScenario(scenarioParams);
    const breakEvenPrice = computeBreakEvenHoneyPrice(scenarioParams);
    const inputsIncomplete = inputsAreIncomplete(params);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 14;
    const lineHeight = 5;
    const calcVersion = "v2.1";
    const now = new Date();
    const dateStr = now.toLocaleDateString('ms-MY');
    const timeStr = now.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });

    const addTitle = (text) => {
      pdf.setFontSize(18);
      pdf.text(text, margin, 18);
    };
    const addLabelValue = (label, value, y) => {
      pdf.setFontSize(11);
      pdf.text(`${label}: ${value}`, margin, y);
    };
    const drawSummaryBox = (x, y, w, h, title, value) => {
      pdf.setDrawColor(180);
      pdf.setFillColor(250, 250, 250);
      pdf.rect(x, y, w, h, 'F');
      pdf.setDrawColor(120);
      pdf.rect(x, y, w, h);
      pdf.setFontSize(10);
      pdf.text(title, x + 4, y + 7);
      pdf.setFontSize(14);
      pdf.text(value, x + 4, y + 16);
    };

    addTitle("Laporan Ringkas - Projek Madu Kelulut");
    addLabelValue("Nama Penternak", document.getElementById('farmerName').value.trim() || "-", 28);
    addLabelValue("Nama Kampung", document.getElementById('villageName').value.trim() || "-", 34);
    addLabelValue("Tarikh/Masa Dijana", `${dateStr} ${timeStr}`, 40);
    addLabelValue("Versi", calcVersion, 46);

    if (inputsIncomplete) {
      pdf.setFontSize(10);
      pdf.text("Nota: Ada input belum lengkap. Nilai 0.00 dipaparkan untuk medan yang belum diisi.", margin, 54);
    }

    const boxWidth = (pageWidth - margin * 2 - 6) / 3;
    const boxY = 62;
    drawSummaryBox(margin, boxY, boxWidth, 22, "Untung Bersih Tahun 1 (RM)", `RM ${fmtRM(sc.cashflows[1] || 0)}`);
    drawSummaryBox(margin + boxWidth + 3, boxY, boxWidth, 22, "Tahun pulang modal", sc.paybackYear ? `Tahun ${sc.paybackYear}` : "Belum");
    drawSummaryBox(margin + (boxWidth + 3) * 2, boxY, boxWidth, 22, "Harga madu minimum tak rugi (RM/kg)", `RM ${fmtRM(breakEvenPrice || 0)}`);

    let y = 92;
    pdf.setFontSize(12);
    pdf.text("Ringkasan Metrik Utama", margin, y);
    y += 7;
    pdf.setFontSize(11);
    pdf.text(`NPV: RM ${fmtRM(sc.npv)} | IRR: ${sc.irr !== null ? fmtNumber(sc.irr) + " %" : "-"}`, margin, y);
    y += lineHeight;
    const totalCosts = sc.totalCosts.reduce((a,b)=>a+b,0);
    const totalBenefits = sc.benefits.reduce((a,b)=>a+b,0);
    const roi = totalCosts > 0 ? ((totalBenefits - totalCosts) / totalCosts) * 100 : null;
    pdf.text(`BCR: ${sc.bcr !== null ? sc.bcr.toFixed(2) : "-"} | ROI: ${roi !== null ? fmtNumber(roi) + " %" : "-"}`, margin, y);
    y += 8;

    pdf.setFontSize(11);
    pdf.text("Nota andaian ringkas:", margin, y);
    y += 6;
    const assumptions = [
      `Bil koloni: ${fmtNumber(params.colonies, 0)}`,
      `Hasil/koloni: ${fmtNumber(params.honeyYieldPerColony)} kg/tahun`,
      `Harga madu: RM ${fmtRM(params.honeyPrice)} /kg`,
      `Tempoh: ${params.T} tahun`,
      `Kadar diskaun: ${fmtNumber(params.discountRate * 100, 0)}%`,
      `Kontinjensi: ${fmtNumber(params.contingencyRate * 100, 0)}%`,
      `Eskalasi kos: ${fmtNumber(params.costEscalation * 100, 1)}%`,
      `Eskalasi harga: ${fmtNumber(params.priceEscalation * 100, 1)}%`,
      `Mortaliti: ${fmtNumber(params.mortalityRate * 100, 1)}%`
    ];
    assumptions.forEach(item => {
      pdf.text(`- ${item}`, margin, y);
      y += lineHeight;
    });

    pdf.addPage();
    y = 16;
    pdf.setFontSize(14);
    pdf.text("Jadual Aliran Tunai", margin, y);
    y += 6;
    if (inputsIncomplete) {
      pdf.setFontSize(10);
      pdf.text("Nota: Ada input hasil/kos yang belum lengkap. Jadual dipaparkan sebagai 0.00 untuk medan yang tidak lengkap. Sila semak Langkah 1 & 2.", margin, y);
      y += 6;
    }
    const tableHeaders = ["Tahun","Hasil (RM)","Kos (RM)","Aliran Tunai Bersih (RM)","Aliran Tunai Terkumpul (RM)"];
    const colWidths = [16, 32, 28, 50, 50];
    const drawTableHeader = () => {
      pdf.setFontSize(10);
      let x = margin;
      tableHeaders.forEach((h, idx) => {
        pdf.text(h, x, y);
        x += colWidths[idx];
      });
      y += 5;
      pdf.setDrawColor(150);
      pdf.line(margin, y, pageWidth - margin, y);
      y += 3;
    };
    drawTableHeader();

    let cum = 0;
    for (let t = 0; t <= params.T; t++) {
      const cf = numOrZero(sc.cashflows[t]);
      cum += cf;
      const row = [
        t,
        fmtRM(sc.benefits[t]),
        fmtRM(sc.totalCosts[t]),
        fmtRM(cf),
        fmtRM(cum)
      ];
      if (y + 6 > pageHeight - 16) {
        pdf.addPage();
        y = 16;
        pdf.setFontSize(14);
        pdf.text("Jadual Aliran Tunai (Samb.)", margin, y);
        y += 6;
        drawTableHeader();
      }
      pdf.setFontSize(10);
      let x = margin;
      row.forEach((cell, idx) => {
        pdf.text(String(cell), x, y);
        x += colWidths[idx];
      });
      y += 6;
    }
    y += 4;
    pdf.setFontSize(10);
    pdf.text("Jika Aliran Tunai Terkumpul mula positif, itu tanda modal telah kembali.", margin, y);

    pdf.addPage();
    y = 16;
    pdf.setFontSize(14);
    pdf.text("Graf & Sensitiviti", margin, y);
    y += 6;

    const chartWidth = pageWidth - margin * 2;
    const cumCanvas = document.getElementById('cumCfChart');
    if (cumCanvas) {
      const cumImg = cumCanvas.toDataURL("image/png", 1.0);
      const cumHeight = 60;
      pdf.addImage(cumImg, 'PNG', margin, y, chartWidth, cumHeight);
      y += cumHeight + 6;
      pdf.setFontSize(10);
      pdf.text("Graf ini menunjukkan aliran tunai terkumpul sepanjang tempoh projek. Jika garis naik dan kekal positif, modal sudah kembali. Gunakan graf ini untuk melihat bila pulang modal berlaku.", margin, y);
      y += 10;
    }

    const npvCanvas = document.getElementById('npvSensChart');
    if (npvCanvas) {
      const npvImg = npvCanvas.toDataURL("image/png", 1.0);
      const npvHeight = 60;
      pdf.addImage(npvImg, 'PNG', margin, y, chartWidth, npvHeight);
      y += npvHeight + 6;
      pdf.setFontSize(10);
      pdf.text("Graf sensitiviti NPV berbanding harga madu menunjukkan bagaimana keuntungan berubah bila harga naik atau turun. Bar di bawah sifar bermakna NPV negatif. Semakin tinggi bar, semakin selamat projek.", margin, y);
    }

    const pageCount = pdf.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      pdf.setPage(i);
      pdf.setFontSize(9);
      pdf.text(`Halaman ${i}/${pageCount}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
    }

    pdf.save('Laporan_Projek_Madu_Kelulut_ringkas.pdf');
  }

  function downloadProfessionalPDF() {
    const params = buildParams();
    const scenarioParams = { ...params, baseHoneyPrice: params.honeyPrice, baseLabourAnnual: params.labourAnnual, priceFactor: 1 };
    const sc = computeScenario(scenarioParams);
    const baseNPV = sc.npv;
    const irrVal = sc.irr;
    const bcrVal = sc.bcr;
    const totalCosts = sc.totalCosts.reduce((a,b)=>a+b,0);
    const totalBenefits = sc.benefits.reduce((a,b)=>a+b,0);
    const roi = totalCosts > 0 ? ((totalBenefits - totalCosts) / totalCosts) * 100 : null;
    const roiYear1 = sc.totalCosts[1] > 0 ? (sc.cashflows[1] / sc.totalCosts[1]) * 100 : null;
    const paybackText = sc.paybackYear ? `Tahun ke-${sc.paybackYear}` : "Tidak pulang modal dalam tempoh analisis";
    const inputsIncomplete = inputsAreIncomplete(params);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 14;
    const lineHeight = 5;
    const calcVersion = "v2.1";
    let y = 16;

    const ensureSpace = (height = 0) => {
      if (y + height > pageHeight - 12) {
        pdf.addPage();
        y = 16;
      }
    };
    const addSectionTitle = (text) => {
      ensureSpace(10);
      pdf.setFontSize(13);
      pdf.text(text, margin, y);
      y += 7;
    };
    const addParagraph = (text) => {
      pdf.setFontSize(10);
      const lines = pdf.splitTextToSize(text, pageWidth - margin * 2);
      lines.forEach(line => {
        ensureSpace(lineHeight);
        pdf.text(line, margin, y);
        y += lineHeight;
      });
      y += 2;
    };
    const addBullets = (items) => {
      pdf.setFontSize(10);
      items.forEach(item => {
        const lines = pdf.splitTextToSize(`- ${item}`, pageWidth - margin * 2);
        lines.forEach(line => {
          ensureSpace(lineHeight);
          pdf.text(line, margin, y);
          y += lineHeight;
        });
      });
      y += 2;
    };
    const addTable = (headers, rows, colWidths) => {
      const widths = colWidths || headers.map(() => (pageWidth - margin * 2) / headers.length);
      const renderHeader = () => {
        pdf.setFontSize(8);
        headers.forEach((h, idx) => pdf.text(h, margin + widths.slice(0, idx).reduce((a,b)=>a+b,0), y));
        y += 5;
      };
      renderHeader();
      rows.forEach(r => {
        ensureSpace(5);
        if (y > pageHeight - 14) {
          pdf.addPage();
          y = 16;
          renderHeader();
        }
        r.forEach((c, idx) => pdf.text(String(c), margin + widths.slice(0, idx).reduce((a,b)=>a+b,0), y));
        y += 5;
      });
      y += 4;
    };
    const getChartImage = (canvasId) => {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return null;
      const scale = 2;
      const scaled = document.createElement('canvas');
      scaled.width = canvas.width * scale;
      scaled.height = canvas.height * scale;
      const ctx = scaled.getContext('2d');
      ctx.scale(scale, scale);
      ctx.drawImage(canvas, 0, 0);
      return { dataUrl: scaled.toDataURL('image/png', 1.0), width: canvas.width, height: canvas.height };
    };
    const addChartPage = (title, caption, canvasId) => {
      pdf.addPage();
      y = 16;
      addSectionTitle(title);
      const chart = getChartImage(canvasId);
      if (chart) {
        const availableWidth = pageWidth - margin * 2;
        let imgHeight = availableWidth * (chart.height / chart.width);
        if (y + imgHeight > pageHeight - 30) {
          imgHeight = pageHeight - 30 - y;
        }
        pdf.addImage(chart.dataUrl, 'PNG', margin, y, availableWidth, imgHeight);
        y += imgHeight + 4;
      }
      addParagraph(caption);
    };

    const now = new Date();
    const farmerName = document.getElementById('farmerName').value.trim() || '-';
    const villageName = document.getElementById('villageName').value.trim() || '-';
    const generatedAt = `${now.toLocaleDateString('ms-MY')} ${now.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' })}`;
    const breakEvenPrice = computeBreakEvenHoneyPrice(scenarioParams);

    addSectionTitle("Kalkulator Projek Madu Kelulut - Laporan Analisis Kewangan");
    addParagraph(`Nama Penternak: ${farmerName}`);
    addParagraph(`Nama Kampung: ${villageName}`);
    addParagraph(`Tarikh/Masa dijana: ${generatedAt}`);
    addParagraph(`Versi kalkulator: ${calcVersion}`);
    addParagraph("Laporan ini menerangkan anggaran hasil, kos, dan pulangan projek madu kelulut berdasarkan data yang dimasukkan. Ia membantu penternak memahami sama ada projek berbaloi, bila modal kembali, serta bagaimana perubahan harga memberi kesan kepada untung rugi.");

    addSectionTitle("Ringkasan Projek (Tahun 1 & Pulang Modal)");
    addParagraph(`Untung bersih Tahun 1 ialah RM ${fmtRM(sc.cashflows[1] || 0)}. Ini bermaksud lebihan tunai selepas semua kos operasi dan kontinjensi pada tahun pertama.`);
    addParagraph(`Tahun pulang modal: ${paybackText}. Ini menunjukkan tahun bila aliran tunai terkumpul mula positif dan modal awal dianggap kembali.`);
    addParagraph(`Harga madu minimum tak rugi dianggarkan RM ${fmtRM(breakEvenPrice || 0)} / kg. Jika harga pasaran lebih tinggi daripada nilai ini, projek cenderung lebih selamat.`);

    pdf.addPage();
    y = 16;
    addSectionTitle("Ringkasan Metrik Utama");
    addParagraph(`NPV: RM ${fmtRM(baseNPV)} | IRR: ${irrVal !== null ? fmtNumber(irrVal) + ' %' : '-'} | BCR: ${bcrVal !== null ? bcrVal.toFixed(2) : '-'} | ROI keseluruhan: ${roi !== null ? fmtNumber(roi) + ' %' : '-'}`);
    addParagraph("Takrif ringkas (bahasa mudah) + contoh bacaan:");
    addBullets([
      "NPV (Nilai Kini Bersih): Lebihan nilai untung selepas ambil kira nilai duit ikut masa. Semua aliran tunai masa depan dikira pada nilai hari ini. Cara baca: NPV > 0 biasanya berbaloi. Contoh: NPV RM 5,000 bermakna projek ada lebihan sekitar RM 5,000 selepas diskaun.",
      "IRR (Kadar Pulangan Dalaman): Macam kadar untung dalaman projek. Cara baca: jika IRR > kadar diskaun/alternatif simpanan, projek lebih menarik. Contoh: IRR 18% lebih tinggi daripada diskaun 3%.",
      "BCR (Nisbah Faedah-Kos): Setiap RM1 kos beri berapa RM manfaat. Cara baca: BCR > 1 bermakna manfaat lebih tinggi daripada kos. Contoh: BCR 1.30 = RM1 kos -> RM1.30 manfaat.",
      "ROI (Pulangan atas kos): Peratus untung bersih berbanding jumlah kos sepanjang tempoh projek. Cara baca: lagi tinggi, lagi baik. Contoh: kos RM 10,000, untung RM 2,000 -> ROI ~20%.",
      "Tahun pulang modal: Tahun bila modal kembali apabila aliran tunai terkumpul mula positif. Cara baca: lagi awal, lagi cepat modal kembali. Contoh: Tahun pulang modal ke-4.",
      "Harga madu minimum tak rugi: Harga madu minimum supaya projek tidak rugi (NPV ~ 0), selepas ambil kira hasil sampingan. Cara baca: harga pasaran lebih tinggi daripada ini lebih selamat. Contoh: harga minimum RM 120/kg, harga RM 150/kg biasanya ada lebihan."
    ]);
    addParagraph(`Nota andaian ringkas: Hasil madu per koloni ${fmtNumber(params.honeyYieldPerColony)} kg/tahun, harga madu RM ${fmtRM(params.honeyPrice)} /kg, tempoh analisis ${params.T} tahun, kadar diskaun ${fmtNumber(params.discountRate * 100,0)}%, kontinjensi ${fmtNumber(params.contingencyRate * 100,0)}%, eskalasi kos ${fmtNumber(params.costEscalation * 100,1)}%, eskalasi harga ${fmtNumber(params.priceEscalation * 100,1)}%, mortaliti ${fmtNumber(params.mortalityRate * 100,1)}%, kos pembungkusan ${params.enablePackaging ? 'aktif' : 'tidak aktif'}. Kos pembangunan lain-lain Tahun 0: RM ${fmtRM(params.devCostOther0)}. Bahan habis pakai lain-lain setahun: RM ${fmtRM(params.otherOpexAnnual)}.`);

    pdf.addPage();
    y = 16;
    addSectionTitle("Jadual Aliran Tunai");
    if (inputsIncomplete) {
      addParagraph("Nota: Ada input hasil/kos yang belum lengkap. Jadual dipaparkan sebagai 0.00 untuk medan yang tidak lengkap. Sila semak Langkah 1 & 2.");
    }
    addParagraph("Jadual ini menunjukkan hasil, kos, aliran tunai bersih, aliran tunai terkumpul, serta nilai kini aliran tunai bagi setiap tahun. Aliran Tunai Bersih = Hasil - Kos. Jika negatif, bermaksud belanja lebih daripada hasil pada tahun tersebut.");
    const cfRows = [];
    let cum = 0;
    sc.cashflows.forEach((cf, t) => {
      cum += cf;
      const pv = cf / Math.pow(1 + params.discountRate, t);
      cfRows.push([
        t,
        fmtRM(sc.benefits[t]),
        fmtRM(sc.totalCosts[t]),
        fmtRM(cf),
        fmtRM(cum),
        fmtRM(pv)
      ]);
    });
    addTable(["Tahun","Hasil (RM)","Kos (RM)","Aliran Tunai Bersih (RM)","Aliran Tunai Terkumpul (RM)","Nilai Kini Aliran Tunai (RM)"], cfRows, [14, 28, 28, 40, 36, 30]);

    addChartPage(
      "Graf Aliran Tunai Tahunan",
      "Graf ini memaparkan aliran tunai bersih setiap tahun. Nilai di atas sifar bermaksud lebihan tunai, manakala nilai negatif menandakan kos melebihi hasil. Lihat tahun-tahun awal untuk menilai beban modal dan kos operasi.",
      "cfChart"
    );
    addChartPage(
      "Graf Aliran Tunai Terkumpul",
      "Graf aliran tunai terkumpul menunjukkan jumlah keseluruhan aliran tunai dari tahun ke tahun. Titik graf melintasi sifar ialah tanda projek pulang modal. Lebih cepat graf naik melebihi sifar, lebih cepat modal kembali.",
      "cumCfChart"
    );
    addChartPage(
      "Graf Sensitiviti NPV Harga Madu",
      "Graf bar ini menunjukkan perubahan NPV apabila harga madu naik atau turun. Bar di bawah sifar bermaksud projek berisiko pada harga tersebut. Ia membantu melihat sejauh mana projek sensitif kepada harga pasaran.",
      "npvSensChart"
    );
    addChartPage(
      "Graf Sensitiviti Pelbagai Faktor (Corong)",
      "Graf corong membandingkan faktor-faktor utama yang memberi kesan besar kepada NPV. Semakin panjang bar, semakin sensitif projek kepada faktor tersebut. Ini membantu penternak fokus kepada faktor yang paling mempengaruhi keuntungan.",
      "tornadoChart"
    );

    pdf.addPage();
    y = 16;
    addSectionTitle("Sensitiviti Harga Madu");
    addParagraph("Jadual ini menunjukkan kesan perubahan harga madu terhadap NPV, IRR, BCR dan tahun pulang modal. Ia membantu menilai risiko jika harga pasaran turun.");
    const priceFactors = [0.8, 0.9, 1.0, 1.1, 1.2];
    const sensRows = priceFactors.map(f => {
      const scPrice = computeScenario({ ...scenarioParams, priceFactor: f });
      const payback = scPrice.paybackYear ? `Tahun ${scPrice.paybackYear}` : "Tiada";
      return [
        `${(f * 100).toFixed(0)}%`,
        fmtRM(params.honeyPrice * f),
        fmtRM(scPrice.npv),
        scPrice.irr !== null ? fmtNumber(scPrice.irr) : "-",
        scPrice.bcr !== null ? scPrice.bcr.toFixed(2) : "-",
        payback
      ];
    });
    addTable(["Faktor Harga","Harga (RM/kg)","NPV (RM)","IRR (%)","BCR","Tahun pulang modal"], sensRows, [24, 26, 26, 18, 14, 22]);
    const lowScenario = computeScenario({ ...scenarioParams, priceFactor: 0.8 });
    addParagraph(`Contoh bacaan: Jika harga turun 20%, NPV menjadi RM ${fmtRM(lowScenario.npv)} dan tahun pulang modal ${lowScenario.paybackYear ? 'Tahun ' + lowScenario.paybackYear : 'tiada dalam tempoh analisis'}. Ini menunjukkan tahap sensitiviti projek terhadap turun naik harga.`);

    pdf.addPage();
    y = 16;
    addSectionTitle("Rumusan & Cadangan Praktikal");
    addParagraph("Secara keseluruhan, laporan ini memberikan gambaran sama ada projek madu kelulut berpotensi menguntungkan berdasarkan data semasa. Gunakan hasil ini sebagai panduan awal sebelum membuat keputusan pelaburan yang lebih besar.");
    addParagraph("Cadangan praktikal untuk dipertimbangkan:");
    addBullets([
      "Kurangkan kos bahan habis pakai dan kos tenaga kerja melalui pembelian secara pukal atau kerjasama komuniti.",
      "Tingkatkan hasil per koloni melalui pengurusan koloni yang konsisten dan amalan penternakan baik.",
      "Gunakan pendekatan konservatif: sediakan tetapan harga rendah dan hasil rendah sebelum melabur.",
      "Semak semula harga jualan dan strategi pemasaran agar nilai jualan kekal stabil."
    ]);

    const pageCount = pdf.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      pdf.setPage(i);
      pdf.setFontSize(8);
      pdf.text(`Halaman ${i} / ${pageCount}`, pageWidth - margin * 2, 290);
    }

    pdf.save('Laporan_Projek_Madu_Kelulut_profesional.pdf');
  }

  function setupAccordion() {
    const steps = Array.from(document.querySelectorAll('.step'));
    steps.forEach(step => {
      step.addEventListener('toggle', () => {
        if (!step.open) return;
        steps.forEach(other => {
          if (other !== step) other.open = false;
        });
      });

      const sections = Array.from(step.querySelectorAll('.section'));
      sections.forEach(section => {
        section.addEventListener('toggle', () => {
          if (!section.open) return;
          sections.forEach(other => {
            if (other !== section) other.open = false;
          });
        });
      });
    });

    document.querySelectorAll('.btn-next').forEach(button => {
      button.addEventListener('click', () => {
        const nextId = button.getAttribute('data-next-step');
        const currentStep = button.closest('.step');
        const nextStep = nextId ? document.getElementById(nextId) : null;
        if (currentStep) currentStep.open = false;
        if (nextStep) {
          nextStep.open = true;
          nextStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });
  }

  function setGuideVisibility(show) {
    const guide = document.getElementById('guideSection');
    const link = document.getElementById('guideLink');
    if (!guide || !link) return;
    guide.style.display = show ? 'block' : 'none';
    link.style.display = show ? 'none' : 'block';
    if (show) {
      localStorage.removeItem('kelulut_hide_guide');
    } else {
      localStorage.setItem('kelulut_hide_guide', '1');
    }
  }

  function setupGuideToggle() {
    const hideBtn = document.getElementById('hideGuideBtn');
    const showLink = document.getElementById('showGuideLink');
    if (hideBtn) {
      hideBtn.addEventListener('click', () => setGuideVisibility(false));
    }
    if (showLink) {
      showLink.addEventListener('click', (event) => {
        event.preventDefault();
        setGuideVisibility(true);
        const guide = document.getElementById('guideSection');
        if (guide) guide.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    }
    const isHidden = localStorage.getItem('kelulut_hide_guide') === '1';
    setGuideVisibility(!isHidden);
  }

  function setupListeners() {
    document.getElementById('btnRun').addEventListener('click', runAnalysis);
    document.getElementById('btnReset').addEventListener('click', () => { applyDefaults(); clearResults(); saveState(); updateColonyEstimate(); setStatusMessage('Semua medan telah ditetapkan semula ke nilai asal.'); });
    document.getElementById('btnDemo').addEventListener('click', () => { applyDemo(); setStatusMessage('Contoh dimasukkan.'); });
    document.getElementById('btnSave').addEventListener('click', () => { saveState(); setStatusMessage('Data berjaya disimpan di pelayar.'); });
    document.getElementById('btnClearSave').addEventListener('click', () => { localStorage.removeItem(storageKey); applyDefaults(); setStatusMessage('Simpanan dibersihkan.'); });
    const targetBtn = document.getElementById('btnTargetMonthly');
    if (targetBtn) targetBtn.addEventListener('click', estimateTargetMonthlyColonies);

    ['modeSimple','modeDetailed','areaAcre','density'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', () => { updateColonyEstimate(); saveStateDebounced(); validateInputs(); updateQuickPreview(); });
    });

    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', () => { if (el.id) setError(el.id, ''); saveStateDebounced(); updateQuickPreview(); });
      if (el.type === 'radio') el.addEventListener('change', () => { saveStateDebounced(); updateQuickPreview(); toggleOptionalSections(); });
    });

    document.getElementById('enablePackaging').addEventListener('change', () => { toggleOptionalSections(); saveStateDebounced(); updateQuickPreview(); });
    document.getElementById('enableTransport').addEventListener('change', () => { toggleOptionalSections(); saveStateDebounced(); updateQuickPreview(); });
    document.getElementById('enableFeeding').addEventListener('change', () => { toggleOptionalSections(); saveStateDebounced(); updateQuickPreview(); });
    document.getElementById('enableCompliance').addEventListener('change', () => { toggleOptionalSections(); saveStateDebounced(); updateQuickPreview(); });
    document.getElementById('enableYear1LowerYield').addEventListener('change', () => { saveStateDebounced(); updateQuickPreview(); });
    document.getElementById('enableExpansion').addEventListener('change', () => { saveStateDebounced(); updateQuickPreview(); });
    document.querySelectorAll('input[name="mode"]').forEach(el => el.addEventListener('change', toggleModeUI));
    document.querySelectorAll('input[name="transportMode"]').forEach(el => el.addEventListener('change', () => { toggleOptionalSections(); saveStateDebounced(); }));
    document.querySelectorAll('input[name="expansionMode"]').forEach(el => el.addEventListener('change', () => { saveStateDebounced(); }));
  }

  window.onload = () => {
    applyDefaults();
    loadState();
    toggleModeUI();
    toggleOptionalSections();
    updateColonyEstimate();
    clearErrors();
    setupListeners();
    setupAccordion();
    setupGuideToggle();
    updateQuickPreview();
  };
</script>
</body>
</html>
